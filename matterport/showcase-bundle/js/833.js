/*! For license information please see 833.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[833],{1089:(e,t,i)=>{"use strict";e.exports=i.p+"images/scope.svg"},3220:(e,t,i)=>{"use strict";e.exports=i.p+"images/surface_grid_planar_256.png"},57721:(e,t,i)=>{"use strict";e.exports=i.p+"images/vert_arrows.png"},27273:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic1024.png"},15278:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic2048.png"},92787:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic4096.png"},67929:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic512.png"},53896:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced1024.png"},38343:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced2048.png"},73965:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced4096.png"},33967:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced512.png"},29480:e=>{"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAP1BMVEUAAAD///////////////////////////////////////////////////////////////////////////////9Du/pqAAAAFXRSTlMAmYWNk1l7bCJCEQpjKHQ0GE9HHToMZFdDAAAHfklEQVR42uzcC3LcIAwAUAnxMT//73/WTmcnnWw7za6xMMLJO0HsCEkI1vDjx49rhbz7xaTRKkWkETWRUnZMZvF7DnBjIa9pVPiCGtN6v/cw72YkPIBGs89wD8PqCIuQWwfoW/BO4yna+W7XQzYKWSiToTvZEDKivt7BZgjZkdmgC9FbrMT6CNINSWNFOsmuC5PF6uwEUnmFl1AeBIoL4WVoEZcMFsJL0QKSrISXoxWk2AmboB0kGCw2Y9sXxZCwqRSgqVVjY3qFdjaLAtgNGllQiAVaGBSKoRokQ9989X+mPVwrOhTGRfjSfcP/rWVw6/B/vQxuH/6vlsH9w//LZfAtwv+6ZWBQOANVJRQvQUVi099nDmqJIvY+r9kIVQTB6f+ZClDB3M3zI6oZ2A2EHaEBmGXR5f9fOgOrobPnR9QDMJq7iv8Hmr9j/q9TC2KXz4+oIvCwWIUmZUfnRqtIYxVWZv+rnPE5RHgSQ/bGKUQU1xUn5GPNtMGXtslYWTsjg0yUmSK8JU5Gidkde+Sg3RTgkDA5jRy8gAbI+lh43ax5Q8RQANUyQ7F5UW2LocOTxgwn5bFhKVjxHDcAg8HhOWujBJA2YLIl9jRQPwGkGRjNqUEacKIu7wz26jTgsRh5qMDTpd3AoMVdXArpyjSgsJDKUE0u/6vgoEXo0ZS56B7RhmVogsomwjLbFTMQO0N1s71gOrKKDP8PpnpDGDQW0BNcZCr7+wK8K8k4jOE+pkrwpkHKcRz3QeUA77FiDmT/L6h6eXDH48YIF4sjHrfDO0jSpQzezRrBG9ZOnr/oDaxVAmCERsYaIbCUjBsaiYp/SxBJev4/VwsocgcAzdDQTNwhQNcMHNtdXSHmOVjzn3JPvNMxJXP/x7k3VJyv04IAljFobU8J8MNMbP+1obcE8DCxbQpTdwngwTDNBaI+mE3EUHiEjjw1UNCnjTJPJbRyfplR9yaX5TgLIFHfOAuER2wMqUTYp2w8Q/qm7lqg4vVL5xNJ+493/GU4ncBNtxmwIA+asytARA/8bD65BnLnAXAwBPK5FSDy04bbuTWg5I/BX3Fn+vjQdQkoKAQBnvkezgFeGU80cq7PXdCzfGIZ6y63wScSmYYng/jvNr1lKU5ka99N0Ie5+JzUdbwN+syWJgHqdh9cXMyoMHS0uO+5fhZ12VLeu+8CP7iy+zKmu7MAhjMCU9ZCiRoF/iuUNbR0hy7oQZVkwdDhadD/mJJgzrdJAYeSQC7pA0UXwd9iSS+Y7tEGPtiCwd54nxQAYArKgLpPCgCYCipa59PQ4tloQRWEDiAerYMZb9MGHVvQGR52vMlO6MEd3g55vFEROFIGPDwseIthyPGhyPLnlXU/EP/F3pkjAQzCMBDGDBXh/8/NpMmQUunslZ/gHPiQljMu+YVevUgvrB5q6y0Ey3QCWjewz3OjTBkgFAJTTcBoKWIIZY2WgGgpItQERKlC8McDjULTgCemmoCRXhjwja3+03qpVkBpBpwAfwL+CfoYdCHkUrjNDm+G8O0wfiCCH4nhh6L4sTh+MYJfjeGXo/j1uAUSeIkMXiSFl8nhhZJ4qSxeLG25PN4wgbfM4E1TeNucjZN46yzePI23zxuggEdo4CEqeIyOQUp4lBYepmacHh6oiEdqGqqKx+riwcpGa+Ph6ni8vi9YwF+xcbN3pzkOwjAUgJ9DFrLQQLn/XUfzZzSbWjBOa5bvBBEimx3pXSErp4/ZuYKWTh+1dYWtnT5u7/SBi1fk5hW6evrY3St4+fTR21f4+unj95EsMdiKF6m88SV8WboV6rwbOmK5YwVPLH5EcyN3bCtbzTxdRWO1I5559XsrldPAEdPEqDTzmAHNDPxRcSoNXCWhiVSIgV23icTWRTQQO2KLYAjE53sI6z3xBXa5ga+MEDQW2sBkdsFxizJDyFyIQaBwG2mb0ENAH2ibCLZAG90GbDTcaKMgUXXkM9MItnESGEAW6jvw+ZjBkKMnBuHOTSQJNtSEVVINliRE4cM3n3E1Y5FcnSEhDpsVkuNdnfHQXJ0nOQUCAskywcUhZfyQ0xBdMCQrQISnJmxn/C2EmzedpSa8XAtul+SalmmXX0CyVTF2tDt/Hy68/UC0nIID0G/Dzr6AHfDp7c0YCVraVOOOVsKfjcrz7QWtWtXZ0y74jP9oPBV/UXj+/V8h9Qr+UNGaekbR/fexqPpAYCOa6xVvBqbHC2S1S2HIeI27ymlg73jg+NPgye9/+Gmw4Pc/8m6wbPU/7jQwPd5hIiUmvMms4nbkZ6xxtA2Ru/kpeLj0nboHWYzHO2yqniJ9tHN3OwiDMBSA1x7KxgQU5P2f1QtvTIxubox1Zt8btOEnJOUsUkC7QOm0yKDmkDtNEqgpqIt1vLRsAZLKbFvH1AQri/B5cbW0Obv7h/WvBm9oQ8bruPimhrs2Yp3Krf/uLqDqICpjHD8JgrrVK4ptmisIUxV8xOqfRtebtSOWbv/nzjpD7kGLoM/6z/x5bkUi6AeIUlSkNNU0huwj0wSOPoejr/qJPhSXxEfLDBgiAzDb6CW58t+Vn04aPQDVw5SJCNPsmgAAAABJRU5ErkJggg=="},33757:(e,t,i)=>{"use strict";e.exports=i.p+"images/selected_sweep_glow.png"},82582:function(e){e.exports=function(){"use strict";function e(e,s,n,a,r){!function e(i,s,n,a,r){for(;a>n;){if(a-n>600){var o=a-n+1,h=s-n+1,l=Math.log(o),d=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*d*(o-d)/o)*(h-o/2<0?-1:1);e(i,s,Math.max(n,Math.floor(s-h*d/o+c)),Math.min(a,Math.floor(s+(o-h)*d/o+c)),r)}var u=i[s],p=n,g=a;for(t(i,n,s),r(i[a],u)>0&&t(i,n,a);p<g;){for(t(i,p,g),p++,g--;r(i[p],u)<0;)p++;for(;r(i[g],u)>0;)g--}0===r(i[n],u)?t(i,n,g):t(i,++g,a),g<=s&&(n=g+1),s<=g&&(a=g-1)}}(e,s,n||0,a||e.length-1,r||i)}function t(e,t,i){var s=e[t];e[t]=e[i],e[i]=s}function i(e,t){return e<t?-1:e>t?1:0}var s=function(e){void 0===e&&(e=9),this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function n(e,t,i){if(!i)return t.indexOf(e);for(var s=0;s<t.length;s++)if(i(e,t[s]))return s;return-1}function a(e,t){r(e,0,e.children.length,t,e)}function r(e,t,i,s,n){n||(n=g(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var a=t;a<i;a++){var r=e.children[a];o(n,e.leaf?s(r):r)}return n}function o(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function h(e,t){return e.minX-t.minX}function l(e,t){return e.minY-t.minY}function d(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function c(e){return e.maxX-e.minX+(e.maxY-e.minY)}function u(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function p(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(t,i,s,n,a){for(var r=[i,s];r.length;)if(!((s=r.pop())-(i=r.pop())<=n)){var o=i+Math.ceil((s-i)/n/2)*n;e(t,o,i,s,a),r.push(i,o,o,s)}}return s.prototype.all=function(){return this._all(this.data,[])},s.prototype.search=function(e){var t=this.data,i=[];if(!p(e,t))return i;for(var s=this.toBBox,n=[];t;){for(var a=0;a<t.children.length;a++){var r=t.children[a],o=t.leaf?s(r):r;p(e,o)&&(t.leaf?i.push(r):u(e,o)?this._all(r,i):n.push(r))}t=n.pop()}return i},s.prototype.collides=function(e){var t=this.data;if(!p(e,t))return!1;for(var i=[];t;){for(var s=0;s<t.children.length;s++){var n=t.children[s],a=t.leaf?this.toBBox(n):n;if(p(e,a)){if(t.leaf||u(e,a))return!0;i.push(n)}}t=i.pop()}return!1},s.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0;t<e.length;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var s=this.data;this.data=i,i=s}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},s.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},s.prototype.clear=function(){return this.data=g([]),this},s.prototype.remove=function(e,t){if(!e)return this;for(var i,s,a,r=this.data,o=this.toBBox(e),h=[],l=[];r||h.length;){if(r||(r=h.pop(),s=h[h.length-1],i=l.pop(),a=!0),r.leaf){var d=n(e,r.children,t);if(-1!==d)return r.children.splice(d,1),h.push(r),this._condense(h),this}a||r.leaf||!u(r,o)?s?(i++,r=s.children[i],a=!1):r=null:(h.push(r),l.push(i),i=0,s=r,r=r.children[0])}return this},s.prototype.toBBox=function(e){return e},s.prototype.compareMinX=function(e,t){return e.minX-t.minX},s.prototype.compareMinY=function(e,t){return e.minY-t.minY},s.prototype.toJSON=function(){return this.data},s.prototype.fromJSON=function(e){return this.data=e,this},s.prototype._all=function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},s.prototype._build=function(e,t,i,s){var n,r=i-t+1,o=this._maxEntries;if(r<=o)return a(n=g(e.slice(t,i+1)),this.toBBox),n;s||(s=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,s-1))),(n=g([])).leaf=!1,n.height=s;var h=Math.ceil(r/o),l=h*Math.ceil(Math.sqrt(o));m(e,t,i,l,this.compareMinX);for(var d=t;d<=i;d+=l){var c=Math.min(d+l-1,i);m(e,d,c,h,this.compareMinY);for(var u=d;u<=c;u+=h){var p=Math.min(u+h-1,c);n.children.push(this._build(e,u,p,s-1))}}return a(n,this.toBBox),n},s.prototype._chooseSubtree=function(e,t,i,s){for(;s.push(t),!t.leaf&&s.length-1!==i;){for(var n=1/0,a=1/0,r=void 0,o=0;o<t.children.length;o++){var h=t.children[o],l=d(h),c=(u=e,p=h,(Math.max(p.maxX,u.maxX)-Math.min(p.minX,u.minX))*(Math.max(p.maxY,u.maxY)-Math.min(p.minY,u.minY))-l);c<a?(a=c,n=l<n?l:n,r=h):c===a&&l<n&&(n=l,r=h)}t=r||t.children[0]}var u,p;return t},s.prototype._insert=function(e,t,i){var s=i?e:this.toBBox(e),n=[],a=this._chooseSubtree(s,this.data,t,n);for(a.children.push(e),o(a,s);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(s,n,t)},s.prototype._split=function(e,t){var i=e[t],s=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,s);var r=this._chooseSplitIndex(i,n,s),o=g(i.children.splice(r,i.children.length-r));o.height=i.height,o.leaf=i.leaf,a(i,this.toBBox),a(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(i,o)},s.prototype._splitRoot=function(e,t){this.data=g([e,t]),this.data.height=e.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},s.prototype._chooseSplitIndex=function(e,t,i){for(var s,n,a,o,h,l,c,u=1/0,p=1/0,g=t;g<=i-t;g++){var m=r(e,0,g,this.toBBox),y=r(e,g,i,this.toBBox),w=(n=m,a=y,o=void 0,h=void 0,l=void 0,c=void 0,o=Math.max(n.minX,a.minX),h=Math.max(n.minY,a.minY),l=Math.min(n.maxX,a.maxX),c=Math.min(n.maxY,a.maxY),Math.max(0,l-o)*Math.max(0,c-h)),f=d(m)+d(y);w<u?(u=w,s=g,p=f<p?f:p):w===u&&f<p&&(p=f,s=g)}return s||i-t},s.prototype._chooseSplitAxis=function(e,t,i){var s=e.leaf?this.compareMinX:h,n=e.leaf?this.compareMinY:l;this._allDistMargin(e,t,i,s)<this._allDistMargin(e,t,i,n)&&e.children.sort(s)},s.prototype._allDistMargin=function(e,t,i,s){e.children.sort(s);for(var n=this.toBBox,a=r(e,0,t,n),h=r(e,i-t,i,n),l=c(a)+c(h),d=t;d<i-t;d++){var u=e.children[d];o(a,e.leaf?n(u):u),l+=c(a)}for(var p=i-t-1;p>=t;p--){var g=e.children[p];o(h,e.leaf?n(g):g),l+=c(h)}return l},s.prototype._adjustParentBBoxes=function(e,t,i){for(var s=i;s>=0;s--)o(t[s],e)},s.prototype._condense=function(e){for(var t=e.length-1,i=void 0;t>=0;t--)0===e[t].children.length?t>0?(i=e[t-1].children).splice(i.indexOf(e[t]),1):this.clear():a(e[t],this.toBBox)},s}()},48603:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>r});var s=i(97542),n=i(57956),a=i(51524);class r extends s.Y{constructor(){super(...arguments),this.name="automation-support"}async init(e,t){const i=window;if(i.MP_AUTOMATION)this.addAutomationHooks(t,i.MP_AUTOMATION);else{const e=performance.now(),s=setInterval((()=>{i.MP_AUTOMATION?(this.addAutomationHooks(t,i.MP_AUTOMATION),clearInterval(s)):performance.now()-e>5e3&&clearInterval(s)}),100)}}async addAutomationHooks(e,t){const i=await e.getModuleBySymbol(n.y.WEBGL_RENDERER);t.estimatedGPUMemoryAllocated=()=>i.estimatedGPUMemoryAllocated(),t.maxLOD=()=>a.t.maxLOD}}},38319:(e,t,i)=>{"use strict";i.d(t,{lb:()=>n,hf:()=>a});var s=i(50575);const n=(e=200)=>({resizeDimensions:[{property:s.P.width,setDimension:e=>e.width,duration:e},{property:s.P.height,setDimension:e=>e.height,duration:e},{property:s.P.top,setDimension:()=>0,duration:e},{property:s.P.left,setDimension:()=>0,duration:e}]}),a=(e,t,i,n=200)=>{const a=[];return void 0!==e&&a.push({property:s.P.width,setDimension:t=>t.width+e,duration:n}),void 0!==t&&a.push({property:s.P.height,setDimension:e=>e.height+t,duration:n}),void 0!==i&&a.push({property:s.P.left,setDimension:()=>i,duration:n}),{resizeDimensions:a}}},13310:(e,t,i)=>{"use strict";i.d(t,{Y:()=>a});var s=i(89557),n=i(67992);class a extends n.V{constructor(){super(),this.name="cursor",this.opacity=new s.z(0),this.texture=null}}},85042:(e,t,i)=>{"use strict";var s;i.d(t,{L:()=>s}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(s||(s={}))},65792:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var s=i(97542),n=i(57956),a=i(25985),r=i(54244),o=i(23254),h=i(95882),l=i(95912),d=i(80361),c=i(9133),u=i(2569),p=i(59296);function g(e){const t=(0,p.J5)(u.ep.toVisionQuaternion(e.rotation));return{position:(0,p.m)(u.ep.toVisionVector(e.position)),rotation:t,aspect:e.aspect(),isOrtho:e.isOrtho(),fovX:e.fovX(),fovY:e.fovY()}}function m(e){return(0,c.U)(new Date(e))}class y extends s.Y{constructor(){super(...arguments),this.name="dwell-analytics",this.pendingDwellEvents=[],this.onCameraChange=(0,l.P)((e=>{this.checkForDwellEvent(),e.clone(this.currentEvent.pose),this.currentEvent.startTimeMs=Date.now(),this.scheduleDwellTimeOutEvent()}),1e3),this.checkForDwellEvent=(e=!1)=>{const{startTimeMs:t,viewmode:i}=this.currentEvent;if(!t||this.appData.phase!==r.nh.PLAYING)return;const s=Date.now(),n=s-t,a={pose:g(this.currentEvent.pose),durationMs:n,startTime:m(t),endTime:m(s),timedOut:e,viewmode:i};this.trackDwellEvent(a)},this.onViewmodeUpdate=e=>{e.value!==h.Ey.Transition&&(this.currentEvent.viewmode=(0,h.Ae)(e.value))},this.trackDwellEvent=e=>{this.pendingDwellEvents.push(e),this.trackPendingDwellEvents()},this.trackPendingDwellEvents=(0,l.P)((()=>{const e={events:JSON.stringify(this.pendingDwellEvents)};this.pendingDwellEvents=[],this.analytics.track("dwell_events",e)}),5e3),this.onBlur=()=>this.stopTrackingDwellTime(!1),this.stopTrackingDwellTime=(e=!1)=>{this.checkForDwellEvent(e),delete this.currentEvent.startTimeMs},this.resumeTrackingDwellTime=()=>{this.currentEvent.startTimeMs||(this.currentEvent.startTimeMs=Date.now()),this.scheduleDwellTimeOutEvent()},this.throttledResumeTrackingDwellTime=(0,l.P)(this.resumeTrackingDwellTime,100),this.scheduleDwellTimeOutEvent=(0,d.D)((()=>this.stopTrackingDwellTime(!0)),15e3)}async init(e,t){[this.analytics,this.cameraData,this.appData,this.viewmodeData]=await Promise.all([t.getModuleBySymbol(n.y.ANALYTICS),t.market.waitForData(a.M),t.market.waitForData(r.pu),t.market.waitForData(o.O)]),this.currentEvent={pose:this.cameraData.pose.clone(),viewmode:(0,h.Ae)(null)},this.bindings.push(this.cameraData.pose.onChanged(this.onCameraChange)),this.bindings.push(this.viewmodeData.onPropertyChanged("currentModeObservable",this.onViewmodeUpdate)),window.addEventListener("blur",this.onBlur),window.addEventListener("focus",this.resumeTrackingDwellTime),window.addEventListener("keydown",this.resumeTrackingDwellTime),window.addEventListener("touchcancel",this.resumeTrackingDwellTime),window.addEventListener("touchstart",this.resumeTrackingDwellTime),window.addEventListener("touchend",this.resumeTrackingDwellTime),window.addEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.addEventListener("mousemove",this.throttledResumeTrackingDwellTime)}dispose(e){super.dispose(e),window.removeEventListener("blur",this.onBlur),window.removeEventListener("focus",this.resumeTrackingDwellTime),window.removeEventListener("keydown",this.resumeTrackingDwellTime),window.removeEventListener("touchcancel",this.resumeTrackingDwellTime),window.removeEventListener("touchstart",this.resumeTrackingDwellTime),window.removeEventListener("touchend",this.resumeTrackingDwellTime),window.removeEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.removeEventListener("mousemove",this.throttledResumeTrackingDwellTime)}}},51728:(e,t,i)=>{"use strict";i.d(t,{U:()=>s});const s=Object.freeze({pink:"#f78da7",plum:"#9c4b92",purple:"#673ab7",teal:"#03687d",cerulean:"#03a9f4",ocean:"#00bcd4",fog:"#abb8c3",iron:"#607d8b",forest:"#417505",emerald:"#51a868",mint:"#37d67a",lime:"#cddc39",canary:"#fbcd00",sunflower:"#ffac17",tangerine:"#ff6900",sunset:"#f44336",sierra:"#d44441",magenta:"#e91e63"})},86034:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>N});var s=i(97542),n=i(57956),a=i(79728),r=i(45905),o=i(90632),h=i(635),l=i(85979),d=i(64567),c=i(71954),u=i(2541),p=i(34361),g=i(17788),m=i(97998),y=i(75287),w=i(84428);class f extends y.T{constructor(){super(...arguments),this.position=new w.Vector3,this.floorId="",this.sid="",this.layerId="",this.text="",this.visible=!1,this.roomId=void 0,this.created=new Date,this.modified=new Date,this.version="3.1"}copy(e){return this.floorId=e.floorId,this.sid=e.sid,this.text=e.text,this.visible=e.visible,this.roomId=e.roomId,this.created=e.created,this.modified=e.modified,this.position.copy(e.position),this.version=e.version,this.commit(),this}}var v=i(40731),b=i(2569);const T=new m.Z("mds-label-serialize");class S{constructor(){this.validate=e=>{if(!e)return!1;const t=["enabled","floorId","label","position"].filter((t=>!(t in e))),i=0===t.length,s=!!e.floorId&&"string"==typeof e.floorId,n=!!e.position&&(0,v.u)(e.position),a=i&&s&&n;return a||T.debug("Label invalid:",{missingFields:t,validPosition:n}),a}}serialize(e){const t=P(e);return this.validate(t)?t:null}}class D{constructor(){this.validate=e=>{if(!e)return!1;const t=["enabled","label","position","floorId","roomId"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e){const t=P(e);return t&&this.validate(t)?t:null}}const P=e=>{const t={};return void 0!==e.visible&&(t.enabled=e.visible),void 0!==e.text&&(t.label=e.text),void 0!==e.position&&(0,v.u)(e.position)&&(t.position=b.ep.toVisionVector(e.position)),void 0!==e.floorId&&""!==e.floorId&&(t.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(t.roomId=e.roomId),Object.keys(t).length>0?t:null};var I=i(9133);const x=new m.Z("mds-label-deserializer");class M{constructor(){this.validate=e=>{if(!e)return!1;const t=["id","created","modified","enabled","floor","label","position"].filter((t=>!(t in e))),i=0===t.length,s=!(!e.floor||!e.floor.id),n=!!e.position&&(0,v.u)(e.position);return i&&s&&n||x.debug("Label invalid:",{missingFields:t,validFloor:s,validPosition:n}),i&&s&&n}}deserialize(e){var t;if(!e||!this.validate(e))return x.debug("Deserialized invalid Label data from MDS",e),null;const i=new f;return i.sid=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,i.text=e.label,i.visible=!!e.enabled,i.created=(0,I.p)(e.created),i.modified=(0,I.p)(e.modified),i.position=b.ep.fromVisionVector(e.position),e.room&&e.room.id&&(i.roomId=e.room.id),i}}var E=i(61341),C=i(29474),R=i(90778);const A=new m.Z("MdsLabelStore");class L extends g.u{constructor(e){super(e),this.prefetchKey="data.model.labels",this.deserializer=new M,this.updateSerializer=new D,this.createSerializer=new S}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,includeLayers:!!g.u.currentLayerId};return this.query(E.GetLabels,i,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.labels;if(!s||!Array.isArray(s))return null;const n=[];for(const e of s){const t=this.deserializer.deserialize(e);t&&n.push(t)}return n.reduce(((e,t)=>(e[t.sid]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const s of e){const e=this.createSerializer.serialize(s);if(!e)throw A.error("Failure saving label:",s.sid,s),new Error("Could not save Label");const n={modelId:t,labelId:s.sid,data:e,includeLayers:!!g.u.currentLayerId};await this.mutate(this.addLayerId(E.AddLabel,s.layerId),n).then((e=>{var t;const n=null===(t=e.data)||void 0===t?void 0:t.addLabel;if(!n)throw new Error("Could not save label: empty response");const a=(new f).copy(s);a.sid=n.id,a.commit(),A.debug(Object.assign({type:"addLabel"},e)),i.push(a)}))}return i}async update(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";const s={};s.modelId=t,s.includeLayers=!!g.u.currentLayerId;let n="";for(const a of e){const e=a.sid,r=this.updateSerializer.serialize(a);if(!r)throw A.error("Failure updating label:",e,a),new Error("Could not update Label");i+=`, $patch${e}: LabelPatch!`,s[`patch${e}`]=r,this.shouldWriteLayerId()&&(n+=`layer${e}: patchLayer(id: "${t}", layerId: "${a.layerId}", writable: true) { id }`),n+=`patch${e}:\n        patchLabel(modelId: $modelId, labelId: "${e}", patch: $patch${e}) {\n          ...LabelDetails\n        }\n      `}this.shouldWriteLayerId()&&(n+=`layerRestore: patchLayer(id: "${t}", layerId: "${g.u.currentLayerId}", writable: true) { id }`);const a=C.Ps`
      mutation labelUpdate($modelId: ID! ${i}, $includeLayers: Boolean!) {
        ${n}
      }

      ${(0,R.S)(E.LabelDetails)}
    `;return this.mutate(a,s).then((e=>{A.debug(Object.assign({type:"patchLabel"},e))}))}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const s of e){if(!s||s&&!s.sid)throw A.error("Failure deleting label:",s),new Error("Could not update Label");this.shouldWriteLayerId()&&(i+=`layer${s.sid}: patchLayer(id: "${t}", layerId: "${s.layerId}", writable: true) { id }`),i+=`delete${s.sid}: deleteLabel(modelId: $modelId, labelId: "${s.sid}") `}this.shouldWriteLayerId()&&(i+=`layerRestore: patchLayer(id: "${t}", layerId: "${g.u.currentLayerId}", writable: true) { id }`);const s=C.Ps`
      mutation batchDeleteLabel($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:t}).then((()=>{}))}}var O=i(59279),F=i(79232),k=i(33824),B=i(80742);class N extends s.Y{constructor(){super(...arguments),this.name="label-data",this.monitor=null}async init(e,t){const{readonly:i}=e;this.config=e,this.engine=t,this.market=t.market,this.store=new L({readonly:e.readonly,includeDisabled:!e.readonly,baseUrl:e.baseUrl});const s=await this.store.read()||{},h=await t.getModuleBySymbol(n.y.STORAGE),l=await t.getModuleBySymbol(n.y.MESH_QUERY);for(const e of Object.values(s))l.inferMeshIdsFromPoint(e,e.position);if(this.labelData=t.market.tryGetData(p.D)||new p.D(s),this.layerData=await t.market.waitForData(B.R),this.store.onNewData((async e=>{var t;e&&(this.layerData.replaceBackendLayers(this.labelData.getCollection(),e),null===(t=this.monitor)||void 0===t||t.clearDiffRecord())})),await this.store.refresh(),this.market.register(this,p.D,this.labelData),!i){this.monitor=new d.c(this.labelData.getCollection(),{aggregationType:u.E.Manual,shallow:!0},this.engine),this.bindings.push(h.onSave((()=>this.saveDiff()),{dataType:a.g.LABELS}),h.onPublish((()=>this.onAfterPublish()),{dataType:a.g.LABELS,phase:r.Q.AFTER}));const e=await t.market.waitForData(o.Q);e.setRevertableType(a.g.LABELS),e.setPublishableType(a.g.LABELS),this.configureTrash()}}dispose(e){this.store.dispose(),super.dispose(e)}async save(){return this.engine.commandBinder.issueCommand(new h.VQ({dataTypes:[a.g.LABELS]}))}getDiffRecord(){var e;return(null===(e=this.monitor)||void 0===e?void 0:e.getDiffRecord())||[]}async saveDiff(){if(!this.store||!this.monitor)return void this.log.warn("Labels changes will NOT be saved");this.monitor.commitChanges();const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.labelData.getLabel(e.index))||void 0===t?void 0:t.layerId);return Object.assign(Object.assign({},e),{layerId:i})})).filter((e=>!this.layerData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===c.KI.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),s=t.filter((e=>e.action===c.KI.added)).map((e=>this.labelData.getLabel(e.index))),n=t.filter((e=>e.action===c.KI.updated)).map((e=>Object.assign(Object.assign({sid:e.index},e.diff),{layerId:e.layerId})));return Promise.all([this.store.delete(i),this.store.create(s),this.store.update(n)]).then((()=>{}))}onUpdate(e){}async onAfterPublish(){this.verifyDataIntegrity()}async verifyDataIntegrity(){const e="data-integrity"===(0,O.eY)("error",""),t=this.labelData.getCount(),i=await this.store.read().catch((e=>{this.log.debug("Label integrity check failed",e)}))||{},s=Object.keys(i).length;(s!==t||e)&&this.engine.broadcast(new l.Qq(`Unexpected label count after publish (${s}/${t})`,a.g.LABELS,e))}async configureTrash(){const{readonly:e}=this.config;if(e)return;const{commandBinder:t}=this.engine,i=a.g.LABELS,s=new M,n={objectType:i,create:e=>new F.F({label:e.label||"Label",objectId:e.id,objectType:i,created:new Date,value:e}),restore:e=>{const t=s.deserialize(e.value);t&&this.labelData.add(t)}},r=await t.issueCommandWhenBound(new k.B(n));this.bindings.push(r)}}},92543:(e,t,i)=>{"use strict";i.r(t),i.d(t,{USER_LABELS:()=>x,default:()=>ye});var s=i(97542),n=i(57956),a=i(34361),r=i(25985),o=i(79727),h=i(91380),l=i(76532),d=i(53954),c=i(28269),u=i(34029),p=i(12529),g=i(78449),m=i(84428);const y={ColorDefault:16777215,ColorHovered:i(15462).I.MP_BRAND.getHex(),ColorInvalid:16750933};class w extends g.$7{use(e){this.userData.sid=e.data.sid,this.collider.data=e.data,this.collider.name=e.data.text,this.collider.labelMesh=e}}class f extends m.Mesh{constructor(){super(...arguments),this.hitTest=(()=>{const e=new m.Matrix4,t=new m.Ray,i=new m.Plane(new m.Vector3(0,0,-1)),s=new m.Vector3;return(n,a)=>{if(e.copy(this.matrixWorld).invert(),t.copy(n.ray).applyMatrix4(e),t.intersectPlane(i,s)){const e=this.scale.x/this.scale.y;let t=.5;e<1.5&&(t=1/e),Math.abs(s.x)<=t&&Math.abs(s.y)<=.75&&(s.applyMatrix4(this.matrixWorld),a.push({distance:n.ray.origin.distanceTo(s),point:s.clone(),object:this}))}}})()}labelVisible(){return!(!this.labelMesh||!this.labelMesh.labelVisible())}getId(){if(!this.data)throw new Error("LabelInputCollider used before configure");return this.data.sid}raycast(e,t){if(!this.labelVisible())return;if(this.material.depthTest)return void this.hitTest(e,t);const i=this.material.depthTest?t:[];this.hitTest(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}class v{constructor(e){this.makeLabel=()=>{const e=new w(Object.assign({},this.textStyle));return e.scaleType=g.N3.WORLD,e.setRenderOrder(p.z.labels),e.setRenderLayer(this.layer),e.opacity=0,e},this.textStyle=g.uc.makeConfig({color:"white",background:!e,backgroundAsCollider:!0,backgroundColliderType:f,backgroundColor:"#222",backgroundOpacity:1,outline:e,outlineWidth:8,backgroundBorderHeight:26,backgroundBorderWidth:20,wordWrapWidth:void 0,disableDepth:!0})}setRenderLayer(e){this.layer=e}}var b=i(19663);class T extends b.m{constructor(e){super(),this.payload={ids:e}}}class S extends b.m{constructor(e){super(),this.payload={enabled:e}}}var D=i(15637),P=i(89557);const I="MP_LABEL_SEARCH_GROUP",x={LABEL_SIZE:0,FADE_DURATION:200};var M=i(39880);class E extends m.Object3D{constructor(e){super(),this.text=e,this.maxOpacity=1,this.labelAnim=new P.z(0),this.filtered=!1,this.hidden=!1,this.selectState={active:!1,on:()=>{},off:()=>{}},this.validState={active:!0,on:()=>{const e=this.hoverState.active?y.ColorHovered:y.ColorDefault;this.text.setColorHex(e)},off:()=>{this.text.setColorHex(y.ColorInvalid)}},this.hoverState={active:!1,on:()=>{this.validState.active&&this.text.setColorHex(y.ColorHovered)},off:()=>{this.validState.active&&this.text.setColorHex(y.ColorDefault)}},this.add(e)}use(e){this.data=e,this.userData.sid=e.sid,this.userData.data=e,this.text.use(this),this.labelUpdate(e.position,new m.Quaternion,"")}getId(){return this.data.sid}labelVisible(){return!this.filtered&&!this.hidden}updatePose(e,t){return this.labelUpdate(e,t,this.data.text),this}setMaxOpacity(e){this.maxOpacity=e,this.toggleLabel(this.labelVisible())}async free(){this.labelAnim.value>0&&(this.toggleLabel(!1),await(0,M.gw)(x.FADE_DURATION))}tickAnimations(e){return this.animateLabelOpacity(.5*e),this}toggleLabel(e){this.hidden=!e,this.updateOpacity()}isHidden(){return this.hidden}toggleFiltered(e){e!==this.filtered&&(this.filtered=e,this.updateOpacity())}updateOpacity(){const e=this.labelVisible()?this.maxOpacity:0;this.labelAnim.endValue!==e&&this.labelAnim.modifyAnimation(this.labelAnim.value,e,x.FADE_DURATION)}animateLabelOpacity(e){const t=this.labelAnim.tick(e);Math.min(t,this.maxOpacity)!==this.text.opacity&&(this.text.opacity=t)}labelUpdate(e,t,i){this.text.position.copy(e),this.text.quaternion.copy(t),this.text.text=i}billboard(e,t,i,s,n,a,r){this.text.scaleBillboard(e,t,i,s,n,a,r)}}var C=i(97998);const R=new C.Z("label-spawner");class A{constructor(e,t){this.map=e,this.maker=t,this.container=new m.Object3D,this.pool=[],this.bindings=[],this.meshesMap=(0,D.q)(),this.container.name="RoomLabels";const i=e.keys;for(const t of i){const i=e.get(t);this.add(i,t)}this.bindings.push(e.onElementChanged({onAdded:(e,t)=>{this.add(e,t),R.debug("LabelMesh: added:",t)},onRemoved:(e,t)=>{R.debug("LabelMesh: removing:",t);const i=this.meshesMap.get(t);i&&this.free(i)}}))}subscribe(e){return this.meshesMap.onElementChanged(e)}get(e){return this.meshesMap.get(e)}free(e){const t=e.getId(),i=this.meshesMap.get(t);return i.free().then((()=>{this.meshesMap.delete(t),this.container.remove(i),this.pool.push(i),R.debug("LabelMesh: removed:",i)}))}add(e,t){const i=this.get(t);if(i)return i;const s=this.pool.shift();if(void 0!==s)return s.use(e),this.container.add(s),this.meshesMap.set(t,s),s;{const i=new E(this.maker.makeLabel());return i.use(e),this.container.add(i),this.meshesMap.set(t,i),i}}dispose(){for(const e of this.meshesMap.values)this.free(e);this.bindings.forEach((e=>e.cancel()))}}var L=i(2569);class O{constructor(e,t,i,s){this.meshes=e,this.cameraData=i,this.screenFilter=s,this.dirty=!0,this.bindings=[],this.pendingMesh=null,this.setDirty=()=>{this.dirty=!0},this.bindings.push(i.onChanged(this.setDirty),t.onChanged(this.setDirty));for(const e of this.meshes.values)e.text.onGeomUpdate(this.setDirty);this.meshes.onElementChanged({onAdded:e=>e.text.onGeomUpdate(this.setDirty)})}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}setPendingMeshId(e){if((!this.pendingMesh||this.pendingMesh.getId()!==e)&&(this.pendingMesh&&(this.pendingMesh.data.removeOnChanged(this.setDirty),this.pendingMesh=null),e)){const t=this.meshes.get(e);t.data.onChanged(this.setDirty),this.pendingMesh=t}}beforeRender(){if(!this.dirty)return;this.dirty=!1;const{position:e,rotation:t,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.zoom(),a=this.cameraData.aspect(),r=(0,L.dS)(64-x.LABEL_SIZE,0,64,.02,.1);for(const o of this.meshes.values)o.isHidden()||(o.updatePose(o.data.position,t),o.billboard(e,t,i,n,s,a,r));this.screenFilter.update();for(const e of this.meshes.values)e.isHidden()||e.toggleFiltered(!this.screenFilter.visible(e.data.sid))}render(e){for(const t of this.meshes)t.tickAnimations(e)}deactivate(){}init(){}activate(){}}var F=i(82582),k=i.n(F),B=i(59370);class N{constructor(e,t,i){this.meshes=e,this.cameraData=t,this.enabled=i,this.tree=new(k()),this.visibleMap={},this._screenPosition=new m.Vector2,this._ndcPosition=new m.Vector3,this._cornerWorldPosition=new m.Vector3,this._cornerScreenPosition=new m.Vector2,this._selectedId=null,this.update=()=>{this.enabled()?(this.visibleMap={},this.updatePositions()):Object.keys(this.visibleMap).length&&(this.visibleMap={})}}visible(e){if(!(e in this.visibleMap))return!1;return e in this.visibleMap}setSelectedMeshId(e){this._selectedId=e}updatePositions(){this.tree.clear(),this.meshes().filter((e=>!e.isHidden())).map((e=>{(0,B.q9)(this.cameraData,e.text.position,this._screenPosition,this._ndcPosition);const{width:t,height:i}=e.text.textGeometry.layout;this._cornerWorldPosition.set(.5*t,-.5*i,0),e.text.updateMatrixWorld(),this._cornerWorldPosition.applyMatrix4(e.text.matrixWorld),(0,B.q9)(this.cameraData,this._cornerWorldPosition,this._cornerScreenPosition);const s=e.getId()!==this._selectedId?this._ndcPosition.z:-999;return this.describeBbox(e.text,this._screenPosition,this._cornerScreenPosition,s)})).sort(((e,t)=>e.depth-t.depth)).forEach((e=>{this.tree.collides(e)||(this.tree.insert(e),this.visibleMap[e.id]=e)}))}describeBbox(e,t,i,s){i.sub(t);const n=i.x,a=i.y;return{id:e.userData.sid,depth:s,minX:t.x-n,minY:t.y-a,maxX:t.x+n,maxY:t.y+a}}}var G=i(54244),_=i(59625),U=i(39642),z=i(23037),V=i(76631),j=i(23254),Q=i(80742);class H{constructor(e){this.meshes=e,this.initialized=!1,this.pendingMeshId=null,this.dirty=!0,this.bindings=[],this.labelIdVisibility={},this.visibilityFilterEnabled=!1,this.featureEnabled=()=>{if(!this.initialized)return!1;const e=this.appData.phase===G.nh.PLAYING,t=this.settingsData.tryGetProperty(U.Q5,!1),i=this.settingsData.tryGetProperty(z.Nj,!1),s=this.appData.application===G.Mx.WORKSHOP,n=this.settingsData.tryGetProperty(_.gx.Labels,!1)||s,a=e&&i&&n&&(t||s);return this.settingsData.setProperty(z.Cu,a),a},this.visibleByTool=()=>{if(!this.initialized)return!1;const{activeToolName:e}=this.toolsData;return null===e||e===V.w1.LABELS||e===V.w1.PHOTOS||e===V.w1.SEARCH||e===V.w1.LAYERS},this.visibleByViewmode=()=>{const e=this.settingsData.tryGetProperty(U.Q5,!1),t=this.settingsData.tryGetProperty(_.gx.LabelsDollhouse,!1)||e&&this.toolsData.activeToolName===V.w1.LABELS,i=this.viewmodeData.isDollhouse()&&t&&e;return this.viewmodeData.isFloorplan()&&(this.appData.application===G.Mx.WORKSHOP&&this.visibleByTool()||e&&this.settingsData.tryGetProperty(_.gx.Labels,!1))||i},this.hiddenByTransition=()=>this.viewmodeData.transitionActive()||this.floorsViewData.transitionActive,this.visibleByFloor=e=>{const t=this.settingsData.tryGetProperty(U.Q5,!1),i=this.toolsData.activeToolName===V.w1.LABELS;if(t&&!i){const{roomSelectModeActive:e,floorSelectModeActive:t}=this.floorsViewData;if(!e)return!1;if(t)return!1}return this.viewmodeData.isFloorplan()?this.floorsViewData.currentFloor?this.floorsViewData.isCurrentOrAllFloors(e):this.floorsViewData.topFloorId===e:this.floorsViewData.isCurrentOrAllFloors(e)},this.setDirty=()=>{this.dirty=!0}}async init(e){[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,this.layersData]=await Promise.all([e.waitForData(j.O),e.waitForData(o.c),e.waitForData(u.e),e.waitForData(h.t),e.waitForData(G.pu),e.waitForData(Q.R)]);const t=await e.waitForData(a.D);[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,t].forEach((e=>this.bindings.push(e.onChanged(this.setDirty)))),this.bindings.push(this.layersData.onCurrentLayersChanged(this.setDirty)),this.meshes.onChanged(this.setDirty),this.initialized=!0}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}setVisibilityFilterEnabled(e){this.visibilityFilterEnabled=e,this.setDirty()}updateLabelVisibility(e){this.labelIdVisibility=e.reduce(((e,t)=>(e[t]=!0,e)),{}),this.setDirty()}onUpdate(){if(!this.initialized||!this.dirty)return;this.dirty=!1;const e=this.featureEnabled()&&!this.hiddenByTransition()&&this.visibleByTool()&&this.visibleByViewmode(),t=e=>e.visible&&this.visibleByFloor(e.floorId)&&this.visibleById(e.sid)&&this.visibleByLayer(e.layerId);for(const i of this.meshes.values){const s=e&&(i.data.sid===this.pendingMeshId||t(i.data));i.toggleLabel(s)}this.dirtyCb&&this.dirtyCb()}setPendingMeshId(e){this.pendingMeshId=e,this.setDirty()}setDirtyCallback(e){this.dirtyCb=e}visibleById(e){return!this.visibilityFilterEnabled||!!this.labelIdVisibility[e]}visibleByLayer(e){return this.appData.application===G.Mx.WORKSHOP||this.layersData.layerToggled(e)}}var W=i(41326),Y=i(64918),Z=i(72996),q=i(86819),X=i(23612),K=i(35895),$=i(89570),J=i(38987),ee=i(34956),te=i(31362),ie=i(12039);class se{constructor(e,t,i,s,n,a){this.labelRenderer=e,this.issueCommand=t,this.input=i,this.floorsViewData=s,this.toolsData=n,this.roomNavigationPose=a,this.inputBindings=[],this.appStateBindings=[],this.raycasterRegistrationBindings=[],this.active=!0,this.enabled=!0,this.refresh=()=>{this.shouldBeInteractive!==this.active&&(this.inputBindings.forEach((e=>this.shouldBeInteractive?e.renew():e.cancel())),this.raycasterRegistrationBindings.forEach((e=>this.shouldBeInteractive?e.renew():e.cancel())),this.active=this.shouldBeInteractive)},this.refreshColliders=()=>{for(const e of this.labelRenderer.labelMeshIterator())this.shouldBeInteractive?this.input.registerMesh(e.text.collider,!1):this.input.unregisterMesh(e.text.collider)},this.clearColliders=()=>{for(const e of this.labelRenderer.labelMeshIterator())this.input.unregisterMesh(e.text.collider)},this.inputBindings.push(...this.setupInputBindings()),this.raycasterRegistrationBindings.push(...this.setupRaycasterBindings());const r=this.toolsData.onToolChanged(this.refresh),o=this.floorsViewData.makeFloorChangeSubscription(this.refresh),h=this.floorsViewData.onRoomSelectModeChange(this.refresh);this.appStateBindings.push(r,o,h),this.refresh()}toggleInput(e){this.enabled!==e&&(this.enabled=e,this.appStateBindings.forEach((t=>e?t.renew():t.cancel())),this.refresh())}get shouldBeInteractive(){return this.enabled&&null===this.toolsData.activeToolName&&this.floorsViewData.roomSelectModeActive}setupRaycasterBindings(){return[(0,K.k1)((()=>this.refreshColliders()),(()=>this.clearColliders()),!0,"toggleLabelMeshInput"),this.labelRenderer.subscribe({onAdded:e=>this.input.registerMesh(e.text.collider,!1),onRemoved:e=>this.input.unregisterMesh(e.text.collider)})]}setupInputBindings(){const e=Z.s.is((e=>e instanceof f&&e.labelVisible())),t=this.input.registerMeshHandler(q.R,e,((e,t)=>{const i=this.labelRenderer.getLabelMesh(t.getId());if(i){const e=i.data.roomId;if(e){const t=this.roomNavigationPose.getPoseForRoom(e,i.data.position);t&&this.issueCommand(new W._i(W.BD.INSIDE,Y.n.Interpolate,t))}else this.issueCommand(new ie.zs({focusPosition:i.data.position,transition:Y.n.Interpolate}))}}));if((0,te.Jm)())return[t];let i=null;return[new $.V(this.input.registerMeshHandler(X.z,e,((e,t)=>{const s=this.labelRenderer.getLabelMesh(t.getId());s&&(s.hoverState.active=!0,s.hoverState.on(),i=s,this.issueCommand(new J.u(ee.C.FINGER)))})),this.input.registerMeshHandler(X.A,Z.s.isType(f),((e,t)=>{i&&this.issueCommand(new J.u(ee.C.DEFAULT));const s=this.labelRenderer.getLabelMesh(t.getId());s&&(s.hoverState.active=!1,s.hoverState.off()),i=null})),(0,K.k1)((()=>{}),(()=>{i&&(i.hoverState.active=!1,i.hoverState.off(),this.issueCommand(new J.u(ee.C.DEFAULT)),i=null)}),!0,"labelHoverClear")),t]}}var ne=i(90304),ae=i(95882);const re=new C.Z("room-with-a-view");class oe{constructor(e,t,i){this.sweepData=e,this.roomData=t,this.meshData=i}getPoseForRoom(e,t){const i=this.bestViewForRoom(e,t);if(i){return{rotation:i.rotation,sweepID:i.sweepID,viewmode:ae.Ey.Panorama}}return null}bestViewForRoom(e,t){const i=this.sweepData.filter((t=>t.roomId===e&&t.enabled));if(0===i.length)return re.debug("no sweeps in selected room",{roomId:e,scansInRoom:i}),null;let s=1;const n=this.roomData.get(e),a=this.meshData.meshGroups.rooms.get(n.meshSubgroup),r=(null==a?void 0:a.boundingBox.getSize(new m.Vector3).length())||1/0;t&&r>10&&(s=.2);const o=i.sort(((i,n)=>{let a=0,r=0;t&&(a=i.position.distanceTo(t),r=n.position.distanceTo(t));const o=i.neighbours.map((e=>this.sweepData.getSweep(e))).filter((t=>t.roomId===e)).length,h=n.neighbours.map((e=>this.sweepData.getSweep(e))).filter((t=>t.roomId===e)).length;return 1*s*(h-o)-3*(r-a)})),h=o[0];if(!h)return re.debug("no start sweep",{roomId:e,scansInRoom:i,connectedness:o}),null;const l=h.neighbours.map((e=>this.sweepData.getSweep(e))).sort(((t,i)=>{let s=h.position.distanceTo(t.position),n=h.position.distanceTo(i.position);return t.roomId===e&&(s*=1e3),i.roomId===e&&(n*=1e3),n-s})).map((e=>({sweep:e,dist:h.position.distanceTo(e.position),rm:e.roomId}))),d=l[0];re.warn({roomId:e,roomSize:r,scoring:o,byDistance:l,scansInRoom:i});const c=new m.Quaternion;if(1===i.length&&void 0!==d){const e=(new m.Matrix4).setPosition(h.position);e.lookAt(d.sweep.position,h.position,ne.f.UP),c.setFromRotationMatrix(e)}else{const e=(new m.Matrix4).setPosition(h.position);e.lookAt(h.position,d.sweep.position,ne.f.UP),c.setFromRotationMatrix(e)}return{sweepID:h.id,rotation:c}}}var he=i(5586),le=i(35221),de=i(56163);class ce extends de.K{constructor(e,t,i,s){super(e,t),this.label=i,this.typeId=s,this.id=this.label.sid,this.title=this.label.text,this.icon="icon-toolbar-labels",this.floorId=this.label.floorId,this.layerId=this.label.layerId,this.dateBucket=(0,le.f)(this.label.created),this.enabled=this.label.visible,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new ie.Cs(this.label))}}}var ue=i(71166),pe=i(38399);const{LABELS:ge}=pe.Z.SHOWCASE;class me extends s.Y{constructor(){super(...arguments),this.name="user-labels",this.labelMeshIterator=()=>this.spawner.meshesMap.values,this.checkForRTL=(()=>{const e=/[\u0591-\u07FF]/;let t;return(i,s)=>{if(!s.tryGetProperty(U.Q5,!1))return;const n=i=>{s.tryGetProperty(U.Q5,!1)&&e.test(i.text)&&(this.broadcast(new he.V),s.setProperty(U.Q5,!1),t&&t.cancel())};i.getCollection().entries().forEach((e=>n(e[1]))),s.tryGetProperty(U.Q5,!1)&&(t=i.getCollection().onElementChanged({onAdded:n,onUpdated:n}),this.bindings.push(t))}})(),this.filterVisibleLabels=async e=>{this.visibilityRules.updateLabelVisibility(e.ids)},this.changeVisibilityFilterEnabled=async e=>{this.visibilityRules.setVisibilityFilterEnabled(e.enabled)}}async init(e,t){const[i,s,p,g,m,y,w,f,b,D]=await Promise.all([t.market.waitForData(a.D),t.market.waitForData(r.M),t.market.waitForData(o.c),t.market.waitForData(h.t),t.market.waitForData(d.Z),t.market.waitForData(c.Z),t.market.waitForData(l._),t.getModuleBySymbol(n.y.WEBGL_RENDERER),t.getModuleBySymbol(n.y.INPUT),t.market.waitForData(u.e)]),P=f.getScene();this.broadcast=t.broadcast,this.checkForRTL(i,D);const x=new v(D.tryGetProperty(U.Q5,!1));x.setRenderLayer(t.claimRenderLayer("labels")),this.spawner=new A(i.getCollection(),x),P.add(this.spawner.container),this.visibilityRules=new H(this.spawner.meshesMap),this.visibilityRules.init(t.market),this.bindings.push(t.commandBinder.addBinding(T,this.filterVisibleLabels),t.commandBinder.addBinding(S,this.changeVisibilityFilterEnabled));this.labelFilter=new N(this.labelMeshIterator,s,(()=>this.visibilityRules.featureEnabled()&&this.visibilityRules.visibleByTool())),this.labelRenderer=new O(this.spawner.meshesMap,i.getCollection(),s,this.labelFilter),t.addComponent(this,this.labelRenderer),this.visibilityRules.setDirtyCallback(this.labelRenderer.setDirty);const M=new oe(m,y,w);this.labelNavInput=new se(this,t.commandBinder.issueCommand,b,p,g,M),this.toggleInput(!0),async function(e,t,i){const[s,n]=await Promise.all([e.market.waitForData(G.pu),e.market.waitForData(Q.R)]),a=(i,a,r=[])=>{const o=[],h=[],l=s.application===G.Mx.WORKSHOP;return t.iterate((t=>{(l||t.visible&&n.layerToggled(t.layerId))&&0===r.length&&i(t.text)&&(h.push(t.sid),o.push(new ce(e.commandBinder,n,t,I)))})),e.commandBinder.issueCommand(new T(h)),o.sort(((e,t)=>e.title.localeCompare(t.title)))},r=t=>{e.commandBinder.issueCommand(new S(t))},o=e=>new $.V(t.onChanged(e),n.onChanged(e)),h={renew:()=>{e.commandBinder.issueCommandWhenBound(new ue.c6({id:I,groupPhraseKey:ge.SEARCH_GROUP_HEADER,getSimpleMatches:a,registerChangeObserver:o,onSearchActivatedChanged:r,groupOrder:30,groupIcon:"toolbar-labels"}))},cancel:()=>{e.commandBinder.issueCommandWhenBound(new ue.Pe(I))}},l=()=>{const e=s.application===G.Mx.WORKSHOP;i.tryGetProperty(_.gx.Labels,!1)||e?h.renew():h.cancel()},d=s.onPropertyChanged("application",l),c=i.onPropertyChanged(_.gx.Labels,l);return l(),new $.V(h,d,c)}(t,i,D).then((e=>this.bindings.push(e)))}dispose(e){super.dispose(e),this.visibilityRules.dispose()}getLabelMesh(e){return e&&this.spawner.get(e)||null}addLabelMesh(e,t){return this.spawner.add(e,t)}freeLabelMesh(e){e&&this.spawner.free(e)}setPendingMeshId(e){this.visibilityRules.setPendingMeshId(e),this.labelRenderer.setPendingMeshId(e)}setSelectedMeshId(e){this.labelFilter.setSelectedMeshId(e)}toggleInput(e){this.labelNavInput.toggleInput(e)}subscribe(e){return this.spawner.subscribe(e)}onUpdate(){this.visibilityRules&&this.visibilityRules.onUpdate()}}const ye=me},76160:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Group:()=>re,Grouper:()=>ae,MeasurementLabelBackgroundMesh:()=>Se,MeasurementLabelRenderer:()=>De,MeasurementLineRenderer:()=>ye,MeasurementModeData:()=>te.X,MeasuringPhase:()=>ee.au,default:()=>ai,labelVisible:()=>ee.Ph});var s,n=i(97542),a=i(57956),r=i(78449),o=i(29537),h=i(34956),l=i(64918),d=i(38987),c=i(33324),u=i(25985),p=i(79727),g=i(23254),m=i(95882),y=i(97998),w=i(84428),f=i(89557);!function(e){e[e.FloorplanOnly=0]="FloorplanOnly",e[e.ThreeD=1]="ThreeD"}(s||(s={}));var v=i(54244),b=i(69505),T=i(46391),S=i(59370),D=i(78283);const P=new w.Vector2,I=new w.Vector3,x=new w.Vector2,M=new w.Vector2,E=(e,t,i)=>{const s=((e,t,i)=>((0,S.q9)(i,e,x),(0,S.q9)(i,t,M),{pixelDistance:x.distanceTo(M),startScreenPosition:x,endScreenPosition:M}))(e,t,i);return{screenPosition:((e,t,i)=>(I.copy(e).add(t).multiplyScalar(.5),(0,S.q9)(i,I,P),P))(e,t,i),rotation:C(x,M),pixelDistance:s.pixelDistance,startScreenPosition:s.startScreenPosition,endScreenPosition:s.endScreenPosition}},C=(e,t)=>{const i=e.y-t.y,s=e.x-t.x;let n=Math.atan2(i,s)*b.MN;return n=n>=90||n<=-90?n+180:n,n},R=(e,t=T.M.IMPERIAL)=>{let i='0"';switch(t){case T.M.IMPERIAL:const{feet:t,inches:s}=(0,D.XJ)(e);i=t>0?`${t}' ${s}"`:`${s}"`;break;case T.M.METRIC:i=`${e.toFixed(2)}m`}return i};var A=i(66990);const L=new y.Z("line-data"),O=()=>({lineVisibleByFeatureType:!0,labelVisibleByFeatureType:!0});class F{constructor(e,t,i,n,a,r,o,h,l=O){this.cameraData=e,this.viewmodeData=t,this.floorsViewData=i,this.layersData=n,this.applicationData=a,this.isCurrentSweepAligned=r,this.getUnits=o,this.isFeatureEnabled=h,this.visibleFilter=l,this.derivedDataCache={},this.dollhouseLineStyle=s.ThreeD,this.setVisibilityFilter=e=>{this.visibleFilter=e},this.resetVisibilityFilter=()=>{this.visibleFilter=O},this.make=(e,t,i)=>{const s=t(),{start_position:n,end_position:a,visible:r,floorId:o,layerId:h,type:l,text:d}=s,c=r&&this.isFeatureEnabled(),u=c&&this.visibleByFloorAndModes(o,l)&&this.visibleByLayer(h),p=void 0!==i?i.opacity.value:0,g=0===p||p===A.iV.LABEL_HIDDEN_OPACITY&&u;if(i&&g&&(!c||!u))return i;let m=u,y=u;if(u){const t=this.visibleFilter(e);m=m&&t.lineVisibleByFeatureType,y=y&&t.labelVisibleByFeatureType}let w=0;const v=n.distanceTo(a),b=R(v,this.getUnits());if(y||!g){const{width:e,height:t}=((e,t=10,i=40)=>({width:Math.max(9*Math.max(e,2)+t,i),height:18+t}))(d.length+b.length),i=E(n,a,this.cameraData);this.tmpVec.copy(i.startScreenPosition).sub(i.endScreenPosition);let s=Math.abs(this.tmpVec.y)<Math.abs(this.tmpVec.x)?t:e;A.iV.ALIGN_LABELS&&(s=e,w=i.rotation),y=y&&i.pixelDistance>s}let T;const S=m&&y?1:m&&!y?A.iV.LABEL_HIDDEN_OPACITY:0;i?(T=i.opacity,T.endValue===S&&m===i.visible&&y===i.labelVisible||T.modifyAnimation(T.value,S,A.iV.FADE_DURATION)):T=new f.z(0,S,A.iV.FADE_DURATION);const D={sid:e,rotation:w,labelVisible:y,visible:m,length:v,displayLength:b,labelContents:d.length>0?`${b} ${d}`:b,opacity:T};return this.derivedDataCache[e]={getLineData:t,previousDerivedData:D},D},this.update=e=>{if(this.derivedDataCache[e]){const{getLineData:t,previousDerivedData:i}=this.derivedDataCache[e];return this.make(e,t,i)}L.warn(`data not found for ${e}`)},this.get=e=>{if(this.derivedDataCache[e])return this.derivedDataCache[e].previousDerivedData},this.remove=e=>{this.derivedDataCache[e]&&delete this.derivedDataCache[e]},this.clear=()=>{this.derivedDataCache={}},this.visibleByFloorAndModes=(e,t)=>{if(this.floorsViewData.transition.progress.active)return!1;const i=this.viewmodeData.isInside(),n=this.viewmodeData.isFloorplan(),a=this.viewmodeData.isDollhouse(),r=this.floorsViewData.currentFloorId,o=!r,h=!(!r||r!==e),l=e===this.floorsViewData.topFloorId,d=t===s.FloorplanOnly&&n&&(h||l&&o),c=t===this.dollhouseLineStyle&&a&&(h||o);return t===s.ThreeD&&i&&this.isCurrentSweepAligned()||c||d},this.tmpVec=new w.Vector2}setDollhouseLineStyle(e){this.dollhouseLineStyle=e}visibleByLayer(e){return this.applicationData.application===v.Mx.WORKSHOP||this.layersData.layerToggled(e)}}var k=i(34029),B=i(59625),N=i(26158),G=i(53954),_=i(62436),U=i(57989),z=i(19663);class V extends z.m{constructor(e){super(),this.payload=e}}class j extends z.m{constructor(e){super(),this.payload={sid:e}}}var Q=i(51205),H=i(35870),W=i(32489),Y=i(16078);class Z extends z.m{constructor(e){super(),this.payload=e}}class q extends z.m{constructor(e){super(),this.id="FILTER_MEAUREMENT_VISIBILITY",this.payload={sids:e}}}class X extends z.m{constructor(e){super(),this.id="MEASUREMENT_VISIBILITY_FILTER_ENABLED",this.payload={enabled:e}}}var K=i(93866),$=i(75810),J=i(40964),ee=i(20341),te=i(92294),ie=i(72119),se=i(37262),ne=i(92558);class ae{constructor(e){this.contents=e,this.groupInfo=[],this.groupIndices=[],this.groupInfoMap={},this.groupIndicesMap={}}startGroup(e){const t=0===this.groupCount,i=this.contents.length!==this.groupIndices[this.groupCount-1];if(t||i){let t=e.sid;if(!t)for(t=(0,ne.fV)();this.groupInfoMap.hasOwnProperty(t);)t=(0,ne.fV)();const i=Object.assign(Object.assign({},e),{sid:t});this.groupInfo.push(i),this.groupInfoMap[t]=i,this.groupIndices.push(this.contents.length),this.groupIndicesMap[this.contents.length]=!0}return this.groupIndices.length-1}reset(){this.contents.atomic((()=>{for(let e=this.contents.length-1;e>=0;--e)this.removeFromIdx(e);this.groupIndices=[],this.groupInfo=[],this.groupIndicesMap={}}))}isStartIndex(e){return!!this.groupIndicesMap[e]}*groups(){for(let e=0;e<this.groupCount;++e)yield this.getGroup(e)}*[Symbol.iterator](){for(const e of this.contents)yield e}getGroupStartIndex(e){return this.groupIndices[e]}getGroup(e){const t=this.groupIndices[e],i=this.groupIndices[e+1],s=isNaN(i)?this.contents.length-1:i-1;return new re(e,this.contents,t,s,Object.assign({},this.groupInfo[e]))}getGroupById(e){for(let t=0;t<this.groupInfo.length;t++)if(e===this.groupInfo[t].sid)return this.getGroup(t)}indexOfGroup(e){for(let t=0;t<this.groupInfo.length;t++)if(e(this.groupInfo[t]))return t;return-1}updateGroupInfo(e,t){const i=this.groupInfo[e].sid;delete this.groupInfoMap[i];const s=Object.assign({sid:i},t);this.groupInfo.splice(e,1,s),this.groupInfoMap[i]=s}get groupCount(){return this.groupIndices.length}get length(){return this.contents.length}get(e){return this.contents.get(e)}push(e){if(0===this.groupCount)throw Error("Grouper: Error pushing points when we have no groups!");return this.contents.push(e.clone()),this.contents.length}pop(){return this.removeFromIdx(this.contents.length-1)}removeFromIdx(e){if(e<this.contents.length&&e>=0&&this.contents.length>=0){const t=this.contents.get(e);return this.contents.remove(e),this.removeEmptyGroups(),t}}removeEmptyGroups(){this.contents.length<=this.groupIndices[this.groupCount-1]&&this.removeGroup(this.groupCount-1)}groupFromPointIndex(e){if(0>e||e>=this.length)return-1;let t=this.groupCount-1;for(;e<this.groupIndices[t];)--t;return t}removeGroup(e){if(e>this.groupCount||e<0)return;const t=this.getGroup(e);if(0===t.count)return;const i=this.groupIndices[e];this.groupIndices.splice(e,1),this.groupInfo.splice(e,1),delete this.groupInfoMap[t.info.sid],delete this.groupIndicesMap[i];for(let i=e;i<this.groupCount;++i){const e=this.groupIndices[i],s=e-t.count;this.groupIndices[i]=s,delete this.groupIndicesMap[e],this.groupIndicesMap[s]=!0}this.contents.splice(t.startIndex,t.count)}update(e,t){this.contents.update(e,t.clone())}copy(e,t=!0){return t&&this.reset(),this.contents.atomic((()=>{for(const t of e){this.startGroup(t.info);for(const e of t)this.push(e)}})),this}toString(){return`Grouper: { groupCount: ${this.groupCount}, length: ${this.length}, groups: [${[...this.groups()].map((e=>`${e}`))}]}`}}class re{constructor(e,t,i,s,n){this.index=e,this.grouper=t,this.startIndex=i,this.endIndex=s,this.data=n}*[Symbol.iterator](){for(let e=0;e<this.count;++e)yield this.get(e)}get(e){if(!this.has(e))throw RangeError(`Out of range error ${e} / ${this.count-1}`);return this.grouper.get(this.startIndex+e)}has(e){return e>=0&&this.startIndex+e<=this.endIndex}get count(){return this.endIndex-this.startIndex+1}get info(){return this.data}get isClosed(){const e=this.grouper.get(this.startIndex),t=this.grouper.get(this.endIndex);return this.count>2&&e.distanceTo(t)<=ie.NZ}get length(){let e=0,t=null;for(let i=0;i<this.count;i++)t&&(e+=this.get(i).distanceTo(t)),t=this.get(i);return e}get segmentLengths(){const e=[];let t=null;for(let i=0;i<this.count;i++)t&&e.push(this.get(i).distanceTo(t)),t=this.get(i);return e}hasLength(){const e=this.grouper.get(this.startIndex),t=this.grouper.get(this.endIndex);return e&&t&&(this.isClosed||e.distanceTo(t)>ie.NZ)}clone(){const e=[],t={get:t=>e[t],contents:e};for(let e=0;e<this.count;e++)t.contents.push(this.get(e));return new re(this.index,t,0,t.contents.length-1,Object.assign({},this.data))}describe(e=this.endIndex){return`GroupSegment${this.index}/${this.startIndex}/${e}}`}equals(e){if(this.count!==e.count||this.index!==e.index)return!1;if((0,se.NK)(this.info,e.info))return!1;for(let t=0;t<this.count;++t)if(!this.get(t).equals(e.get(t)))return!1;return!0}}var oe,he,le=i(31546),de=i(54702),ce=i(35895);!function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED",e[e.UPDATED=2]="UPDATED",e[e.COUNT=3]="COUNT"}(oe||(oe={})),function(e){e[e.ADDED=1]="ADDED",e[e.REMOVED=2]="REMOVED",e[e.UPDATED=4]="UPDATED",e[e.ALL=7]="ALL"}(he||(he={}));const ue=(e,t)=>{const i=t&he.ADDED,s=t&he.REMOVED,n=t&he.UPDATED,a={};let r;return new ce.gm((()=>e),(t=>r=e.onElementChanged((e=>(a.onAdded=i?e:void 0,a.onRemoved=s?e:void 0,a.onUpdated=n?e:void 0,a))(t))),(e=>{r&&r.cancel()}))};var pe;!function(e){e[e.x=16711680]="x",e[e.y=32768]="y",e[e.z=255]="z",e[e.free=16777215]="free",e[e.xz=16711935]="xz",e[e.laser=16724312]="laser",e[e.yellow=16776960]="yellow",e[e.white=16777215]="white"}(pe||(pe={}));var ge=i(67944),me=i(56512);class ye{constructor(e,t,i,s,n,a,r=(()=>-1),o,h=16777215){this.points=e,this.createPointSubscription=t,this.cameraData=i,this.lineModule=s,this.mainLayer=n,this.lineLayer=a,this.selectedGroup=r,this.getLineDetails=o,this.lineColor=h,this.endpointGeometry=(0,me.fc)(),this.linePool=[],this.groupToLines={},this.pointToLines={},this.activeLines=[],this.cameraQuaternion=new w.Quaternion,this.cameraPosition=new w.Vector3,this.cameraProjection=new le.M,this.getLinesForPoint=e=>{const t=[];if(this.pointToLines[e])for(const i of this.pointToLines[e]){const e=i.getMesh(de.B.line),{startIndex:s,endIndex:n,group:a}=e.userData;t.push({endIndex:n,startIndex:s,line:i,group:a})}return t},this.updateMaterialColors(this.lineColor),this.dataSubs=[this.createPointSubscription(he.REMOVED,((e,t)=>{this.resetLines()}))]}updateMaterialColors(e){const t=A.V9.lineDefault;this.lineMaterial=this.lineModule.makeLineMaterial(e,!0,{linewidth:t}),this.setStencilState(this.lineMaterial),this.endpointMaterial=this.lineModule.makeEndpointMaterial(e);const i={dashed:!0,dashSize:.025,gapSize:.05,linewidth:A.V9.dottedLineDefault};this.dottedLineMaterial=this.lineModule.makeLineMaterial(e,!1,i),this.setStencilState(this.dottedLineMaterial),this.xLineMaterial=this.lineModule.makeLineMaterial(pe.x,!1,i),this.yLineMaterial=this.lineModule.makeLineMaterial(pe.y,!1,i),this.zLineMaterial=this.lineModule.makeLineMaterial(pe.z,!1,i),this.xzLineMaterial=this.lineModule.makeLineMaterial(pe.xz,!1,i)}setStencilState(e){e.stencilRef=1,e.stencilFail=w.KeepStencilOp,e.stencilZFail=w.KeepStencilOp,e.stencilZPass=w.KeepStencilOp,e.stencilFunc=w.GreaterStencilFunc,e.stencilWrite=!0}setLineOpacityByGroup(e,t){const i=this.groupToLines[e];if(i)for(const e of i)e.opacity(t)}setLineOpacityByPoint(e,t){const i=this.getLinesForPoint(e);if(i)for(const e of i)e.line.opacity(t)}resetLines(){for(const e of this.lines)e.opacity(0),e.hide();this.groupToLines={},this.pointToLines={},this.lines.length=0}updateAllLines(){if(!(this.points.length<1)){for(let e=0;e<this.points.length;e++)this.updateLine(e);for(const e in this.groupToLines){const t=Number(e),i=this.groupToLines[t];for(const e of i)e.updateSelected(this.selectedGroup()===t)}}}init(){}dispose(){this.deactivate();for(const e of this.linePool)e.dispose();this.endpointGeometry.dispose(),this.dottedLineMaterial.dispose(),this.lineMaterial.dispose(),this.endpointMaterial.dispose(),this.xLineMaterial.dispose(),this.yLineMaterial.dispose(),this.zLineMaterial.dispose()}activate(){for(const e of this.dataSubs)e.renew()}deactivate(){for(const e of this.dataSubs)e.cancel();this.resetLines()}get lines(){return this.activeLines}get dottedMaterial(){return this.dottedLineMaterial}beforeRender(){this.cameraQuaternion.copy(this.cameraData.pose.rotation),this.cameraPosition.copy(this.cameraData.pose.position),this.cameraProjection.copy(this.cameraData.pose.projection)}get xMaterial(){return this.xLineMaterial}get yMaterial(){return this.yLineMaterial}get zMaterial(){return this.zLineMaterial}get xzMaterial(){return this.xzLineMaterial}render(){this.updateAllLines()}updateLine(e){const t=this.points.get(e),i=this.points.get(e+1),s=this.points.groupFromPointIndex(e)===this.points.groupFromPointIndex(e+1);t&&i&&s&&this.setLinePosition(e,t,i)}setLinePosition(e,t,i){let s=this.linePool[e];if(!s){const n=this.points.groupFromPointIndex(e);if(!this.getLineDetails(n,e,e+1).visible)return;const a=A.V9.endpointDefault>.01?this.endpointMaterial.clone():void 0;s=this.lineModule.makeLine(t,i,this.lineMaterial.clone(),a,(()=>!(0,ge.Pp)(this.cameraProjection))),this.setupLine(s,e),s.setRenderLayer(this.mainLayer)}s.visible||this.setupLine(s,e),this.linePool[e]=s,s.updateResolution(this.cameraData.width,this.cameraData.height),s.updatePositions(t,i),s.updateBillboard({rotation:this.cameraQuaternion,position:this.cameraPosition,projection:this.cameraProjection})}setupLine(e,t){const i=this.points.groupFromPointIndex(t);e.children.forEach((e=>{e.userData.startIndex=t,e.userData.endIndex=t+1,e.userData.group=i,e.layers.mask=this.mainLayer.mask})),e.getMesh(de.B.line).layers.mask=this.lineLayer.mask,this.activeLines.push(e),this.addLineToGroup(i,e),this.addLineToPoint(t,e),this.addLineToPoint(t+1,e),e.show(),e.opacity(0)}addLineToGroup(e,t){this.groupToLines[e]||(this.groupToLines[e]=[]),this.groupToLines[e].push(t)}addLineToPoint(e,t){this.pointToLines[e]||(this.pointToLines[e]=[]),this.pointToLines[e].push(t)}}var we=i(49827),fe=i(90304),ve=i(86819),be=i(23612),Te=i(72996);class Se extends w.Mesh{}class De{constructor(e,t,i,s,n,a,r,o,h,l,d){this.points=e,this.input=t,this.mobile=i,this.cameraData=s,this.renderLayer=n,this.renderOrder=a,this.textRenderer=r,this.getLineDetails=o,this.changeCursor=h,this.getPhase=l,this.setSelectedLine=d,this.meshPool=[],this.textContainer=new w.Object3D,this.textGeometry=new w.PlaneGeometry(1,1),this.tmpMidpoint=new w.Vector3,this.tmpCamPos=new w.Vector3,this.cameraRotation=new w.Quaternion,this.cameraProjection=new le.M,this.cameraPosition=new w.Vector3;this.inputSubs=[this.input.registerMeshHandler(ve.R,Te.s.isType(Se),((e,t)=>{var i,s;if(this.getPhase()===ee.au.IDLE)return this.setSelectedLine(null===(s=null===(i=null==t?void 0:t.parent)||void 0===i?void 0:i.userData)||void 0===s?void 0:s.groupIndex),!0}))],this.mobile||this.inputSubs.push(...this.registerHoverHandlers()),this.deactivate(),this.deactivateInteraction()}registerHoverHandlers(){return[this.input.registerMeshHandler(be.z,Te.s.isType(Se),(()=>{this.getPhase()===ee.au.IDLE&&this.changeCursor(h.C.FINGER)})),this.input.registerMeshHandler(be.A,Te.s.isType(Se),(()=>{this.changeCursor(h.C.DEFAULT)}))]}reset(){for(const e of this.meshPool)e&&(this.input.unregisterMesh(e.collider),this.textContainer.remove(e));this.meshPool=[]}init(){}dispose(){this.textGeometry.dispose()}activate(){}deactivate(){this.reset()}activateInteraction(){for(const e of this.inputSubs)e.renew()}deactivateInteraction(){for(const e of this.inputSubs)e.cancel()}get container(){return this.textContainer}beforeRender(){const e=this.cameraData.pose;this.cameraRotation.copy(e.rotation),this.cameraPosition.copy(e.position),this.cameraProjection.copy(e.projection);const t=(0,ge.s1)(this.cameraProjection),i=(0,ge.Pp)(this.cameraProjection),s=this.cameraData.height,n=this.cameraData.zoom(),a=this.cameraData.aspect();for(let e=1;e<this.points.length;++e){const r=e-1,o=this.points.groupFromPointIndex(e),h=this.getLineDetails(o,r,e);if(!h||o!==this.points.groupFromPointIndex(r)){this.removeLabelMesh(e);continue}const l=this.points.get(r),d=this.points.get(e),c=this.setMeshVisible(e,h.labelVisible);if(!c)continue;c.text!==h.labelContents&&(c.text=h.labelContents);const u=this.cameraPosition.distanceTo(c.position);if(this.updateMeshPose(c,l,d,this.cameraRotation,this.cameraPosition,u,h.rotation,i),i||t)c.scaleFactor=ie.Hn.SCALE_DISTANCE*n;else{const e=(0,S.D_)(c.position,this.cameraPosition,this.cameraRotation,this.cameraProjection.asThreeMatrix4()),t=Math.abs(e.x);if(t<1){const e=(0,ge.mY)(this.cameraProjection,this.cameraPosition,c.position,s,ie.Hn.SCALE),i=((0,we.uZ)(a,1,2.5)+n)*ie.Hn.SCALE_ASPECT,r=1+ie.Hn.SCALE_NDC-t*ie.Hn.SCALE_NDC-i;c.scaleFactor=Math.max(Math.min(1/e*r,3),.001)}else c.scaleFactor=.001}}for(let e=this.points.length;e<this.meshPool.length;e++)this.removeLabelMesh(e);this.meshPool=this.meshPool.slice(0,this.points.length)}setTextOpacityByPoint(e,t){const i=this.meshPool[e];i&&(i.opacity=t)}updateMeshPose(e,t,i,s,n,a,r,o){this.tmpMidpoint.copy(t).add(i).multiplyScalar(.5);const h=o?e=>this.tmpCamPos.copy(e).addScaledVector(fe.f.UP,.15):e=>this.tmpCamPos.copy(n).sub(e).setLength(.15*a).add(e);e.setPosition(this.tmpMidpoint,h),e.setOrientation(s,r)}render(){}setMeshVisible(e,t){let i=this.meshPool[e];if(!i&&t){i=this.textRenderer.createLabel(),i.setRenderLayer(this.renderLayer),i.renderOrder=this.renderOrder,i.opacity=1,i.visible=!1;const t=this.points.groupFromPointIndex(e);i.userData.groupIndex=t,this.textContainer.add(i),this.input.registerMesh(i.collider,!1),this.meshPool[e]=i}if(i){const e=t?.001:A.iV.LABEL_HIDDEN_OPACITY;if(i.visible=i.opacity>e,!i.visible)return null}return i}removeLabelMesh(e){const t=this.meshPool[e];t&&(this.textContainer.remove(t),this.input.unregisterMesh(t.collider),this.meshPool[e]=null)}}var Pe=i(17878),Ie=i(1089),xe=i(87926),Me=i(13310),Ee=i(85992),Ce=i(85042),Re=i(57721),Ae=i(3220),Le=i(12529);class Oe{constructor(e,t=Pe.o.ALL){this.scene=e,this.layer=t,this.supportsMobile=!0,this.style=Ce.L.GridPlane,this.alignToNormal=!0,this.xzTex=(0,xe.p)(Re),this.zyTex=(0,xe.p)(Ae),this.bindings=[],this.onOpacityUpdate=e=>{this.container.children.forEach((t=>{t.isMesh&&(t.material.opacity=Math.max(0,e.opacity.value))}))},this.onPositionUpdate=(e,t)=>{this.container.position.copy(e).addScaledVector(t,.005),this.alignToNormal&&(0,ge.J2)(this.container,e,t)},this.scale=e=>{this.container.scale.set(e,e,e)},this.onRaycasterUpdate=e=>{e.hit&&e.hit.face&&this.onPositionUpdate(e.hit.point.clone(),e.hit.face.normal)},this.container=new w.Group;const i=new w.PlaneGeometry(.4,.4),s={color:16777215,side:w.DoubleSide,transparent:!0,depthTest:!0,depthWrite:!1};this.xzTex.generateMipmaps=!1,this.xzTex.minFilter=w.LinearFilter,this.xzMaterial=new w.MeshBasicMaterial(Object.assign(Object.assign({},s),{color:65280,map:this.xzTex})),this.xzMaterial.premultipliedAlpha=!1;const n=new w.Mesh(i,this.xzMaterial);n.rotateOnAxis(fe.f.LEFT,Math.PI/2),this.zyTex.generateMipmaps=!1,this.zyTex.minFilter=w.NearestFilter,this.zyMaterial=new w.MeshBasicMaterial(Object.assign(Object.assign({},s),{map:this.zyTex})),this.zyMaterial.premultipliedAlpha=!1;const a=new w.Mesh(i,this.zyMaterial);this.container.add(n,a),this.container.children.forEach((e=>{e.renderOrder=Le.z.reticule,e.layers.mask=this.layer.mask}))}init(){}render(){}dispose(){this.container.children.forEach((e=>{if(e.isMesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(Me.Y),i=await e.market.waitForData(Ee.P);this.bindings.push(t.onChanged(this.onOpacityUpdate),i.onChanged(this.onRaycasterUpdate)),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}var Fe=i(2569),ke=i(14564);class Be{constructor(e,t,i,s,n,a,r){this.mobile=e,this.pointer=t,this.sceneInfo=i,this.renderToTexture=s,this.getLayer=n,this.issueCommand=a,this.editing=!1,this.editingStateChange=!1,this.setOverlay=e=>{this.issueCommand(new ke.u({color:e?ke.u.COLOR_DIM:null}))},this.setupCursorRenderCamera=()=>{const e=new w.PerspectiveCamera(ie.X7.perspective.fov,1,.1,100);e.name="Cursor Peek Camera";const t=Pe.o.ALL,i=["measurement-mode","measurement3d"];for(const e of i)t.removeLayers(this.getLayer(e));e.layers.mask=t.mask,e.updateProjectionMatrix();return{camera:e,update:(t,i,s)=>{e.fov=t,e.near=i,e.far=s,e.updateProjectionMatrix()}}};const o=(0,xe.p)(Ie),h=new w.Vector2,l=e=>{const t=this.rttView.height,i=this.rttView.width,s=this.sceneInfo.cameraData;let n=t/2;const a=-i/2;n=e.y<t/2+n?t+n:-n;const r=e.x+a,o=s.height-e.y-n;return h.set(r,o)};this.cursorMesh=new Oe(this.sceneInfo.scene,this.getLayer("cursor-mesh")),this.cursorMesh.setVisible(!1);const d=new w.Vector3,c=new w.Quaternion,u=new w.Vector2;let p,g,m=r(),y=ie.X7.perspective;this.renderIntersection=(e,t,n)=>{p||(g=this.setupCursorRenderCamera(),p=g.camera,g.update(ie.X7.perspective.fov,.1,100)),m!==r()&&(y=r()?ie.X7.ortho:ie.X7.perspective,this.cursorMesh.scale(y.scale),g.update(y.fov,.1,100),m=r());const a=this.editingStateChange?1:ie.X7.smoothness;if(t){if(i.playerCamera.getWorldPosition(d),i.playerCamera.getWorldQuaternion(c),r()){const e=i.cameraData.zoom(),s=(0,Fe.dS)(e,y.thresholdClose,y.thresholdFar,y.offsetClose,y.offsetFar);p.position.copy(t.point).addScaledVector(fe.f.UP,s),p.quaternion.copy(c)}else{const e=(0,Fe.dS)(t.distance,y.thresholdClose,y.thresholdFar,y.offsetClose,y.offsetFar),i=d.sub(t.point).setLength(e).add(t.point);p.position.lerp(i,a),p.lookAt(t.point)}p.updateMatrixWorld(),ie.E0&&this.setOverlay(!1),s.render(e,i.scene.scene,p),ie.E0&&this.setOverlay(!0),u.lerp(l(n),a),s.renderToScreen(e,!1,u,o)}this.editingStateChange=!1}}init(){}dispose(){}activate(){this.sceneInfo.scene.addChild(o.a.Root,this.cursorMesh.container);const e=this.mobile?ie.ox.mobileSize:this.sceneInfo.cameraData.height>ie.ox.highResThreshold?ie.ox.desktopSizeHighRes:ie.ox.desktopSize;this.rttView=this.renderToTexture.createRenderTarget2D(e,e,{format:w.RGBAFormat},!1)}setMeasuringPhase(e){const t=this.mobile?!!ee.Pj.mobile[e]:!!ee.Pj.desktop[e];t!==this.editing&&(this.editingStateChange=!0,this.editing=t,this.cursorMesh.setVisible(this.editing))}deactivate(){this.sceneInfo.scene.removeChild(o.a.Root,this.cursorMesh.container),this.renderToTexture.disposeRenderTarget2D(this.rttView),this.editing=!1}beforeRender(){this.editing&&(this.hit=this.mobile?this.pointer.lastIntersection:this.pointer.getIntersection(),this.hit&&this.cursorMesh.onPositionUpdate(this.hit.point,this.hit.normal))}render(){if(this.editing&&this.hit){const{screenPosition:e}=(0,S.q9)(this.sceneInfo.cameraData,this.hit.point);this.renderIntersection(this.rttView,this.hit,e)}}}var Ne,Ge=i(26269),_e=i(82814),Ue=i(3968);!function(e){e[e.SnapPoint=1]="SnapPoint",e[e.SnapLine=2]="SnapLine",e[e.AxisAny=3]="AxisAny",e[e.AxisX=4]="AxisX",e[e.AxisY=5]="AxisY",e[e.AxisZ=6]="AxisZ",e[e.Mesh=7]="Mesh",e[e.RoomMesh=8]="RoomMesh",e[e.LinePoint=9]="LinePoint",e[e.LineSegment=10]="LineSegment"}(Ne||(Ne={}));class ze extends Ue.FM{constructor(e,t,i){super(e,t),this.featureType=i}}class Ve extends Ue.FM{constructor(e,t,i){super(e,t),this.featureType=i}}const je={[fe.e.UP]:Ne.AxisY,[fe.e.DOWN]:Ne.AxisY,[fe.e.FORWARD]:Ne.AxisZ,[fe.e.BACK]:Ne.AxisZ,[fe.e.LEFT]:Ne.AxisX,[fe.e.RIGHT]:Ne.AxisX,[fe.e.HORIZONTAL_PLANE]:Ne.AxisY,NONE:void 0};var Qe;!function(e){e[e.UserAxis=1]="UserAxis",e[e.UserPoint=2]="UserPoint",e[e.UserLine=3]="UserLine",e[e.ModelFeature=4]="ModelFeature"}(Qe||(Qe={}));const He={[Ne.LinePoint]:Qe.UserPoint,[Ne.LineSegment]:Qe.UserLine,[Ne.AxisAny]:Qe.UserAxis,[Ne.AxisX]:Qe.UserAxis,[Ne.AxisY]:Qe.UserAxis,[Ne.AxisZ]:Qe.UserAxis,[Ne.Mesh]:Qe.ModelFeature,[Ne.RoomMesh]:Qe.ModelFeature,[Ne.SnapLine]:Qe.ModelFeature,[Ne.SnapPoint]:Qe.ModelFeature};class We{constructor(e,t,i,s){this.constraint=t,this.meshQuery=i,this.point=new w.Vector3,this.normal=new w.Vector3,Ye(e,i)?this.updateFromIntersection(e,t):Ze(e,i)&&s&&this.updateFromSnapIntersection(e,t,s),this.source=e}updatePoint(e){return this.point.copy(e),this.source.point.copy(e),this}updateFromIntersection(e,t){return this.source=e,this.updateContents(t,e.point,e.face.normal,e.distance,e.object),this}updateFromSnapIntersection(e,t,i){return this.source=e,this.updateContents(t,e.point,i,e.distance,e.object),this}copy({constraint:e,point:t,normal:i,distance:s,object:n}){this.updateContents(e,t,i,s,n)}clone(){return new We(this.source,this.constraint,this.meshQuery)}updateContents(e,t,i,s,n){this.constraint=e,this.point.copy(t),this.normal.copy(i),this.distance=s,this.object=n;const a=this.meshQuery.roomIdFloorIdFromObject(n);a&&(this.roomId=a.roomId||null,this.floorId=a.floorId),this.featureType=(e=>{if(e)return"featureType"in e&&void 0!==e.featureType?e.featureType:e instanceof w.Vector3||e instanceof Ue.UQ?Ne.SnapPoint:Ge.$4.isRoomMesh(e)?Ne.RoomMesh:e instanceof _e.S?Ne.Mesh:e instanceof w.Line3||e instanceof Ue.FM?Ne.SnapLine:void 0})(n)}}const Ye=(e,t)=>e&&"face"in e&&void 0!==e.face&&(t.floorIdFromObject(e.object)||e.object.floorId),Ze=(e,t)=>e&&"isLineOctreeIntersection"in e&&t.floorIdFromObject(e.object),qe=(()=>{class e extends w.Object3D{constructor(e,t,i,s){super(),this.floorId=e,this.roomId=t,this.meshGroup=i,this.meshSubGroup=s}}return(t,i,s,n,a,r,o)=>({point:t,object:new e(n,a,r,o),face:{a:0,b:1,c:2,normal:i,materialIndex:0},distance:s})})();var Xe=i(83402),Ke=i(38042),$e=i(16769),Je=i(80592),et=i(16782);const tt=e=>e instanceof ve.R?e.button===et.M.PRIMARY:e.buttons===et.r.PRIMARY;class it extends w.Mesh{constructor(e,t,i,s,n,a,r,o,h,l,d,c){super(),this.pointGroups=e,this.input=t,this.cameraData=i,this.mobile=s,this.changeCursor=n,this.getPhase=a,this.changePhase=r,this.restorePreviousPhase=o,this.setSelectedLine=h,this.getSelected=l,this.onDragStart=d,this.onDragEnd=c,this.inputSubscriptions=[],this.groupVisible=[],this.raycast=(()=>{const e=new w.Vector3,t=new w.Vector3,i=new w.Vector3,s=(e,t,i)=>{if(e.isOrtho())return i.copy(t);{const s=A.iV.OFFSET_TOWARDS_CAMERA;return i.copy(e.position).sub(t).setLength(s).add(t)}};return(n,a)=>{const{pose:r,width:o}=this.cameraData,h=this.mobile?3:-2,l=A.V9.lineDefault+h,d=r.projection.asThreeMatrix4(),c=r.position;let u,p=0,g=0;for(let a=0;a<this.pointGroups.groupCount;++a){const h=this.pointGroups.getGroup(a);if(!(void 0!==this.editingGroup&&this.editingGroup!==a)&&this.groupVisible[a]){for(let m=0;m<h.count-1;++m){const y=s(r,h.get(m),t),w=s(r,h.get(m+1),i);if(y&&w){const t=n.ray.distanceSqToSegment(y,w,void 0,e),i=c.distanceTo(e);let s=(0,ge._U)(i,d,o)*l;if(s*=s,t<s){let i,r=e;this.editingPointIndex?i=this.editingPointIndex:y.distanceToSquared(e)<2*s?(i=g,r=y):w.distanceToSquared(e)<2*s&&(i=g+1,r=w),(!u||t<p)&&(u={distance:n.ray.origin.distanceTo(r),point:r,object:this,instanceId:a,index:i},p=t)}}g++}g++}else g+=h.count}u&&a.push(u)}})(),this.inputSubscriptions.push(...this.registerCommonInput()),s||this.inputSubscriptions.push(...this.registerHoverInput()),this.deactivate()}activate(){this.input.registerMesh(this,!1),this.inputSubscriptions.forEach((e=>e.renew()))}deactivate(){this.input.unregisterMesh(this),this.inputSubscriptions.forEach((e=>e.cancel()))}dispose(){this.deactivate()}setEditingGroup(e){this.editingGroup=e}setGroupVisible(e,t){this.groupVisible[e]=t}validJoint(e){return!!e&&void 0!==e.index}registerHoverInput(){return[this.input.registerMeshHandler(be.z,Te.s.isType(it),((e,t,i)=>{this.getPhase()===ee.au.IDLE&&this.changeCursor(i&&void 0!==i.index?h.C.GRAB:h.C.FINGER)})),this.input.registerMeshHandler(be.A,Te.s.isType(it),((e,t,i)=>{this.getPhase()===ee.au.IDLE&&this.changeCursor(h.C.DEFAULT)}))]}registerCommonInput(){return[this.input.registerMeshHandler(ve.R,Te.s.isType(it),((e,t,i)=>{if(!tt(e))return!1;if(this.getPhase()!==ee.au.IDLE)return!1;const s=i&&void 0!==i.instanceId?i.instanceId:-1,n=this.getSelected()===s?-1:s;return this.setSelectedLine(n),!0})),this.input.registerMeshHandler(Je._t,Te.s.isType(it),((e,t,i)=>!!tt(e)&&(!!ee.WN[this.getPhase()]&&(!this.validJoint(i)||(!i||void 0===i.instanceId||(this.getPhase()===ee.au.EDITING||(this.editingPointIndex=i.index,this.onDragStart(i.instanceId),this.setSelectedLine(i.instanceId),this.changePhase(ee.au.EDITING),this.mobile||this.changeCursor(h.C.GRABBING)),!0)))))),this.input.registerMeshHandler(Je._R,Te.s.isType(it),((e,t,i)=>this.getPhase()===ee.au.EDITING&&(this.editingPointIndex=void 0,this.restorePreviousPhase(),this.onDragEnd(),this.mobile||this.changeCursor(h.C.DEFAULT),!0)))]}}const st=new y.Z("snapping");class nt{constructor(e,t,i,s,n,a){this.raycaster=e,this.getConstraintStyle=t,this.floorsViewData=s,this.viewmodeData=n,this.meshQuery=a,this.origin=null,this.planeNormal=new w.Vector3,this.plane=new w.Plane,this.ray=new w.Ray,this.originChangedListeners=[],this.registeredSnapFeatures={[Qe.UserAxis]:[],[Qe.UserLine]:[],[Qe.UserPoint]:[],[Qe.ModelFeature]:[]},this.clearOrigin=()=>{this.origin=null,this.originChangedListeners.forEach((e=>e(null)))},this.setOrigin=(e,t=!1)=>{this.origin&&!t||(this.origin=e,this.plane.setFromNormalAndCoplanarPoint(this.origin.normal,this.origin.point),this.originChangedListeners.forEach((e=>e(this.origin))),st.debug("Updating origin",this.origin,{forceUpdate:t}))},this.setOriginFromPointer=e=>{if(this.origin)return;const t=this.getMeshIntersection();if(!t)return;const i=new We(t,this.getConstraintStyle(),this.meshQuery);e&&i.updatePoint(e),this.setOrigin(i,!0)},this.snapFeatures=e=>this.registeredSnapFeatures[e].reduce(((e,t)=>e.concat(t.features)),[]),this.addSnapFeatures=(e,t,i)=>{const s=He[t];this.registeredSnapFeatures[s].push({owner:e,features:i}),st.debug(`Adding ${i.length} snap feature groups`,Ne[t],t)},this.removeSnapFeatures=(e,t)=>{const i=He[t],s=this.registeredSnapFeatures[i].findIndex((t=>t.owner===e));if(-1!==s){const e=this.registeredSnapFeatures[i].splice(s,1);st.debug(`Removing ${e.length} snap feature groups`,Ne[t],t)}else st.debug(`removeTemporarySnapFeature: ${t} ${Ne[t]} not found from`,e,this.registeredSnapFeatures)},this.filters={nop:e=>!0,isNotMeasurementInput:e=>!(e instanceof it),meshVisible:e=>!!(0,$e.Pv)(e)&&(!this.viewmodeData.isDollhouse()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup)),visibleFloor:e=>{const t=e.object;return!t||!t.meta||null==t.meta.meshGroup||this.floorsViewData.isCurrentMeshGroupOrAllFloors(t.meta.meshGroup)},userPoints:e=>{if(void 0===e.object)return!1;if((t=e.object)&&t instanceof w.Vector3)for(const t of this.snapFeatures(Qe.UserPoint))if(t.equals(e.object))return!0;var t;return!1},userLines:e=>{if(void 0===e.object)return!1;if((t=e.object)&&"isSnapAxisLine3"in t||"isSnapUserLine3"in t||"isSnapLine3"in t||"start"in t&&"end"in t&&"closestPointToPoint"in t){for(const t of this.snapFeatures(Qe.UserLine))if(t.equals(e.object))return!0;for(const t of this.snapFeatures(Qe.UserAxis))if(t.equals(e.object))return!0}var t;return!1},userFeatures:e=>this.filters.userPoints(e)||this.filters.userLines(e)},this.meshSnapRadius=i?ie.Oq.mobile:ie.Oq.desktop}preload(){this.raycaster.snapping.preloadMeshSnapping()}getMeshIntersection(e){let t=[];const i=this.viewmodeData.isFloorplan();if(e&&e.origin&&e.normal)t=this.raycaster.picking.cast(e.origin,e.normal,this.filters.meshVisible);else if(i){const e=this.floorsViewData.getHighestVisibleFloor(),i=new w.Vector3(0,1,0),s=(new w.Plane).setFromNormalAndCoplanarPoint(i,new w.Vector3(0,e.boundingBox.max.y,0)),n=new w.Vector3;if(this.raycaster.pointer.pointerRay.intersectPlane(s,n)){const s=this.raycaster.pointer.pointerRay.origin.distanceTo(n);t=[qe(n,i,s,e.id,null,e.meshGroup,null)]}}else t=this.raycaster.pointer.cast(this.filters.meshVisible);const s=t[0];return Ye(s,this.meshQuery)?s:null}getIntersection(e){const t=this.getMeshIntersection(e);if(!t)return null;this.cachedHit||(this.cachedHit=new We(t,this.getConstraintStyle(),this.meshQuery));const i=this.cachedHit.updateFromIntersection(t,this.getConstraintStyle()),s=this.raycaster.pointer.pointerRay;this.ray.set(s.origin,s.direction),this.planeNormal.copy(i.normal);switch(this.getConstraintStyle()){case Xe.l1.Free:return i;case Xe.l1.Axes:return this.lockToWorldAxes(i);case Xe.l1.PlanarAxes:const e=[...this.snapFeatures(Qe.UserAxis),...this.snapFeatures(Qe.UserLine),...this.snapFeatures(Qe.UserPoint)];return this.softSnapToEdges(i,e,this.filters.userFeatures);case Xe.l1.Edges:const t=[...this.snapFeatures(Qe.UserLine),...this.snapFeatures(Qe.UserPoint)];return this.softSnapToEdges(i,t,this.filters.visibleFloor);case Xe.l1.EdgesAndPlanarAxes:const s=[...this.snapFeatures(Qe.UserAxis),...this.snapFeatures(Qe.UserLine),...this.snapFeatures(Qe.UserPoint)];return this.softSnapToEdges(i,s,this.filters.visibleFloor)}return i}get lastIntersection(){return this.cachedHit}onOriginChanged(e,t=!1){const i={renew:()=>{this.originChangedListeners.push(e)},cancel:()=>{(0,Ke.bX)(this.originChangedListeners,e)}};return t&&i.renew(),i}lockToWorldAxes(e){if(this.origin){const t=(0,Xe.r2)(this.origin.point,e.point,Xe.l1.Axes);return this.cachedHit.copy(e),this.cachedHit.point.copy(t.position),this.cachedHit.constraint="NONE"!==t.axisName?Xe.l1.Axes:Xe.l1.Free,this.cachedHit.featureType=je[t.axisName],this.cachedHit}return e}softSnapToEdges(e,t,i){const s=this.origin?this.origin.point:e.point,n=this.origin?this.origin.normal:e.normal;this.raycaster.snapping.add(...t);const a=this.raycaster.snapping.cast(this.ray,this.meshSnapRadius,s,n).filter(i),r=this.findClosestVisible(a);return this.raycaster.snapping.remove(...t),r?(this.cachedHit.updateFromSnapIntersection(r,this.getConstraintStyle(),n),this.cachedHit):e}findClosestVisible(e){let t=null;const i=new w.Vector3;for(const s of e){i.copy(s.point).sub(this.ray.origin).normalize();const e=this.raycaster.picking.pick(this.ray.origin,i,this.filters.meshVisible);if(!e||e.distance>s.distance-.05){t=s;break}}return t?{isLineOctreeIntersection:!0,distance:t.distance,distanceToRay:t.distanceToRay,point:t.point,object:t.object}:null}}var at=i(80361);class rt{constructor(e,t,i,s){this.points=e,this.createPointSubscription=t,this.pointer=i,this.mobileCreateHackJob=s,this.subscriptions=[],this.lineSegments=[],this.updateSnapping=e=>{this.lineSegments.length>0&&(this.pointer.removeSnapFeatures(this,Ne.LineSegment),this.lineSegments.length=0);for(let t=0;t<this.points.length;t++)if(t!==e&&t!==e-1&&t!==e+1&&!this.points.isStartIndex(t)){const e=this.points.get(t),i=this.points.get(t-1);this.lineSegments.push(new Ve(i,e,Ne.LineSegment))}this.lineSegments.length>0&&this.pointer.addSnapFeatures(this,Ne.LineSegment,this.lineSegments)}}init(){}dispose(){}activate(e){let t=-1,i=-1;const s=(0,at.D)((()=>this.updateSnapping(this.points.length)),16);this.subscriptions.push(this.createPointSubscription(he.ADDED,s,!0),this.createPointSubscription(he.REMOVED,s,!0),this.createPointSubscription(he.UPDATED,((e,s)=>{s===t||this.mobileCreateHackJob()&&s===i||(this.updateSnapping(s),i=t,t=s)}),!0))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Ne.LinePoint),this.pointer.removeSnapFeatures(this,Ne.LineSegment)}beforeRender(){}render(){}}class ot{constructor(e,t,i,s,n,a){this.points=e,this.pointer=i,this.getPhase=s,this.onDrag=n,this.onDragEnd=a,this.inputSubscriptions=[],this.onDragBegin=(e,t,i)=>{if(!ee.q8[this.getPhase()])return!1;if(!i||void 0===i.index)return!1;const s=this.points.isStartIndex(i.index)?i.index+1:i.index-1,n=this.points.get(s);return this.pointer.clearOrigin(),this.pointer.setOriginFromPointer(n),!0},this.onDragEndEvent=()=>!!ee.q8[this.getPhase()]&&(this.onDragEnd(),this.pointer.clearOrigin(),!0),this.onDragEvent=(e,t,i)=>{if(e.buttons!==et.r.PRIMARY)return!1;if(!ee.q8[this.getPhase()])return!1;if(!i||void 0===i.index||void 0===i.instanceId)return!1;const s=this.pointer.getIntersection();return s&&this.points.update(i.index,s.point),this.onDrag(i.instanceId),!0},this.inputSubscriptions.push(t.registerMeshHandler(Je.E0,Te.s.isType(it),this.onDragBegin),t.registerMeshHandler(Je._t,Te.s.isType(it),this.onDragEvent),t.registerMeshHandler(Je._R,Te.s.isType(it),this.onDragEndEvent)),this.deactivate()}activate(){for(const e of this.inputSubscriptions)e.renew()}deactivate(){for(const e of this.inputSubscriptions)e.cancel()}}var ht=i(67678);class lt{constructor(e,t,i,s,n,a,r){this.lines=e,this.getLinesForPoint=t,this.editingMaterial=i,this.createPointSubscription=s,this.getPhase=a,this.getSelected=r,this.bindings=[],this.onDragEnd=e=>{for(const e of this.lines)e.restoreLineMaterial()},this.onClick=(e,t,i)=>{if(this.getPhase()!==ee.au.IDLE)return!1;for(const e of this.lines)e.restoreLineMaterial();if(!i||void 0===i.index)return!1;if(e.down){const e=i.index;void 0!==e&&this.styleLines(e)}return!1},this.styleLines=e=>{const t=this.getLinesForPoint(e);for(const e of t)e.group===this.getSelected()&&e.line.overrideLineMaterial(this.editingMaterial)},this.bindings.push(n.registerMeshHandler(ht.er,Te.s.isType(it),this.onClick),n.registerUnfilteredHandler(Je._R,this.onDragEnd),...this.setupLineStyler(this.createPointSubscription)),this.deactivate()}activate(){for(const e of this.bindings)e.renew()}deactivate(){for(const e of this.bindings)e.cancel()}setupLineStyler(e){return[e(he.ADDED,(()=>{const e=this.lines[this.lines.length-1];e&&e.restoreLineMaterial()}),!0),e(he.UPDATED,((e,t)=>{this.styleLines(t)}),!0)]}}var dt=i(62017),ct=i(67238);class ut{constructor(e,t,i,n,a,r,o,h,l,d){this.points=e,this.setSelected=t,this.pointer=i,this.changePhase=n,this.getPhase=a,this.isFloorplan=r,this.currentFloorId=o,this.currentRoomId=h,this.currentLayerId=l,this.inferRoomAssociation=d,this.id=ut,this.onGroupCreated=e=>null,this.onGroupAddPoint=()=>null,this.onDone=()=>null,this.onEdit=e=>null,this.previousPhase=ee.au.IDLE,this.currentLinePoints=0,this.previousPoint=new w.Vector3,this.inputSubscriptions=[],this.log=new y.Z("measurement-creator"),this.isReadonly=!1,this.createNewLine=e=>{const t=this.inferRoomAssociation(e),i=e.roomId||t.roomId||this.currentRoomId()||void 0,n=e.floorId||t.floorId||this.currentFloorId();if(this.log.debug(`Starting measurement: floorId="${n}" roomId="${i}"`),!n)throw new ct.H(`Cannot create new line on invalid floor '${n}'`);const a={visible:!0,roomId:i,floorId:n,type:this.isFloorplan()?s.FloorplanOnly:s.ThreeD,text:"",created:new Date,modified:new Date,temporary:this.isReadonly,layerId:this.currentLayerId()},r=this.points.startGroup(a);this.currentGroup=r,this.points.push(e.point),this.currentLinePoints=1,this.setSelected(r);const o=this.points.getGroup(r);this.onGroupCreated(o.info.sid),this.pointer.setOrigin(e,!0)},this.addPointToLine=e=>{this.previousPoint.copy(e.point),this.points.push(e.point),++this.currentLinePoints,this.onGroupAddPoint(),this.pointer.setOrigin(e,!0)},this.updateLastPoint=e=>{this.points.update(this.points.length-1,e.point)},this.getIntersection=e=>this.pointer.getIntersection(e),this.setPhase=e=>{const t=this.getPhase();e!==t&&(this.previousPhase=t,this.changePhase(e))},this.restorePreviousPhase=()=>{this.setPhase(this.previousPhase)}}start(){if(this.getPhase()===ee.au.IDLE){this.previousPoint.set(1e3,1e3,1e3),this.setPhase(ee.au.CREATING),this.setSelected(-1);for(const e of this.inputSubscriptions)e.renew()}}cancelSubs(){for(const e of this.inputSubscriptions)e.cancel()}stop(){this.cancelSubs(),this.currentLinePoints=0,this.setSelected(-1),this.setPhase(ee.au.IDLE),this.pointer.clearOrigin(),this.onDone()}syncReadonly(e){this.isReadonly=e}}class pt extends ut{constructor(e,t,i,s,n,a,r,o,h,l,d,c,u,p,g){super(e,t,s,n,h,d,c,u,p,g),this.setCreatePointProgress=a,this.updateCreatePointHit=r,this.toggleCameraMovement=o,this.continuous=l,this.onLongPressSuccess=e=>{this.log.debug("onLongPressSuccess while in phase:",ee.au[this.getPhase()]),this.getPhase()===ee.au.CREATING?(this.createNewLine(e),this.addPointToLine(e)):this.getPhase()===ee.au.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.updateLastPoint(e)),this.setPhase(ee.au.POINT_PLACED)},this.onLongPressStart=e=>{if(e.buttons===et.r.PRIMARY&&(this.getPhase()===ee.au.CREATING||this.getPhase()===ee.au.CREATING_NEXT_POINT)){const e=this.getIntersection();e&&(this.previousPoint.equals(e.point)||(this.setPhase(ee.au.CONFIRMING_POINT),this.toggleCameraMovement(!1),this.setCreatePointProgress(Date.now(),pt.longPressCreateThreshold),this.updateCreatePointHit(e),this.previousPhase===ee.au.CREATING_NEXT_POINT&&(this.updateLastPoint(e),this.toggleLastPointDraggable(!1)),this.creatingPointTimeout=window.setTimeout((()=>{this.restorePreviousPhase(),this.onLongPressSuccess(e),this.toggleLastPointDraggable(!0)}),pt.longPressCreateThreshold)))}},this.onLongPressEnd=()=>{this.getPhase()===ee.au.CONFIRMING_POINT&&(this.log.debug("onLongPressEnd, cancelling confirmation"),this.setCreatePointProgress(0,pt.longPressCreateThreshold),window.clearTimeout(this.creatingPointTimeout),this.toggleCameraMovement(!0),this.restorePreviousPhase()),this.getPhase()===ee.au.CREATING_NEXT_POINT&&this.points.update(this.points.length-1,this.points.get(this.points.length-2)),this.setPlacedtoCreatePhase()},this.onDrag=()=>{const e=this.getIntersection();e&&(this.setPlacedtoCreatePhase(),this.setPhase(ee.au.EDITING),this.previousPhase===ee.au.CREATING_NEXT_POINT?this.updateLastTwoPoints(e):this.previousPhase===ee.au.CREATING&&this.updateLastPoint(e))},this.onDragEnd=()=>{this.getPhase()===ee.au.EDITING&&this.restorePreviousPhase(),this.getPhase()!==ee.au.CREATING&&this.getPhase()!==ee.au.CREATING_NEXT_POINT||(this.toggleLastPointDraggable(!1),this.toggleCameraMovement(!0))},this.toggleLastPointDraggable=e=>{e?(this.dragSub.renew(),this.dragEndSub.renew()):(this.dragSub.cancel(),this.dragEndSub.cancel())},this.updateLastTwoPoints=e=>{this.points.update(this.points.length-1,e.point),this.points.update(this.points.length-2,e.point)},this.dragSub=i(Je._t,this.onDrag),this.dragEndSub=i(Je._R,this.onDragEnd),this.inputSubscriptions.push(i(dt.Vh,this.onLongPressStart),i(dt.pt,this.onLongPressEnd)),this.dragSub.cancel(),this.dragEndSub.cancel(),this.cancelSubs()}start(){super.start()}stop(){if(this.getPhase()===ee.au.CREATING_NEXT_POINT)if(this.continuous())this.points.pop();else{const e=this.points.getGroup(this.currentGroup);this.points.removeFromIdx(e.startIndex)}super.stop()}setPlacedtoCreatePhase(){this.getPhase()===ee.au.POINT_PLACED&&(this.continuous()?(this.previousPhase===ee.au.CREATING||this.previousPhase===ee.au.CREATING_NEXT_POINT)&&this.setPhase(ee.au.CREATING_NEXT_POINT):this.previousPhase===ee.au.CREATING?this.setPhase(ee.au.CREATING_NEXT_POINT):this.previousPhase===ee.au.CREATING_NEXT_POINT&&this.setPhase(ee.au.CREATING))}}pt.longPressCreateThreshold=500;class gt extends ut{constructor(e,t,i,s,n,a,r,o,h,l,d,c,u){super(e,t,s,n,a,r,o,h,l,c),this.continuous=d,this.meshQuery=u,this.onCreate=e=>{const t=this.previousPoint.distanceTo(e.point)>ie.yV;if(t||2!==this.currentLinePoints){if(this.getPhase()===ee.au.CREATING)return this.createNewLine(e),this.addPointToLine(e),void this.setPhase(ee.au.CREATING_NEXT_POINT);t&&this.getPhase()===ee.au.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.finishLine(e))}else{const t={origin:e.point.addScaledVector(e.normal,.05),normal:e.normal},i=this.pointer.getMeshIntersection(t);if(i)if(this.continuous()){this.points.pop();const e=new We(i,Xe.l1.Free,this.meshQuery);this.addPointToLine(e),this.addPointToLine(e),this.setPhase(ee.au.CREATING_NEXT_POINT)}else this.finishLine(new We(i,Xe.l1.Free,this.meshQuery))}},this.onMouseMove=()=>{if(this.getPhase()===ee.au.CREATING_NEXT_POINT){const e=this.getIntersection();e&&this.updateLastPoint(e)}},this.onMouseClick=e=>{if(e.button!==et.M.PRIMARY||this.getPhase()===ee.au.IDLE)return;const t=this.getIntersection();t&&this.onCreate(t)},this.inputSubscriptions.push(i(ht.mE,this.onMouseMove),i(ve.R,this.onMouseClick)),this.cancelSubs()}start(){super.start()}stop(){this.getPhase()===ee.au.CREATING_NEXT_POINT&&(this.points.pop(),this.currentLinePoints<3&&this.points.pop()),super.stop()}finishLine(e){this.points.pop(),this.addPointToLine(e),this.setPhase(ee.au.CREATING),this.onDone()}}var mt=i(10385),yt=i(94046),wt=i(89553),ft=i(89570),vt=i(6667),bt=i(32597),Tt=i(31362),St=i(51180);class Dt{constructor(e,t,i,s,n){this.pointer=e,this.mobile=t,this.getPhase=i,this.scene=s,this.getLayer=n,this.subscriptions=[],this.editing=!1,this.axisLines=[],this.axisAlignmentHelper=new w.Object3D,this.updateSnapping=e=>{if(this.axisLines.length>0&&(this.pointer.removeSnapFeatures(this,Ne.AxisAny),this.axisLines.length=0),e){this.axisAlignmentHelper.position.copy(e.point);const t=(0,ge.J2)(this.axisAlignmentHelper,e.point,e.normal);this.axisAlignmentHelper.updateMatrixWorld(!0);const i=this.axisAlignmentHelper.matrixWorld,s=100,n=(e,t,i,n)=>{const a=new ze(e.clone().multiplyScalar(s),t.clone().multiplyScalar(s),n);return a.applyMatrix4(i),a},a=(new w.Matrix4).copyPosition(i);this.axisLines.push(n(fe.f.UP,fe.f.DOWN,a,Ne.AxisY)),t||this.axisLines.push(n(fe.f.FORWARD,fe.f.BACK,i,Ne.AxisY),n(fe.f.UP,fe.f.DOWN,i,Ne.AxisX),n(fe.f.LEFT,fe.f.RIGHT,i,Ne.AxisZ)),this.axisLines.length>0&&this.pointer.addSnapFeatures(this,Ne.AxisAny,this.axisLines)}}}init(){}dispose(){}activate(){this.subscriptions.push(this.pointer.onOriginChanged(this.updateSnapping,!0)),this.axisLineRenderer=new Pt(this.scene,this.getLayer("cursor-mesh"))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Ne.AxisAny),this.axisLineRenderer.dispose(),this.axisLineRenderer=null}beforeRender(){const e=this.getPhase(),t=this.mobile?!!ee.Pj.mobile[e]:!!ee.Pj.desktop[e];t!==this.editing&&(this.editing=t,this.axisLineRenderer.clearLines())}render(){this.editing&&this.axisLineRenderer.render(this.pointer.lastIntersection,this.axisLines)}}class Pt{constructor(e,t){this.scene=e,this.layer=t,this.offsetFromMesh=.0075,this.featureColors={[Ne.AxisX]:pe.x,[Ne.AxisZ]:pe.z,[Ne.AxisY]:pe.y},this.axesVisibleInConstraints={[Xe.l1.EdgesAndPlanarAxes]:!0,[Xe.l1.Axes]:!0,[Xe.l1.PlanarAxes]:!0},this.linesActive=[],this.linesFree=[],this.axesVisible=[],this.axisMat=new w.LineBasicMaterial({color:4095,linewidth:1,opacity:.75,transparent:!0,depthWrite:!1,depthTest:!0}),this.render=(e,t)=>{if(e&&this.axesVisibleInConstraints[e.constraint]&&t.length>0){if(t.length!==this.axesVisible.length)this.clearLines();else{this.axesVisible.every(((e,i)=>e.equals(t[i])))||this.clearLines()}if(this.container.parent!==this.scene.scene){for(const e of t){const t=this.getMesh(e);t.material.color.setHex(this.featureColors[e.featureType]),this.container.add(t),this.linesActive.push(t)}this.axesVisible=t.map((e=>e)),this.scene.addChild(o.a.Root,this.container),this.container.position.copy(e.normal).multiplyScalar(this.offsetFromMesh),this.container.updateMatrixWorld(!0)}}else this.clearLines()},this.clearLines=()=>{if(0!==this.linesActive.length){for(;this.linesActive.length>0;){const e=this.linesActive.pop();e&&(this.container.remove(e),this.linesFree.push(e))}this.scene.removeChild(o.a.Root,this.container)}},this.container=new w.Object3D}getMesh(e){let t=this.linesFree.pop();return t?t.geometry.setFromPoints([e.start,e.end]):(t=new It(e,this.axisMat.clone()),t.layers.mask=this.layer.mask),t}dispose(){for(this.clearLines();this.linesFree.length>0;){const e=this.linesFree.pop();e&&(this.container.remove(e),e.geometry.dispose(),e.material.dispose())}this.linesActive=[],this.linesFree=[],this.container=null}}class It extends w.Line{constructor(e,t){super(void 0,t),this.material=t,this.geometry=(new w.BufferGeometry).setFromPoints([e.start,e.end])}}var xt=i(79728),Mt=i(90632),Et=i(635),Ct=i(80742),Rt=i(63319),At=i(29474),Lt=i(17788),Ot=i(27553),Ft=i(95548),kt=i(77285),Bt=i(5823);const Nt={[s.FloorplanOnly]:Bt.eR.LINETYPE_2D,[s.ThreeD]:Bt.eR.LINETYPE_3D},Gt={[Bt.eR.LINETYPE_2D]:s.FloorplanOnly,[Bt.eR.LINETYPE_3D]:s.ThreeD};class _t{serialize(e){if(!e)return null;const t=[],{text:i,visible:s,type:n,floorId:a,roomId:r}=e.info;for(const i of e){const e={position:Fe.ep.toVisionVector(i)};a&&(e.floorId=a),r&&(e.roomId=r),t.push(e)}const o={enabled:s,label:i,version:"3.2",lineType:Nt[n]||Bt.eR.LINETYPE_3D,points:t};return this.validate(o)?o:null}validate(e){return!!e&&!(e.points.length<2)}}var Ut=i(9133);const zt=new y.Z("mds-measurement-serializer");class Vt{constructor(){this.points=(0,mt.C)([]),this.grouper=new ae(this.points)}deserialize(e){var t;if(!e||!Array.isArray(e))return zt.debug("No contents",e),null;this.grouper.reset();for(const i of e)if(this.validate(i)){const e=i.lineType||Bt.eR.LINETYPE_3D,s=Gt[e],n=this.getModelContextFromPoint(i.points[0]),a=Object.assign(Object.assign({layerId:(null===(t=i.layer)||void 0===t?void 0:t.id)||"",sid:i.id,text:i.label||"",visible:i.enabled,type:s},n),{created:(0,Ut.p)(i.created),modified:(0,Ut.p)(i.modified),temporary:!1});this.grouper.startGroup(a),i.points.forEach((e=>this.grouper.push(Fe.ep.fromVisionVector(e.position))))}else zt.debug("Deserialized invalid Measurement data from MDS",i);return 0===this.grouper.length?null:this.grouper}validate(e){if(!e||"object"!=typeof e)return!1;const t=["id","points"].every((t=>t in e)),i=e.points&&Array.isArray(e.points)&&e.points.length>0,s=t&&i;return s||zt.debug("Invalid MDS.MeasurementPath:",{hasRequiredFields:t,hasPoints:i,data:e}),s}getModelContextFromPoint(e){return{floorId:e.floor&&e.floor.id?e.floor.id:"",roomId:e.room&&e.room.id?e.room.id:""}}}class jt extends Lt.u{constructor(){super(...arguments),this.serializer=new _t,this.deserializer=new Vt,this.prefetchKey="data.model.measurementPaths"}async read(e){const{readonly:t}=this.config,i={modelId:this.getViewId(),includeDisabled:!t,includeLayers:!!Lt.u.currentLayerId};return this.query(kt.GetMeasurements,i,e).then((e=>{var t,i;if(!Ot.w.isOk(e,"model.measurementPaths"))throw new Ft.Zb("MdsMeasurementModeStore.read failed");return this.deserializer.deserialize(null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.measurementPaths)}))}async create(e){const t=this.getViewId(),i=this.serializer.serialize(e);if(!i)throw new Error("Could not create Measurement");return this.mutate(this.addLayerId(kt.AddMeasurement,e.info.layerId),{modelId:t,data:i}).then((e=>{var t,i;const s=null===(i=null===(t=e.data)||void 0===t?void 0:t.addMeasurementPath)||void 0===i?void 0:i.id;if(!s)throw new Error("Unable to add measurement!");return s}))}async update(e){if(!e||0===e.length)return Promise.resolve();const t=this.getViewId();let i="";const s={};s.modelId=t;let n="";for(const a of e){const e=a.info.sid,r=a.info.layerId,o=this.serializer.serialize(a);if(!o)throw new Error("Could not update Measurement");s[`data${e}`]=o,i+=`, $data${e}: MeasurementPathPatch!`,this.shouldWriteLayerId()&&(n+=`layer${e}: patchLayer(id: "${t}", layerId: "${r}", writable: true) { id }`),n+=`patch${e}: patchMeasurementPath(modelId: $modelId, pathId: "${e}", patch: $data${e}) {\n        id\n      }`}this.shouldWriteLayerId()&&(n+=`layerRestore: patchLayer(id: "${t}", layerId: "${Lt.u.currentLayerId}", writable: true) { id }`);const a=At.Ps`
      mutation PatchMeasurements($modelId: ID! ${i}) {
        ${n}
      }
    `;return this.mutate(a,s).then((()=>{}))}async delete(...e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const s of e){const{pathId:e,layerId:n}=s;this.shouldWriteLayerId()&&(i+=`layer${e}: patchLayer(id: "${t}", layerId: "${n}", writable: true) { id }`),i+=`delete${e}: deleteMeasurementPath(modelId: $modelId, pathId: "${e}")`}this.shouldWriteLayerId()&&(i+=`layerRestore: patchLayer(id: "${t}", layerId: "${Lt.u.currentLayerId}", writable: true) { id }`);const s=At.Ps`
      mutation DeleteMeasurements($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:t}).then((()=>{}))}}var Qt=i(28269),Ht=i(71954),Wt=i(89549),Yt=i(76631),Zt=i(79232),qt=i(33824),Xt=i(35221),Kt=i(56163);class $t extends Kt.K{constructor(e,t,i,s,n,a){super(e,t),this.group=i,this.units=s,this.typeId=a,this.id=this.group.info.sid,this.title=$t.getTitle(this.group,this.units),this.description=this.textParser.getPlainText(this.group.info.text),this.icon="icon-tape-measure",this.floorId=this.group.info.floorId,this.layerId=this.group.info.layerId,this.enabled=this.group.info.visible,this.dateBucket=(0,Xt.f)(this.group.info.created),this.onSelect=async()=>{super.onSelect(),this.commandBinder.issueCommand(new K.l(this.id))},this.textParser=n}static getTitle(e,t){let i=R(e.length,t);if(e.count>2){i=`${i} (${e.segmentLengths.map((e=>R(e,t))).join(", ")})`}return i}}var Jt=i(52528),ei=i(71166),ti=i(38399);const{MEASUREMENTS:ii}=ti.Z.SHOWCASE,si=new Jt.v({});class ni extends n.Y{constructor(){super(),this.name="measurement-mode",this.mutationRecord={[Ht.KI.added]:new Set,[Ht.KI.updated]:new Set,[Ht.KI.removed]:new Set},this.removedLayerMap=new Map,this.store=null,this.newDataBinding=null,this.longPressStart=Date.now(),this.threshold=800,this.lineSidToPointMap={},this.mobile=!1,this.cameraAndDragBlocked=!1,this.blockNavigation=()=>!1,this.visibilityFilter=O,this.visibilityFilterEnabled=!1,this.trashEnabled=!1,this.editable=!0,this.changeCursor=e=>{this.engine.commandBinder.issueCommand(new d.u(e))},this.onEdit=e=>{const t=this.data.getGroupInfo(e),i=t&&t.info.sid||null;this.data.editingGroupId!==i&&(this.data.editingGroupId=i,this.colliders.setEditingGroup(e))},this.onEditEnd=()=>{if(this.data.editingGroupId){const e=this.pointGroups.getGroupById(this.data.editingGroupId);e&&(this.mutationRecord.updated.add(e.info.sid),this.save(),this.engine.broadcast(new St.av(this.buildAnalyticsMessageFromGroup(e))))}this.data.editingGroupId=null,this.colliders.setEditingGroup(void 0)},this.onCreatorAddNewLine=e=>{this.log.debug("onCreatorAddNewLine",e),this.data.creatingGroupId=e},this.onCreatorAddPoint=()=>{if(this.data.creatingGroupId){this.log.debug("onCreatorAddNewSegment",this.data.creatingGroupId);const e=this.pointGroups.getGroupById(this.data.creatingGroupId);if(e&&e.count>1&&e.length>0){const t=this.buildAnalyticsMessageFromGroup(e);this.engine.broadcast(new St.rf(Object.assign(Object.assign({},t),{startPosition:this.pointGroups.get(e.startIndex),endPosition:this.pointGroups.get(e.endIndex)})))}}},this.onCreatorStop=()=>{if(this.data.creatingGroupId){const e=this.pointGroups.getGroupById(this.data.creatingGroupId);e&&(e.count>1&&e.hasLength()?(this.engine.broadcast(new St.u6(Object.assign({},this.buildAnalyticsMessageFromGroup(e)))),this.mutationRecord.added.add(e.info.sid),this.save()):this.engine.broadcast(new St.ff))}this.data.creatingGroupId=null},this.onToggleMeasurementMode=async(e,t,i)=>{this.toggleMeasuringMode(e,i),await this.engine.commandBinder.issueCommand(new $.I(e&&t))},this.onViewmodeChange=()=>{this.getPhase()!==ee.au.CLOSED&&this.stopMeasuring()},this.onSweepChange=()=>{const e=this.getPhase();e!==ee.au.CREATING&&e!==ee.au.CREATING_NEXT_POINT&&this.setSelected(-1)},this.initStorageOnApplicationChange=async()=>{var e;const t=this.loadSavedMeasurements();this.data.modeActive()&&this.engine.commandBinder.issueCommand(new _.O(!1)),this.store&&t&&!this.newDataBinding?this.newDataBinding=this.store.onNewData((async e=>{this.getPhase()!==ee.au.CLOSED&&this.stopMeasuring(),this.loadSavedMeasurements()?this.replaceContents(null==e?void 0:e.groups()):this.replaceContents(),this.clearMutationRecord(),this.configureTrash()})):this.newDataBinding&&!t&&(this.newDataBinding.cancel(),this.newDataBinding=null),t&&await(null===(e=this.store)||void 0===e?void 0:e.refresh())},this.getPhase=()=>this.data.phase,this.toggleCameraMovement=e=>{e||this.cameraAndDragBlocked?e&&this.cameraAndDragBlocked&&(this.dragInterceptor.cancel(),this.navigation.removeNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!1):(this.dragInterceptor.renew(),this.navigation.addNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!0)},this.getConstraint=()=>this.settings.tryGetProperty(N.F.MeasurementSnapping,!1)?this.viewmodeData.isFloorplan()?ie.xh.floorplan:this.constraint:ie.xh.disabled,this.getSelected=()=>this.data.selectedGroupIndex,this.setSelected=e=>{this.data.selectedGroupIndex!==e&&this.data.setSelectedGroupIndex(e)},this.setSelectedById=e=>{if(null===e)this.setSelected(-1);else{const t=this.pointGroups.getGroupById(e);t&&this.setSelected(t.index)}},this.deleteSelectedMeasurement=()=>{-1!==this.data.selectedGroupIndex&&(this.deleteMeasurement(this.data.selectedGroupIndex),this.setSelected(-1),this.changePhase(ee.au.IDLE),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new d.u(h.C.DEFAULT))))},this.deleteMeasurementBySids=async e=>{const t=e.sids;for(const i of t){const t=this.pointGroups.getGroupById(i);if(!t)throw this.log.error("Measurement delete failed",Object.assign({},e)),Error("Measurement delete failed, not found");this.deleteMeasurement(t.index,!0)}this.save()},this.onToggleContinuous=()=>{this.stopMeasuring()},this.changePhase=e=>{this.getPhase()!==e&&(this.log.debug(`Phase Change: ${ee.au[this.getPhase()]} -> ${ee.au[e]}`),this.previousPhase=this.getPhase(),this.data.setPhase(e))},this.restorePreviousPhase=()=>{this.changePhase(this.previousPhase)},this.onPhaseChange=e=>{if(this.intersectionVisualizer.setMeasuringPhase(e),this.previousPhase!==e)switch(e){case ee.au.CLOSED:case ee.au.IDLE:this.engine.broadcast(new J.ps(!0));break;case ee.au.EDITING:case ee.au.CREATING:case ee.au.POINT_PLACED:case ee.au.CREATING_NEXT_POINT:case ee.au.CONFIRMING_POINT:this.engine.broadcast(new J.ps(!1))}},this.buildAnalyticsMessage=e=>{const t=this.pointGroups.getGroup(e);return t&&t.hasLength()?this.buildAnalyticsMessageFromGroup(t):null},this.buildAnalyticsMessageFromGroup=e=>{const t=this.viewmodeData.isFloorplan()?s[s.FloorplanOnly]:s[s.ThreeD];return Object.assign(Object.assign({sid:e.info&&e.info.sid?e.info.sid:e.describe(),totalLength:e?e.length:0,segments:e?e.count:0,temporary:!!e.info.temporary,viewmode:this.viewmodeData.currentMode,floorId:e.info.floorId,continuous:this.settings.tryGetProperty(N.F.MeasurementContinuousLines,!1)},this.getAnalyticsForConstraints()),{type:t})},this.getAnalyticsForConstraints=()=>{const e=this.pointer.lastIntersection;if(e){const t=e.featureType,i=e.constraint;return{featureType:void 0!==t?Ne[t]:"None",constraint:Xe.l1[i]}}return null},this.toggleMeasuringMode=(e,t)=>{this.log.debug("toggleMeasuringMode",e);e!==(this.getPhase()!==ee.au.CLOSED)&&(e?(this.editable=t,this.engine.toggleRendering(this,!0),this.changePhase(ee.au.IDLE),this.lineStyler.activate(),this.renderer.activate(),this.textRenderer.activate(),this.editable&&(this.editor.activate(),this.colliders.activate(),this.textRenderer.activateInteraction()),this.scene.addChild(o.a.Root,this.textRenderer.container),this.engine.broadcast(new St.$n(!0,this.viewmodeData.currentMode,this.pointGroups.groupCount)),this.pointer.preload()):(this.engine.toggleRendering(this,!1),this.stopMeasuring(),this.changePhase(ee.au.CLOSED),this.toggleCameraMovement(!0),this.editable&&(this.editor.deactivate(),this.colliders.deactivate(),this.textRenderer.deactivateInteraction()),this.lineStyler.deactivate(),this.renderer.deactivate(),this.textRenderer.deactivate(),this.scene.removeChild(o.a.Root,this.textRenderer.container),this.engine.broadcast(new St.$n(!1,this.viewmodeData.currentMode,this.pointGroups.groupCount))))},this.startMeasuring=()=>{this.mobile||(this.navigation.addNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new d.u(h.C.XHAIR))),this.creator.start()},this.stopMeasuring=()=>{const e=this.isMeasurementComplete(this.data.selectedGroupIndex);this.isCreating()&&!e&&this.deleteSelectedMeasurement(),this.creator.stop(),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new d.u(h.C.DEFAULT)))},this.setupIntersectionVisuals=(e,t,i,s,n,a,r,o)=>{t.addVisibilityRule((()=>{const e=this.getPhase();return!(!a&&e===ee.au.CREATING||e===ee.au.CONFIRMING_POINT||e===ee.au.CREATING_NEXT_POINT||e===ee.au.EDITING)}));const h={cameraData:s,playerCamera:i.camera,scene:i};return new Be(a,n,h,e,r,this.engine.commandBinder.issueCommand,o.isFloorplan)},this.renameMeasurement=async e=>{const t=this.pointGroups.getGroupById(e.sid);if(!t)throw this.log.error("Measurement rename failed",Object.assign({},e)),Error("Measurement rename failed, not found");const i=void 0!==e.text&&e.text.length<=24;if(!t||!i)throw this.log.error("Measurement text invalid, text must be between 0 and 24 charachters in length.",Object.assign({},e)),new Error("Measurement text invalid");{const i=""===t.info.text&&e.text.length>0,s=!i&&t.info.text!==e.text;this.pointGroups.updateGroupInfo(t.index,Object.assign(Object.assign({},t.info),{text:e.text})),this.mutationRecord.updated.add(t.info.sid),this.save(),i&&this.engine.broadcast(new St.ty(e.sid,e.text)),s&&this.engine.broadcast(new St.mM(e.sid,t.info.text,e.text))}},this.onChangeVisibility=async e=>{for(const t of e.sids){const i=this.pointGroups.getGroupById(t);if(!i)throw this.log.error("Measurement visibility toggle failed",Object.assign(Object.assign({},e),{group:i})),new Error("Measurement visibility toggle failed, not found");{this.pointGroups.updateGroupInfo(i.index,Object.assign(Object.assign({},i.info),{visible:e.visible})),this.mutationRecord.updated.add(i.info.sid);const t=this.buildAnalyticsMessage(i.index);t&&this.engine.broadcast(new St.av(t))}}this.save()},this.filterVisibility=async e=>{const t={};e.sids.forEach((e=>{const i=this.pointGroups.getGroupById(e);if(i)for(let e=i.startIndex;e<=i.endIndex;e++){const s=i.describe(e);t[s]=!0}})),this.visibilityFilter=e=>{let i=!!t[e];if(!i&&this.data.creatingGroupId){const t=this.pointGroups.getGroupById(this.data.creatingGroupId);if(t)for(let s=t.startIndex;s<=t.endIndex&&!i;s++)t.describe(s)===e&&(i=!0)}return{lineVisibleByFeatureType:i,labelVisibleByFeatureType:i}},this.visibilityFilterEnabled&&this.lineDerivedDataFactory.setVisibilityFilter(this.visibilityFilter)},this.changeVisibilityFilterEnabled=async e=>{const{enabled:t}=e;this.visibilityFilterEnabled=t,t?this.lineDerivedDataFactory.setVisibilityFilter(this.visibilityFilter):this.lineDerivedDataFactory.resetVisibilityFilter()},this.clearMutationRecord=this.clearMutationRecord.bind(this),this.deleteMeasurement=this.deleteMeasurement.bind(this),this.replaceContents=this.replaceContents.bind(this),this.navigateToMeasurement=this.navigateToMeasurement.bind(this)}async init(e,t){const{readonly:i,baseUrl:s}=e;this.config=e,this.mobile=(0,Tt.tq)(),this.engine=t;const[n,o,h,l,d,c,m,y,w,f]=await Promise.all([t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.getModuleBySymbol(a.y.RENDER_TO_TEXTURE),t.getModuleBySymbol(a.y.INPUT),t.getModuleBySymbol(a.y.LINES),t.getModuleBySymbol(a.y.RAYCASTER),t.market.waitForData(p.c),t.market.waitForData(u.M),t.market.waitForData(g.O),t.market.waitForData(G.Z),t.market.waitForData(Qt.Z)]);this.settings=await t.market.waitForData(k.e),this.playerOptions=await t.market.waitForData(B.af),this.layersData=await t.market.waitForData(Ct.R),this.scene=n.getScene(),this.viewmodeData=y,this.floorsViewData=c,this.roomData=f,this.input=h,this.navigation=await t.getModuleBySymbol(a.y.NAVIGATION),this.meshQueryModule=await t.getModuleBySymbol(a.y.MESH_QUERY);const b=await t.getModuleBySymbol(a.y.STORAGE);this.applicationData=await t.market.waitForData(v.pu),this.lineDerivedDataFactory=new F(m,y,c,this.layersData,this.applicationData,(()=>!!w.currentSweep&&w.isSweepAligned(w.currentSweep)),(()=>this.settings.tryGetProperty(N.F.UnitType,T.M.IMPERIAL)),(()=>!0));const S=t.claimRenderLayer(this.name);this.data=new te.X,t.market.register(this,te.X,this.data);const D=(0,mt.C)([]);this.pointGroups=new ae(D);const P=(e,t,i=!1)=>ue(D,e).createSubscription(t,i);this.dataSubscription=D.onChanged((()=>{this.data.repopulate(this.pointGroups.groups()),this.data.commit()})),this.store=new jt({readonly:i,baseUrl:s});const I=await t.market.waitForData(Mt.Q);i||(I.setRevertableType(xt.g.MEASUREMENTS),I.setPublishableType(xt.g.MEASUREMENTS)),this.constraint=this.mobile?ie.xh.mobile:ie.xh.desktop,this.pointer=new nt(d,this.getConstraint,this.mobile,this.floorsViewData,this.viewmodeData,this.meshQueryModule);const x=new rt(this.pointGroups,P,this.pointer,(()=>{const e=this.settings.tryGetProperty(N.F.MeasurementContinuousLines,!1),t=this.getPhase()===ee.au.CREATING||this.getPhase()===ee.au.CREATING_NEXT_POINT||this.previousPhase===ee.au.CREATING_NEXT_POINT&&this.getPhase()===ee.au.EDITING;return e&&this.mobile&&t}));t.addComponent(this,x);const M=new Dt(this.pointer,this.mobile,this.getPhase,this.scene,t.getRenderLayer);t.addComponent(this,M),this.creator=this.instantiateCreator(m),this.initStorageOnApplicationChange();const E=(e,t,i)=>{const s=this.pointGroups.getGroup(e),n=s.describe(i);this.lineSidToPointMap[n]=i;const a=this.lineDerivedDataFactory.get(n);return this.lineDerivedDataFactory.make(n,(()=>({start_position:this.pointGroups.get(t),end_position:this.pointGroups.get(i),visible:s.info.visible,floorId:s.info.floorId,roomId:s.info.roomId,layerId:s.info.layerId,type:s.info.type,text:this.pointGroups.isStartIndex(t)?s.info.text:""})),a)};this.renderer=new ye(this.pointGroups,P,m,l,S,t.claimRenderLayer("measure-lines"),this.getSelected,E),await t.addComponent(this,this.renderer);const C=new r.uc({color:"black",background:!0,backgroundColor:"#ffffff",backgroundColliderType:Se});this.textRenderer=new De(this.pointGroups,h,this.mobile,m,S,Le.z.labels,C,E,this.changeCursor,this.getPhase,this.setSelected),await t.addComponent(this,this.textRenderer),this.editor=new ot(this.pointGroups,h,this.pointer,this.getPhase,this.onEdit,this.onEditEnd),this.colliders=new it(this.pointGroups,this.input,m,this.mobile,this.changeCursor,this.getPhase,this.changePhase,this.restorePreviousPhase,this.setSelected,this.getSelected,this.onEdit,this.onEditEnd),this.lineStyler=new lt(this.renderer.lines,this.renderer.getLinesForPoint,this.renderer.dottedMaterial,P,this.input,this.getPhase,this.getSelected);const[R]=await Promise.all([t.getModuleBySymbol(a.y.CURSOR_CONTROLLER)]);this.intersectionVisualizer=this.setupIntersectionVisuals(o,R,this.scene,m,this.pointer,this.mobile,t.getRenderLayer,this.viewmodeData),t.addComponent(this,this.intersectionVisualizer),this.dragInterceptor=new ft.V(this.input.registerPriorityHandler(Je._t,_e.S,(()=>!0)),this.input.registerPriorityHandler(Je._t,yt.i,(()=>!0))),this.dragInterceptor.cancel(),this.mobile||this.bindings.push(...this.hotkeys()),this.bindings.push(this.applicationData.onPropertyChanged("application",this.initStorageOnApplicationChange),y.makeModeChangeSubscription(this.onViewmodeChange),w.makeSweepChangeSubscription(this.onSweepChange),t.commandBinder.addBinding(_.O,(async e=>{this.onToggleMeasurementMode(e.on,e.dimWhileActive,e.editable)})),t.commandBinder.addBinding(U.c,(async()=>this.startMeasuring())),t.commandBinder.addBinding(V,(async e=>this.setSelected(e.index))),t.commandBinder.addBinding(Q.B,(async()=>this.stopMeasuring())),t.commandBinder.addBinding(H.Ev,(async()=>this.deleteSelectedMeasurement())),t.commandBinder.addBinding(H.Tn,(async e=>this.deleteMeasurement(e.index))),t.commandBinder.addBinding(j,(async e=>this.setSelectedById(e.sid))),t.commandBinder.addBinding(W.W,this.onChangeVisibility),t.commandBinder.addBinding(Y.R,this.renameMeasurement),t.commandBinder.addBinding(H.JM,this.deleteMeasurementBySids),t.commandBinder.addBinding(Z,(async e=>{var t;return this.replaceContents(null===(t=e.points)||void 0===t?void 0:t.groups())})),t.commandBinder.addBinding(q,this.filterVisibility),t.commandBinder.addBinding(X,this.changeVisibilityFilterEnabled),t.commandBinder.addBinding(K.l,this.navigateToMeasurement),this.dataSubscription,this.settings.onPropertyChanged(N.F.MeasurementContinuousLines,(()=>this.onToggleContinuous())),b.onSave((()=>this.saveDiff()),{dataType:xt.g.MEASUREMENTS}),this.layersData.onPropertyChanged("currentViewId",(()=>this.updateSettings())),this.data.onPhaseChanged(this.onPhaseChange)),t.toggleRendering(this,!1),this.updateSettings(),this.registerDebugSettings(),async function(e,t,i,s){const n=await e.market.waitForData(v.pu),a=(a,r,o=[])=>{const h=s.tryGetProperty(N.F.UnitType,T.M.METRIC),l=[],d=n.application===v.Mx.WORKSHOP,c=t.groups(),u=[];for(const t of c)if(t.info.visible||d){const s=$t.getTitle(t,h),n=si.getPlainText(t.info.text);0===o.length&&a(s,n)&&(u.push(t.info.sid),l.push(new $t(e.commandBinder,i,t,h,si,ie.FP)))}return e.commandBinder.issueCommand(new q(u)),l};let r=t.modeActive();const o=i=>{i?(r=t.modeActive(),e.commandBinder.issueCommand(new _.O(!0,!1))):e.commandBinder.issueCommand(new _.O(r,!1)),e.commandBinder.issueCommand(new X(i))},h=e=>new ft.V(t.onDataChanged(e),s.onPropertyChanged(N.F.UnitType,e),i.onChanged(e)),l={renew:()=>{e.commandBinder.issueCommandWhenBound(new ei.c6({id:ie.FP,groupPhraseKey:ii.SEARCH_GROUP_HEADER,getSimpleMatches:a,registerChangeObserver:h,onSearchActivatedChanged:o,groupOrder:40,groupIcon:"tape-measure"}))},cancel:()=>{e.commandBinder.issueCommandWhenBound(new ei.Pe(ie.FP))}},d=()=>{const e=n.application===v.Mx.WORKSHOP;s.tryGetProperty(B.gx.Measurements,!0)||e?l.renew():l.cancel()},c=n.onPropertyChanged("application",d),u=s.onPropertyChanged(B.gx.Measurements,d);return d(),new ft.V(l,c,u)}(t,this.data,this.layersData,this.settings).then((e=>this.bindings.push(e)))}replaceContents(e){this.lineDerivedDataFactory.clear();for(let e=this.pointGroups.groupCount;e>=0;e--){const t=this.pointGroups.getGroup(e);this.layersData.isInMemoryLayer(t.info.layerId)||this.pointGroups.removeGroup(e)}e&&this.pointGroups.copy(e,!1)}loadSavedMeasurements(){return this.config.readonly=this.applicationData.application!==v.Mx.WORKSHOP,this.creator.syncReadonly(this.config.readonly),!this.config.readonly||this.playerOptions.options.measurements_saved}isCreating(){const e=this.getPhase();return e===ee.au.CREATING||e===ee.au.CREATING_NEXT_POINT}setConstraintStyle(e){this.log.debug("setConstraintStyle:",Xe.l1[e]),this.constraint=e}deleteMeasurement(e,t=!1){const i=this.buildAnalyticsMessage(e);i&&this.engine.broadcast(new St.$Z(Object.assign(Object.assign({},i),{count:this.pointGroups.groupCount-1})));const s=this.pointGroups.getGroup(e);if(s){const{sid:i,layerId:n}=s.info;this.pointGroups.removeGroup(e),i!==this.data.creatingGroupId&&(this.layersData.isInMemoryLayer(n)||(this.mutationRecord.removed.add(i),this.removedLayerMap.set(i,n),t||this.save()))}}isMeasurementComplete(e){if(-1===e||!this.isCreating())return!0;const t=this.getPhase(),i=this.pointGroups.getGroup(e);return this.settings.tryGetProperty(N.F.MeasurementContinuousLines,!1)?i.count>2&&t===ee.au.CREATING_NEXT_POINT:i.count>=2&&t===ee.au.CREATING}hotkeys(){return[this.input.registerHandler(wt.e,(e=>{if(e.state===vt.M.PRESSED)switch(e.key){case bt.R.ESCAPE:this.getPhase()===ee.au.CONFIRMING_POINT?(this.creator.stop(),this.creator.start(),this.changePhase(ee.au.CREATING)):this.isCreating()?this.stopMeasuring():this.applicationData.application!==v.Mx.WORKSHOP&&this.getPhase()!==ee.au.CLOSED&&this.engine.commandBinder.issueCommand(new Wt.tT(Yt.w1.MEASUREMENTS,!1));break;case bt.R.BACKSPACE:case bt.R.DELETE:this.getPhase()!==ee.au.CLOSED&&this.getPhase()!==ee.au.EDITING&&this.deleteSelectedMeasurement();break;case bt.R.RETURN:const e=this.pointGroups.groupCount-1;this.isMeasurementComplete(e)&&this.stopMeasuring()}})),this.input.registerHandler(wt.e,(e=>{if(e.key===bt.R.SHIFT||e.key===bt.R.ALT){const{altKey:t,shiftKey:i}=e.modifiers,s=i&&t?ie.xh.shiftAlt:t?ie.xh.alt:i?ie.xh.shift:ie.xh.desktop;this.setConstraintStyle(s)}}))]}onUpdate(e){if(this.getPhase()===ee.au.CLOSED)return;const t=this.data.selectedGroupIndex,i=this.mobile?ee.Ph.mobile[this.getPhase()]:ee.Ph.desktop[this.getPhase()];for(const s in this.lineSidToPointMap){const n=this.lineDerivedDataFactory.get(s);if(n){n.opacity.tick(e);const a=this.lineSidToPointMap[s],r=this.pointGroups.groupFromPointIndex(a),o=r===t&&n.visible?1:n.opacity.value,h=i&&!n.labelVisible?0:o;this.textRenderer.setTextOpacityByPoint(a,h),this.renderer.setLineOpacityByPoint(a,o),-1!==r&&this.colliders.setGroupVisible(r,o>0)}}if(this.mobile)if(this.getPhase()===ee.au.CONFIRMING_POINT){const e=(Date.now()-this.longPressStart)/this.threshold;e<=1&&this.data.setPressProgress(e)}else if(this.getPhase()===ee.au.CREATING&&0!==this.data.pressProgress){const e=0;this.data.setPressProgress(e)}}dispose(){var e,t;this.data.modeActive()&&(this.stopMeasuring(),this.engine.commandBinder.issueCommand(new _.O(!1))),this.colliders.dispose(),this.textRenderer.dispose(),this.renderer.dispose(),this.engine.disposeRenderLayer(this.name),null===(e=this.store)||void 0===e||e.dispose(),this.store=null,null===(t=this.newDataBinding)||void 0===t||t.cancel(),this.newDataBinding=null,super.dispose(this.engine)}clearMutationRecord(){for(const e of Object.values(this.mutationRecord))e.clear()}async save(){if(!this.config.readonly)return this.engine.commandBinder.issueCommand(new Et.VQ({dataTypes:[xt.g.MEASUREMENTS]}));this.clearMutationRecord()}async saveDiff(){var e,t;if(this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged(),this.config.readonly||!this.store)return void this.clearMutationRecord();const i=this.mutationRecord,s=[];this.log.debug("MDS mutation ops:",`{\n      added: '${[...i.added.keys()]}',\n      updated: '${[...i.updated.keys()]}',\n      removed: '${[...i.removed.keys()]}',\n    }`);const n=[];for(const e of i[Ht.KI.removed]){if(i[Ht.KI.added].has(e))i[Ht.KI.added].delete(e);else{const t=this.removedLayerMap.get(e);n.push({pathId:e,layerId:t})}i[Ht.KI.updated].delete(e)}this.removedLayerMap.clear();const a=this.store.delete(...n);s.push(a);for(const t of i[Ht.KI.added]){if(this.layersData.isInMemoryLayer(null===(e=this.data.getGroupInfoBySid(t))||void 0===e?void 0:e.info.layerId))continue;const n=this.pointGroups.getGroupById(t);if(n){const e=this.store.create(n).then((e=>{e&&(this.log.debug(`Updating group id for new path: ${n.info.sid} -> ${e}`),this.pointGroups.updateGroupInfo(n.index,Object.assign(Object.assign({},n.info),{sid:e}))),this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged()}));s.push(e)}i[Ht.KI.updated].delete(t)}const r=[];for(const e of i[Ht.KI.updated]){if(this.layersData.isInMemoryLayer(null===(t=this.data.getGroupInfoBySid(e))||void 0===t?void 0:t.info.layerId))continue;const i=this.pointGroups.getGroupById(e);i&&r.push(i)}const o=this.store.update(r);return s.push(o),this.clearMutationRecord(),Promise.all(s)}async registerDebugSettings(){const e=await this.engine.getModuleBySymbol(a.y.SETTINGS);e.registerMenuEntry({header:"Measurement Debug",setting:"measure/fp_in_dh",initialValue:()=>!1,onChange:t=>(this.lineDerivedDataFactory.setDollhouseLineStyle(t?s.FloorplanOnly:s.ThreeD),e.updateSetting("measure/fp_in_dh",t))})}updateSettings(){const e=this.layersData.getCurrentView(),t=(null==e?void 0:e.viewType)===Rt.X.TRUEPLAN,i=this.settings.tryGetProperty(ie.Ql,!0),s=t||i;this.settings.setProperty(ie.Ql,s)}instantiateCreator(e){let t;const i=e=>{const t={floorId:e.floorId||"",roomId:e.roomId||""};return this.meshQueryModule.inferMeshIdsFromPoint(t,e.point),t};if(this.mobile){const s=(e,t)=>{this.longPressStart=e,this.threshold=t},n=t=>{const i=(0,S.q9)(e,t.point);this.data.setPointPosition(i.screenPosition)};t=new pt(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,s,n,this.toggleCameraMovement,this.getPhase,(()=>this.settings.tryGetProperty(N.F.MeasurementContinuousLines,!1)),this.viewmodeData.isFloorplan,(()=>this.floorsViewData.getHighestVisibleFloorId()),(()=>this.roomData.selected.value),(()=>this.layersData.activeLayerId),i)}else t=new gt(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,this.getPhase,this.viewmodeData.isFloorplan,(()=>this.floorsViewData.getHighestVisibleFloorId()),(()=>this.roomData.selected.value),(()=>this.layersData.activeLayerId),(()=>this.settings.tryGetProperty(N.F.MeasurementContinuousLines,!1)),i,this.meshQueryModule);return t.onGroupCreated=this.onCreatorAddNewLine,t.onGroupAddPoint=this.onCreatorAddPoint,t.onEdit=this.onEdit,t.onDone=this.onCreatorStop,t.syncReadonly(this.config.readonly),t}async configureTrash(){const{readonly:e}=this.config;if(this.trashEnabled||e)return;const{commandBinder:t}=this.engine,i=xt.g.MEASUREMENTS,s={objectType:i,create:e=>new Zt.F({label:e.label||"Measurement",objectId:e.id,objectType:i,created:new Date,value:e}),restore:e=>{}};this.trashEnabled=!0;const n=await t.issueCommandWhenBound(new qt.B(s));this.bindings.push(n)}async navigateToMeasurement({groupId:e}){const{commandBinder:t}=this.engine,i=this.data.getGroupInfoBySid(e);if(!i)return;const n=[];for(const e of i)n.push(e);const a=this.floorsViewData.isCurrentOrAllFloors(i.info.floorId),r=(new w.Box3).setFromPoints(n),o={mode:i.info.type===s.FloorplanOnly?m.Ey.Floorplan:m.Ey.Dollhouse,transition:l.n.Interpolate};try{a||await t.issueCommand(new c.Vw(i.info.floorId)),await this.navigation.focus(r,o),this.setSelectedById(e)}catch(e){this.log.info("Unable to navigateToMeasurement:",e)}}}const ai=ni},7402:(e,t,i)=>{"use strict";i.d(t,{g:()=>l});var s=i(84428),n=i(17878),a=i(56512),r=i(82814),o=i(12529),h=i(53203);class l extends r.S{constructor(e,t,i=n.o.ALL){super(),this._opacity=1,this._chunks=[],this.size=new s.Vector3,this.center=new s.Vector3,this.built=!1,this.layers.mask=i.mask,this.name=`RoomMesh:${e}-${t}`,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=o.z.default,this.onBeforeRender=(e,t,i,s,n,a)=>{this.updateUniforms(n,a)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const e=(0,a.qf)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((i,s)=>{i.geometry&&i.geometry.index&&(e.addGroup(t,i.geometry.index.count,s),t+=i.geometry.index.count,i.geometry.dispose(),i.geometry=e,i.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[s]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithTileChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:i,lod:s}=e;this.name=`RoomMesh:${s}-${t}-${i}-${e.chunkIndex}`,this.meshGroup=t,this.meshSubgroup=i,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof s.RawShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,a.A5)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>h.xx.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<h.xx.FADE_OPAQUE?o.z.ghostFloor:o.z.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}},14564:(e,t,i)=>{"use strict";i.d(t,{u:()=>r});var s,n,a=i(19663);!function(e){e.all="all",e.byMeshGroup="byMeshGroup",e.byMeshSubGroup="byMeshSubGroup"}(s||(s={})),function(e){e.explicit="explicit",e.random="random"}(n||(n={}));class r extends a.m{constructor(e,t){super(),this.id="SET_MESH_OVERLAY_COLOR",this.payload={selectBy:(null==t?void 0:t.style)||s.all,colorStyle:(null==e?void 0:e.style)||n.explicit,color:(null==e?void 0:e.color)||null,alpha:(null==e?void 0:e.alpha)||.5,index:null==t?void 0:t.index}}}r.selectBy=s,r.colorBy=n,r.COLOR_DIM={x:0,y:0,z:0,w:.3}},75810:(e,t,i)=>{"use strict";i.d(t,{I:()=>n});var s=i(19663);class n extends s.m{constructor(e){super(),this.id="TOGGLE_MESH_OVERLAY_COLOR",this.payload={enabled:e}}}},26269:(e,t,i)=>{"use strict";i.d(t,{oR:()=>n,$4:()=>a});var s=i(7402);const n=e=>!!e&&e instanceof s.g,a={hasMeshGroup:e=>"object"==typeof e&&!!e&&"meshGroup"in e,hasMeshSubgroup:e=>"object"==typeof e&&!!e&&"meshSubgroup"in e,isRoomMesh:n,isVisibleRoomMesh:e=>n(e)&&e.raycastEnabled&&e.visible}},76325:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ModelRatedMessage:()=>r.E,SubmitModelRatingCommand:()=>o.M,ToggleModelRatingDialogCommand:()=>o.m,default:()=>D});var s=i(70173),n=i(97542),a=i(7446),r=i(75783),o=i(99660),h=i(92211),l=i(73536),d=i(3907);const c=new(i(97998).Z)("model-rating-data-store"),u=e=>e,p=e=>e;class g extends d.MU{constructor(e,t,i){super({queue:e,deserialize:u,serialize:p,path:`${t}/api/v1/jsonstore/model/model-rating/${i}`}),this.queue=e,this.baseUrl=t,this.modelId=i}async canPromptRating(){let e;try{e=await this.read()}catch(e){return c.error("Failed to read existing rating data from JSONStore"),!1}const t=!!e.rated_at;return!!!e.prompt_dismissed_at&&!t}async recordRatingSubmitted(){this.update({rated_at:(new Date).toISOString()})}async recordAutomaticPromptDismissed(){this.update({prompt_dismissed_at:(new Date).toISOString()})}async reset(){var e;const t=`${this.baseUrl}/api/v1/jsonstore/model/model-rating/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${t}`);if(window.confirm("Are you sure you want to reset the Model Rated value for this space? This cannot be undone."))return this.queue.delete(t,this.options).then((()=>{window.location.reload()}))}}var m=i(26158),y=i(34029),w=i(26568),f=i(57956);const v=e=>864e5*e,b=v(1),T=v(7);class S extends n.Y{constructor(){super(...arguments),this.name="model-rating",this.promptEnabled=!1,this.totalActiveTime=0,this.wasLastOpeningAutomatic=!1,this.canPrompt=async()=>{const e=Date.now(),t=+this.settings.tryGetProperty(m.F.LastRatingPromptTime,null),i=!t||isNaN(t)||+new Date(e)-+new Date(t)>=b,s=await this.store.canPromptRating();return this.log.debug(`canPromptUser: ${i}, canPromptModel: ${s}`),i&&s},this.handleActivityPingMessage=async e=>{if(this.totalActiveTime+=e.durationDollhouse+e.durationFloorplan+e.durationInside,this.log.debug(`prompt timing update: totalActiveTime:${this.totalActiveTime}, threshHold: 74500`),this.totalActiveTime<74500||!this.promptEnabled)return;this.engine.unsubscribe(s.i,this.handleActivityPingMessage);if(await this.canPrompt()&&!this.viewData.getIsDialogVisible()){this.log.debug("automatically prompting user for Model Rating");const e=(new Date).toISOString();this.settings.setLocalStorageProperty(m.F.LastRatingPromptTime,e),this.engine.commandBinder.issueCommand(new o.m(!0)),this.wasLastOpeningAutomatic=!0}},this.handleSubmitModelRatingCommand=async({rating:e,didFinish:t})=>{this.log.info(e),this.engine.broadcast(new r.E(e)),this.store.recordRatingSubmitted(),t&&(this.engine.commandBinder.issueCommand(new o.m(!1)),this.engine.commandBinder.issueCommand(new h.Bz(l.P.RATING_THANK_YOU,!0)))},this.handleToggleDialogCommand=async({toVisible:e})=>{this.viewData.setDialogVisible(e);!this.viewData.getIsDialogVisible()&&this.wasLastOpeningAutomatic&&(this.store.recordAutomaticPromptDismissed(),this.wasLastOpeningAutomatic=!1)}}async init(e,t){this.engine=t,this.config=e,this.viewData=new a.P,this.store=new g(e.queue,e.baseUrl,e.baseModelId),this.promptEnabled=e.promptEnabled,this.settings=await t.market.waitForData(y.e),this.modelData=await t.market.waitForData(w.T),this.bindings.push(t.commandBinder.addBinding(o.m,this.handleToggleDialogCommand),t.commandBinder.addBinding(o.M,this.handleSubmitModelRatingCommand));const i=this.modelData.model.created;let n=!!i&&Date.now()-+new Date(i)<T;this.promptEnabled&&e.debug&&(this.log.info("Debug Mode Enabled: Ignoring max model age requirement for rating prompt."),n=!0),this.log.debug(`promptEnabled: ${e.promptEnabled}, isModelEligible: ${n}`),this.promptEnabled&&n&&this.bindings.push(t.subscribe(s.i,this.handleActivityPingMessage)),t.market.register(this,a.P,this.viewData),this.registerSettings()}async registerSettings(){const e=await this.engine.getModuleBySymbol(f.y.SETTINGS),{debug:t}=this.config;t&&e.registerMenuButton({header:"Model Rating",buttonName:"Reset Model Rated value",callback:()=>{this.settings.setLocalStorageProperty(m.F.LastRatingPromptTime,null),this.store.reset()}})}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}}const D=S},38987:(e,t,i)=>{"use strict";i.d(t,{u:()=>n});var s=i(19663);class n extends s.m{constructor(e=null){super(),this.id="SET_MOUSE_CURSOR",this.payload={cursor:e}}}},34956:(e,t,i)=>{"use strict";var s;i.d(t,{C:()=>s}),function(e){e.NONE="none",e.DEFAULT="default",e.MOVE="move",e.MOVE_LF="col-resize",e.MOVE_UD="row-resize",e.XHAIR="crosshair",e.PLUS="cell",e.QUESTION="help",e.NOPE="not-allowed",e.FINGER="pointer",e.TEXT="text",e.TEXT_VERT="vertical-text",e.ZOOM_IN="zoom-in",e.ZOOM_OUT="zoom-in",e.GRAB="grab",e.GRABBING="grabbing",e.ARROW_R="e-resize",e.ARROW_L="w-resize",e.ARROW_U="n-resize",e.ARROW_D="s-resize",e.ARROW_UR="ne-resize",e.ARROW_UL="nw-resize",e.ARROW_DR="se-resize",e.ARROW_DL="sw-resize",e.ARROW_LR="ew-resize",e.ARROW_UD="ns-resize",e.ARROW_URDL="nesw-resize",e.ARROW_ULDR="nwse-resize"}(s||(s={}))},73992:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var s=i(97542),n=i(97998),a=i(75287);class r extends a.T{equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.name=e.name,this.vendor=e.vendor,this.model=e.model,this.captureMode=e.captureMode,this.depthCameraType=e.depthCameraType,this.cameraTypes=e.cameraTypes.slice(),this.sensorSerialNumbers=e.sensorSerialNumbers.slice(),this.serialNumber=e.serialNumber,this.mountCalibrationVersion=e.mountCalibrationVersion,this.softwareVersion=e.softwareVersion,this}}class o extends a.T{constructor(e){super(),e&&(e.id&&(this.id=e.id),void 0!==e.index&&(this.index=e.index),this.name=e.name||"",this.created=e.created||"",this.alignment=e.alignment||"",this.options=e.options||[],this.camera=e.camera||new r)}equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.index=e.index,this.name=e.name,this.created=e.created,this.alignment=e.alignment,this.options=e.options.slice(),this.camera=(new r).copy(e.camera),this}}const h=new n.Z("mds-scaninfo-serializer");class l{deserialize(e){if(!e||!this.validate(e))return h.debug("Deserialized invalid ScanInfo data from MDS",e),null;const t=e,i=new o;i.id=t.id,i.anchorId=t.anchor&&t.anchor.id||"",i.index=t.index||-1,i.name=t.name||"",i.created=t.created||"",i.alignment=t.alignment||"",i.url=t.url||"",i.timeOfDay=t.timeOfDay||"",i.options=t.options||[];const s=t.camera;return i.camera=new r,i.camera.id=s&&s.id||"",i.camera.name=s&&s.name||"",i.camera.vendor=s&&s.vendor||"",i.camera.model=s&&s.model||"",i.camera.captureMode=s&&s.captureMode||"",i.camera.depthCameraType=s&&s.depthCameraType||"",i.camera.cameraTypes=((null==s?void 0:s.cameraTypes)||[]).filter((e=>e)),i.camera.sensorSerialNumbers=((null==s?void 0:s.sensorSerialNumbers)||[]).filter((e=>e)),i.camera.serialNumber=s&&s.serialNumber||"",i.camera.mountCalibrationVersion=(null==s?void 0:s.mountCalibrationVersion)?s.mountCalibrationVersion:void 0,i.camera.softwareVersion=s&&s.softwareVersion||"",i}validate(e){if(!e)return!1;return["id"].every((t=>t in e))}}var d=i(17788),c=i(68512);class u{}class p extends d.u{constructor(){super(...arguments),this.deserializer=new l}async fetch(){const e=this.getViewId();return this.query(c.GetScans,{modelId:e},{fetchPolicy:"no-cache"}).then((e=>{var t,i;const s=(null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.assets.scans)||[],n={},a={};for(const e of s){const t=this.deserializer.deserialize(e);t&&(n[t.id]=t,t.anchorId&&(a[t.anchorId]=t))}const r=new u;return r.scansById=n,r.scansByAnchor=a,r}))}async read(){return this.scans||(this.scans=this.fetch()),this.scans}async refresh(){return this.scans=this.fetch(),this.scans}}class g extends s.Y{constructor(){super(...arguments),this.name="scaninfo-data",this.getScanInfo=e=>this.store.read().then((t=>t?t.scansByAnchor[e]:void 0)),this.getScanDownloadURL=e=>this.store.refresh().then((t=>{if(t){const i=t.scansByAnchor[e];return i?i.url:void 0}}))}async init(e){this.store=new p}}},56163:(e,t,i)=>{"use strict";i.d(t,{K:()=>o});var s=i(52528),n=i(71166),a=i(25823);const r=new s.v({});class o{constructor(e,t){this.commandBinder=e,this.layersData=t,this.enabled=!0,this.textParser=r,this.bindings=[]}getGroupingId(e){switch(e){case a.l.TYPE:return this.typeId;case a.l.FLOOR:return this.floorId;case a.l.LAYER:return this.getLayerGroupId();case a.l.DATE:return this.dateBucket}}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),s=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&s&&this.layerId===i?s:this.layerId}onSelect(){this.commandBinder.issueCommand(new n.IL(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},33624:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ChangeSearchGroupingCommand:()=>y.SN,ClearSearchFiltersCommand:()=>y.Hf,DeregisterSearchGroupCommand:()=>y.Pe,RefreshSearchResultsCommand:()=>y.s7,RegisterSearchGroupCommand:()=>y.c6,SearchGrouping:()=>U.l,SearchModeToggleCommand:()=>y.Xv,SelectSearchResultCommand:()=>y.IL,SetSearchFilterCommand:()=>y.Z4,ToggleSearchFilterCommand:()=>y.Mp,ToggleSearchQueryKeywordCommand:()=>y.M8,UpdateGroupActionsCommand:()=>y.Np,UpdateSearchQueryCommand:()=>y.H1,UpdateSearchQueryKeywordsCommand:()=>y.FZ,default:()=>Lt});var s=i(97542),n=i(57956),a=i(89570),r=i(38399),o=i(80361),h=i(10374),l=i(54244),d=i(76087),c=i(34029),u=i(91380),p=i(76631),g=i(89549),m=i(50892),y=i(71166);class w{constructor(e){this.engine=e,this.initialized=!1}async activate(){const{commandBinder:e}=this.engine;this.initialized||(this.initialized=!0),e.issueCommand(new y.Z4(null)),await e.issueCommand(new y.Xv(!0))}async deactivate(){const{commandBinder:e}=this.engine;await e.issueCommand(new y.Xv(!1))}}var f=i(85893),v=i(67294),b=i(51978),T=i(40216),S=i(51588),D=i(66102),P=i(22821),I=i(46362),x=i(73085),M=i(29883);const E=(0,x.M)(M.T,"selectedItemId",null);var C=i(71330),R=i(55858),A=i(74554);function L(){const e=(0,C.P)(),t=(0,R.Y)();return(null==e?void 0:e.id)===(null==t?void 0:t.id)?e:null}(0,A.M)("dockedTag",L);var O=i(25071),F=i(56710),k=i(94184),B=i.n(k),N=i(33558),G=i(80008),_=i(43470);var U=i(25823),z=i(77230),V=i(16589),j=i(47457),Q=i(6608),H=i(44472);const{SEARCH:W}=r.Z.SHOWCASE,Y=({item:e})=>{const t=(0,D.b)(),i=(0,b.y)(d.fc,!1);if(!e){const e=t.t(W.EMPTY_LIST_MESSAGE);return(0,f.jsx)(j.gQ,{message:e})}const s=i?"":"outdated";return(0,f.jsx)(Z,{item:e,className:s},e.id)};function Z({item:e,className:t}){const i=(0,z.A)(),s=E(),n=(0,P.g)(),a=(0,D.b)(),r=e.id,o=e.color,h=!!s&&r===s,l=function(){const[,e]=(0,v.useState)(0);return(0,v.useCallback)((()=>{e((e=>e+1))}),[])}(),{commandBinder:d}=(0,v.useContext)(N.I);let c=e.title;c&&(c=(0,V.vr)(c,i));let u=e.description;u&&(u=(0,V.zf)(u,i));const p=[];if(e.actions)for(const t of e.actions)p.push((0,f.jsx)(j.zx,{icon:t.icon,className:t.className,variant:j.Wu.TERTIARY,tooltip:a.t(t.tooltipKey),onClick:e=>{t.handler(e),l()}},r));const m=[];if(e.menuActions)for(const t of e.menuActions)m.push((0,f.jsx)(j.zx,{label:a.t(t.labelKey),icon:t.icon,className:t.className,variant:j.Wu.TERTIARY,size:j.qE.SMALL,onClick:()=>{t.handler(),l()}},t.labelKey));const y=(0,f.jsxs)(j.hE,{children:[e.actions&&p,e.menuActions&&(0,f.jsx)(j.xz,Object.assign({icon:"more-vert",menuArrow:!0,menuClassName:"search-result-menu"},{children:m}))]}),w=(0,f.jsx)(Q.C,{badgeStyle:void 0!==o?{background:o,borderColor:o}:{},iconClass:e.icon}),b=(0,f.jsxs)("div",Object.assign({className:"item-details"},{children:[(0,f.jsx)("div",Object.assign({className:"item-header"},{children:(0,f.jsx)(H.S,{text:c||"",textParser:e.textParser,markers:V.PP})})),e.textParser&&(0,f.jsx)("div",Object.assign({className:"item-description"},{children:(0,f.jsx)(H.S,{text:u||"",textParser:e.textParser,markers:V.PP})}))]}));return(0,f.jsx)(j.HC,{id:r,className:B()("search-result-item",t),title:b,selected:h,disabled:!e.enabled,onClick:async()=>{if(d.issueCommand(new g.qy(!0)),await d.issueCommand(new _.yL),e.onSelect(),n===U.l.LAYER){const t=e.getGroupingId(U.l.LAYER);t&&d.issueCommand(new G.cq(t,!0))}},badge:(()=>{if(e.imgUrl){const t=e.imgUrl,i=t?{backgroundImage:`url('${t}')`}:{};return(0,f.jsx)("div",{className:"thumbnail-image",style:i})}return w})(),actions:y},r)}var q=i(44828),X=i(32279),K=i(37190),$=i(49571),J=i(43363);function ee({id:e,icon:t,label:i,selected:s}){const{commandBinder:n}=(0,v.useContext)(N.I);return(0,f.jsx)(J.e,{id:e,icon:t,label:i,selected:s,onToggled:()=>{"ALL"===e?s||n.issueCommand(new y.Hf):n.issueCommand(new y.Mp(e,!s))}})}i(52424);const{SEARCH:te}=r.Z.SHOWCASE;function ie(){const e=(0,D.b)(),t=Object.values((0,X.b)()),i=(0,K.b)(),s=0===i.length,n=(0,v.useRef)(null),a=t.sort(((e,t)=>(e.groupOrder||$.Xs)-(t.groupOrder||$.Xs))).map((t=>{const{id:n,groupIcon:a,groupPhraseKey:r}=t,o=e.t(r),h=!s&&i.includes(n);return(0,f.jsx)(ee,{id:n,icon:a,label:o,selected:h},n)})),o=e.t(te.FILTER_SEARCH),h=e.t(te.FILTER_SEARCH_ALL);return(0,f.jsx)("div",Object.assign({className:"search-filter",onClick:e=>e.stopPropagation()},{children:(0,f.jsxs)(j.xz,Object.assign({ref:n,icon:"filter",variant:j.Wu.TERTIARY,size:j.qE.SMALL,menuClassName:"search-filter-menu"},{children:[(0,f.jsxs)("div",Object.assign({className:"search-filter-menu-header"},{children:[(0,f.jsx)("div",{children:o}),(0,f.jsx)(j.zx,{icon:"close",ariaLabel:e.t(r.Z.CLOSE),variant:j.Wu.TERTIARY,onClick:()=>{n.current&&n.current.closeMenu()}})]})),(0,f.jsx)(ee,{id:"ALL",icon:"fullscreen",label:h,selected:s}),a]}))}))}var se=i(94717),ne=i(84309),ae=i(49627),re=i(32597),oe=i(73536),he=i(15501),le=i(43037),de=i(31981);function ce(){const e=(0,de.w)(),[t,i]=(0,v.useState)(!!e&&e.creatingTag);return(0,v.useEffect)((()=>{if(!e)return()=>{};const t=e.onPropertyChanged("creatingTag",i);return i(e.creatingTag),()=>t.cancel()}),[e]),t}(0,A.M)("creatingTag",ce);var ue=i(65596),pe=i(50788),ge=i(33023),me=i(45755),ye=i(97163);const we=(0,me.u)(ye.b);function fe(e){return!!e&&e.uploads.values.length>0}function ve(){const e=we(),[t,i]=(0,v.useState)(fe(e));return(0,v.useEffect)((()=>{if(!e)return()=>{};function t(){i(fe(e))}const s=e.uploads.onChanged(t);return t(),()=>s.cancel()}),[e]),t}(0,A.M)("uploading",ve);var be=i(38772),Te=i(84428),Se=i(5823),De=i(95160),Pe=i(92211),Ie=i(32347),xe=i(35446),Me=i(36892),Ee=i(86283),Ce=i(71776),Re=i(22782),Ae=i(71570),Le=i(39361),Oe=i(93958),Fe=i(44568),ke=i(47397);function Be({current:e,min:t,max:i}){const s=void 0!==t&&e<t||e>i;return(0,f.jsxs)("div",Object.assign({className:B()("text-counter",{error:s})},{children:[e,"/",i]}))}var Ne=i(92161);const Ge=/[&?,%]/,_e=`Keyword may not include these characters: "${(e=>{const t=e.toString();return t.substring(t.indexOf("[")+1,t.lastIndexOf("]")).split("").join('", "')})(Ge)}"`,Ue=e=>({id:e,text:e}),ze=e=>Ge.test(e)?_e:void 0,Ve=(0,v.forwardRef)((({initialKeywords:e,availableKeywords:t,onChange:i},s)=>{const n=(0,v.useCallback)((e=>{i&&i(e.map((e=>e.text)))}),[i]);return(0,f.jsx)(j.rR,{placeholder:"Add keywords",initialTokens:e.map(Ue),options:t.map(Ue),onChange:n,ref:s,maxLength:30,maxTokens:10,maxTokensValidationMsg:"Maximum keywords added",helpMessage:"Keywords will display in search",validateNewToken:ze})}));var je=i(38042),Qe=i(19564),He=i(51728);const We=He.U.cerulean,Ye=Object.entries(He.U).map((([e,t])=>({text:e,id:t,value:t}))),Ze=({selectedColor:e,onChange:t})=>(0,f.jsx)(j.Q5,{onChange:t,options:Ye,selectedColor:e||We,size:j.qE.LARGE,align:j.jr.JUSTIFY,noSelectionText:"Choose a color...",selectMenuClassName:"pin-color-select-menu"});var qe=i(68709),Xe=i(75182),Ke=i(58956),$e=i(60083);const Je=(0,me.u)($e.B),et="_recent",tt="_space",it=(e,t)=>{const[,i,...s]=e.split("_"),n=s[s.length-1],a=1===(r=n).length?`Character ${r}`:r;var r;return{id:e,text:a,tooltip:a,group:t||i}},st=e=>e.startsWith("public_")&&Xe.g.includes(e),nt=Xe.g.filter((e=>e.startsWith("public_"))).map((e=>it(e))),at=(0,v.forwardRef)((({initialValue:e,onChange:t},i)=>{const s=Je(),[n,a]=(0,ae._)("matterport_recent_icons",[]),r=(0,v.useCallback)((e=>{if(t&&t(e),e&&!n.includes(e)){const t=[e,...n];t.length=Math.min(t.length,14),a(t)}}),[t,n,a]),o=(0,v.useCallback)((()=>{t&&t(void 0)}),[t]),{allOptions:h,hasRecentOptions:l,hasSpaceOptions:d}=(0,v.useMemo)((()=>{const e=[];null==s||s.iteratePins((t=>{t.icon&&!e.includes(t.icon)&&e.push(t.icon)}));const t=e.filter(st).map((e=>it(e,tt))),i=n.filter(st).map((e=>it(e,et)));return{hasRecentOptions:i.length>0,hasSpaceOptions:t.length>0,allOptions:[...nt,...i,...t]}}),[n,s]),c=(0,v.useMemo)((()=>[l&&{id:et,icon:"public_symbols_clock",displayText:"Recently used"},d&&{id:tt,icon:"public_symbols_cube",displayText:"Used in this space"},{id:"people",icon:"public_people_face-smile",displayText:"People"},{id:"furniture",icon:"public_furniture_chair",displayText:"Furniture & Appliances"},{id:"buildings",icon:"public_buildings_buildings",displayText:"Buildings"},{id:"objects",icon:"public_objects_box",displayText:"Objects & Food"},{id:"symbols",icon:"public_symbols_shapes",displayText:"Shapes & Symbols"},{id:"characters",icon:"public_characters_circle-1",displayText:"Numbers & Letters"}].filter((e=>!!e))),[l,d]),u=(0,v.useCallback)((e=>`No icons found for "${e}"`),[]);return(0,f.jsx)(j.xG,{options:h,selectedIcon:e,onChange:r,groups:c,align:j.jr.JUSTIFY,placeholder:"Default icon",searchPlaceholder:"Search icons",getNoResultsText:u,allowClear:!0,onClear:o,scrollbarComponent:Ke.T,selectMenuClassName:"pin-icon-select-menu"})})),rt=({label:e="Appearance",pinAppearance:t,onChange:i,tagIconsEnabled:s,hideStemEditor:n,tabIndex:a})=>{const r=(0,Qe.z)(),o=(0,v.useCallback)((e=>{r.trackGuiEvent("pin_change_icon"),i({icon:e})}),[i,r]),h=(0,v.useCallback)((e=>{r.trackGuiEvent("pin_change_color"),i({color:e})}),[i,r]),l=(0,v.useCallback)((e=>{r.trackGuiEvent(e?"pin_show_stem":"pin_hide_stem"),i({stemEnabled:e})}),[i,r]),d=(0,v.useCallback)((e=>{r.trackGuiEvent("pin_change_stem_height"),i({stemLength:e})}),[i,r]);return(0,f.jsxs)("div",Object.assign({className:"pin-appearance-editor"},{children:[(0,f.jsx)("div",Object.assign({className:"h6"},{children:e})),s&&(0,f.jsx)(at,{initialValue:t.icon,onChange:o}),(0,f.jsx)(Ze,{onChange:h,selectedColor:t.color}),!n&&(0,f.jsx)(qe.r,{stemLength:t.stemLength||.3048,stemEnabled:t.stemEnabled||!1,onLengthUpdate:d,onLengthChanged:d,onStemEnabledChanged:l,variant:"inline-value",tabIndex:a})]}))};var ot=i(72936),ht=i(62612),lt=i(26340),dt=i(5666),ct=i(48945),ut=i(63319),pt=i(15258),gt=function(e,t,i,s){var n,a=arguments.length,r=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(r=(a<3?n(r):a>3?n(t,i,r):n(t,i))||r);return a>3&&r&&Object.defineProperty(t,i,r),r};const{MATTERTAGS:mt,OBJECT_TAG_SUGGESTION:yt}=r.Z.WORKSHOP;let wt=class extends v.Component{constructor(e){super(e),this.uploadTooltipTimeout=0,this.bindings=[],this.keywordInput=(0,v.createRef)(),this.isUnmounting=!1,this.revertPendingAppearanceChanges=()=>{const{tag:e,manager:t}=this.props;e&&this.isAppearanceDirty()&&t.dataMap.tagsViewData.getTagView(e.id)&&(this.context.commandBinder.issueCommand(new ot.tE(e.id,ht.Er.MATTERTAG,{color:e.color,stemEnabled:e.stemEnabled,stemLength:e.stemLength,icon:e.icon})),this.setState({pendingAppearance:{color:e.color,stemEnabled:e.stemEnabled,stemLength:e.stemLength,icon:e.icon}}))},this.updateAttachments=()=>{if(this.isUnmounting||this.props.closing)return;const{tag:e,manager:t}=this.props,{attachmentsData:i}=t.dataMap,s=i.getPendingAttachmentsForAsset(e.id,Se.ud.MATTERTAG),n=i.getRemovedAttachmentsForAsset(e.id,Se.ud.MATTERTAG),a=i.failures.values,r=i.uploads.values;this.setState({pendingAttachments:s,removedAttachments:n,failures:a,uploads:r},(()=>{this.updateEmbed(),this.updateDirtyState(),this.updateAttachmentViewer()}))},this.isAppearanceDirty=()=>{const{tag:e}=this.props,{pendingAppearance:t}=this.state;return Object.keys(t).some((i=>e[i]!==t[i]))},this.getIsProcessing=()=>{const{uploads:e,isProcessingMedia:t}=this.state;return e.length>0||t},this.onDescriptionInput=e=>{this.setState({descriptionLength:e.length},(()=>this.updateDirtyState()))},this.handleDescriptionFocusChange=e=>{this.setState({isDescFocused:e})},this.onLabelInput=e=>{this.setState({label:e},(()=>this.updateDirtyState()))},this.handleKeywordsChanged=e=>{this.setState({keywords:e},(()=>this.updateDirtyState()))},this.onCancel=()=>{this.props.closing||(this.props.creating?(this.updateDirtyState(!0),this.context.commandBinder.issueCommand(new le.$g)):this.closeTag())},this.onSave=async()=>{var e,t;if(this.props.closing)return;if(this.isEmpty())return void this.onCancel();const{tag:i,manager:s}=this.props,{label:n,keywords:a,pendingAppearance:r,showOnlyInSearch:o}=this.state,{commandBinder:h}=this.context,{attachmentsData:l}=s.dataMap,d=this.getDescriptionMarkdown(),{id:c,anchorPosition:u,stemNormal:p,floorId:g,objectAnnotationId:m}=i,w={position:u,normal:p,floorId:g,description:d,label:n,keywords:a,color:new Te.Color(r.color||i.color),stemHeight:null!==(e=r.stemLength)&&void 0!==e?e:i.stemLength,stemVisible:null!==(t=r.stemEnabled)&&void 0!==t?t:i.stemEnabled,icon:r.icon,enabled:!0,objectAnnotationId:m},f=e=>e.category===Ie.G$.UPLOAD,v=l.getPendingAttachmentsForAsset(c,Se.ud.MATTERTAG).filter(f),b=l.getRemovedAttachmentsForAsset(c,Se.ud.MATTERTAG).filter(f),T=this.getCurrentEmbed();o?(await h.issueCommand(new ot.OL(c,ht.Er.MATTERTAG)),await h.issueCommand(new dt.I2(c,w,v,T))):await h.issueCommand(new le.QG(c,w,v,b,T)),m&&h.issueCommand(new y.s7),this.updateDirtyState(!0)},this.openLinkEditor=()=>{!(this.props.openModal===oe.P.LINK_EDITOR)&&this.textEditor&&(this.trackEvent("tags_editor_add_link"),this.textEditor.prepareLinkForEdit())},this.onClickBlock=e=>{e.blockType===De.C.LINK&&(this.setState({selectedBlock:e}),this.context.commandBinder.issueCommand(new Pe.Bz(oe.P.LINK_EDITOR,!0)))},this.closeLinkEditor=async()=>this.context.commandBinder.issueCommand(new Pe.Bz(oe.P.LINK_EDITOR,!1)),this.onCancelLink=async()=>{await this.closeLinkEditor(),this.textEditor&&this.textEditor.cancelLink()},this.onRemoveLink=()=>{this.trackEvent("tags_editor_remove_link"),this.onSaveLink("","")},this.onSaveLink=(e,t)=>{const{openModal:i}=this.props;i===oe.P.LINK_EDITOR&&this.textEditor&&(this.trackEvent("tags_editor_save_link"),this.textEditor.saveLink(e,t),this.updateDirtyState(),this.closeLinkEditor())},this.onFileUpload=e=>{const{tag:t}=this.props,i=Array.from(e),s=this.getAttachmentCount(!1);e.length+s>Me.yk&&i.splice(Me.yk-s),this.context.commandBinder.issueCommand(new xe.It(t.id,Se.ud.MATTERTAG,i))},this.onDrop=e=>{this.trackEvent("tags_files_dropped"),this.onFileUpload(e)},this.onFilesChosen=e=>{this.trackEvent("tags_files_chosen"),this.onFileUpload(e)},this.onEmbed=async e=>{this.trackEvent("tags_editor_save_embed");const t=this.getCurrentEmbed(e.id);t&&await this.context.commandBinder.issueCommand(new xe.$T(t))},this.handleEmbedCleared=()=>{this.trackEvent("tags_editor_clear_embed");const e=this.getCurrentEmbed();e&&this.context.commandBinder.issueCommand(new xe.$T(e))},this.handleEmbedEditorValidationChange=e=>{const t=e===Fe.p.ERROR||e===Fe.p.INVALID_URL_SYNTAX;this.setState({isValid:!t,isProcessingMedia:e===Fe.p.LOADING},(()=>this.updateDirtyState()))},this.onViewAttachments=e=>{const t=this.getCurrentAttachments();t.length&&(this.trackEvent("tags_editor_view_attachment"),this.context.commandBinder.issueCommand(new xe.xW(!0,t,e)))},this.onToggleShowOnlyInSearch=()=>{this.setState({showOnlyInSearch:!this.state.showOnlyInSearch})},this.setTextEditorRef=e=>this.textEditor=e,this.handlePinAppearanceChange=e=>{const{tag:t}=this.props,{pendingAppearance:i}=this.state;if(!t)return;const s=Object.assign(Object.assign({},i),e);this.context.commandBinder.issueCommand(new ot.tE(t.id,ht.Er.MATTERTAG,s)),this.setState({pendingAppearance:s},(()=>this.updateDirtyState()))},this.state={saveable:!1,showOnlyInSearch:!1,selectedBlock:null,label:e.tag.label,keywords:e.tag.keywords||[],descriptionLength:this.getDescriptionMarkdown().length,mediaSrc:"",pendingAttachments:[],removedAttachments:[],uploads:[],failures:[],pendingAppearance:{color:e.tag.color,stemEnabled:e.tag.stemEnabled,stemLength:e.tag.stemLength,icon:e.tag.icon},isDescFocused:!1,isValid:!0,isProcessingMedia:!1}}componentDidMount(){const{attachmentsData:e}=this.props.manager.dataMap;this.bindings.push(e.onChanged(this.updateAttachments)),this.updateAttachments()}componentWillUnmount(){this.revertPendingAppearanceChanges(),this.isUnmounting=!0,window.clearTimeout(this.uploadTooltipTimeout);for(const e of this.bindings)e.cancel()}componentDidUpdate(e,t){const{tag:i,openModal:s}=this.props,n=e.closing&&!this.props.closing;(i.id!==e.tag.id||n)&&(this.setState({saveable:!1,label:i.label,descriptionLength:i.description.length,pendingAppearance:{color:i.color,stemEnabled:i.stemEnabled,stemLength:i.stemLength,icon:i.icon}}),this.updateAttachments()),e.openModal===oe.P.LINK_EDITOR&&e.openModal!==s&&this.setState({selectedBlock:null})}trackEvent(e){this.context.analytics.trackToolGuiEvent("tags",e)}updateEmbed(){const e=this.getCurrentEmbed();this.setState({mediaSrc:e?e.src:""})}isEmpty(){return""===this.getDescriptionMarkdown()&&""===this.state.label.trim()&&0===this.getAttachmentCount(!1)}getDirtyState(){const{tag:e}=this.props,{pendingAttachments:t,removedAttachments:i,uploads:s,label:n,keywords:a}=this.state,r=this.getDescriptionMarkdown()!==e.description,o=n!==e.label,h=!(0,je.E8)(a,e.keywords),l=this.isAppearanceDirty();return r||o||h||l||i.length>0||t.length>0||s.length>0}updateDirtyState(e){const{creating:t,closing:i}=this.props,s=this.getDirtyState(),n=this.getIsProcessing(),a=this.isEmpty(),r=!s||n||a;this.setState({saveable:!r});const o=!i&&!e&&(s||n||t);this.props.manager.setDirtyTagState(o)}closeTag(){this.revertPendingAppearanceChanges(),this.updateDirtyState(!0),this.context.commandBinder.issueCommand(new le.xb)}getDescriptionMarkdown(){const{tag:e}=this.props;let t;return t=this.textEditor?this.textEditor.getMarkdown():e.description,t.trim()}getCurrentEmbed(e=""){const t=t=>t.category===Ie.G$.EXTERNAL&&t.id!==e,i=this.state.pendingAttachments.find(t);if(i)return i;const{tag:s,manager:n}=this.props,{attachmentsData:a}=n.dataMap,r=s.attachments.filter((e=>t(e)&&!(a&&a.removals.get(e.id))));return r.length>0?r[0]:null}getAttachmentCount(e){const{tag:t}=this.props,{pendingAttachments:i,removedAttachments:s,uploads:n}=this.state;let a=t.attachments.length+i.length+n.length-s.length;return e&&(a-=this.getCurrentAttachments(Ie.G$.EXTERNAL).length),a}isAtMaxAttachments(){return this.getAttachmentCount(!1)>=Me.yk}getCurrentAttachments(e){const{tag:t,manager:i}=this.props,{attachmentsData:s}=i.dataMap,{pendingAttachments:n}=this.state;return t.attachments.concat(n).filter((t=>!(e&&t.category!==e||s&&s.removals.get(t.id))))}updateAttachmentViewer(){const{openModal:e}=this.props,{commandBinder:t}=this.context;if(e===oe.P.ATTACHMENT){const e=this.getCurrentAttachments();e.length?t.issueCommand(new xe.xW(!0,e)):t.issueCommand(new Pe.Bz(oe.P.ATTACHMENT,!1))}}renderLinkOption(){const{locale:e}=this.context,{descriptionLength:t}=this.state,i=e.t(mt.LINK_TOOLTIP_MESSAGE),s=t>=Ce.Us;return(0,f.jsx)("div",Object.assign({className:"annotation-button-bar"},{children:(0,f.jsx)("div",Object.assign({className:"annotation-editors"},{children:(0,f.jsx)(j.zx,{icon:"add-link",ariaLabel:i,tooltip:i,tooltipOptions:{placement:"bottom"},size:j.qE.LARGE,variant:j.Wu.TERTIARY,disabled:s,onClick:this.openLinkEditor})}))}))}renderEmbed(){const{tag:e}=this.props,{mediaSrc:t}=this.state,i=t?this.getCurrentEmbed():null;return(0,f.jsxs)("div",Object.assign({className:"tag-editor-embeds"},{children:[(0,f.jsx)(Fe.M,{url:t,parentId:e.id,parentType:Se.ud.MATTERTAG,onEmbed:this.onEmbed,onEmbedCleared:this.handleEmbedCleared,onValidationPhaseChange:this.handleEmbedEditorValidationChange,tabIndex:0}),i&&(0,f.jsx)(Re.s,{annotationType:Ee.J.TAG,canDelete:!0,inline:!1,attachments:[i],onViewAttachment:this.onViewAttachments})]}))}renderUploadButton(e,t,i){const{tag:s}=this.props,{locale:n}=this.context,{uploads:a}=this.state,r=a.length>0,o=i?n.t(mt.MAX_ATTACHMENTS_MESSAGE,Me.yk):r?n.t(mt.UPLOAD_IN_PROGRESS):e?void 0:n.t(mt.UPLOAD_FILE),h=n.t(mt.ADD_FILE),l=B()("file-upload-btn","mp-nova-btn","mp-nova-btn-dark",{"mp-nova-btn-icon":!e,"mp-nova-btn-disabled":!t,"mp-nova-btn-large":!e,"mp-nova-btn-small":e,"mp-nova-btn-primary":e,"mp-nova-btn-multi":e});return(0,f.jsx)(Le.p,Object.assign({id:`file-upload-tag-${s.id}`,multi:!0,enabled:t,onUpload:this.onFilesChosen,tooltip:o},{children:(0,f.jsxs)("div",Object.assign({className:l},{children:[(0,f.jsx)(j.JO,{name:"plus"}),e&&(0,f.jsx)("span",{children:h})]}))}))}renderFileAttachments(){const{uploads:e,failures:t}=this.state,{locale:i}=this.context,s=this.isAtMaxAttachments(),n=0===this.getAttachmentCount(!0)&&0===t.length,a=e.length>0,r=!s&&!a,o=this.getCurrentAttachments(Ie.G$.UPLOAD),h=this.renderUploadButton(n,r,s),l=i.t(mt.DROP_FILES_MESSAGE);return(0,f.jsxs)(Oe.Z,Object.assign({className:B()("tag-attachments",{empty:n}),onDropped:this.onDrop,disabled:!r},{children:[(0,f.jsx)(Re.s,Object.assign({annotationType:Ee.J.TAG,inline:!0,canDelete:!0,attachments:o,uploads:e,failures:t,onViewAttachment:this.onViewAttachments},{children:!n&&h})),n&&(0,f.jsxs)(f.Fragment,{children:[h,(0,f.jsx)("div",Object.assign({className:"upload-msg"},{children:(0,f.jsx)("div",{children:l})}))]})]}))}renderDescription(){const{manager:e,tag:t}=this.props,{locale:i}=this.context,s=i.t(mt.DESCRIPTION_PLACEHOLDER);return(0,f.jsx)(Ae.b,{className:"placeholder",ref:this.setTextEditorRef,textParser:e.textParser,text:t.description,active:!0,clickToEdit:!1,focusOnMount:!1,maxLength:Ce.Us,placeholder:s,onClickBlock:this.onClickBlock,onInput:this.onDescriptionInput,onFocusChange:this.handleDescriptionFocusChange,onCancelEditing:this.onCancel,tabIndex:0,allowTabbing:!0,allowReturnKey:!0})}renderButtons(){const{locale:e}=this.context,{closing:t}=this.props,{saveable:i,isValid:s}=this.state,n=this.getIsProcessing(),a=!i||n||t||!s,r=n,o=e.t(mt.EDIT_BILLBOARD_CANCEL_CTA),h=e.t(mt.SAVE),l=e.t(mt.SAVE_PROCESSING),d=e.t(mt.SAVE_INVALID);return(0,f.jsxs)("div",Object.assign({className:"button-sticky-footer"},{children:[(0,f.jsxs)(j.hE,{children:[(0,f.jsx)(j.zx,{label:o,variant:j.Wu.TERTIARY,size:j.qE.SMALL,disabled:r,onClick:this.onCancel}),(0,f.jsx)(j.zx,{label:h,variant:j.Wu.PRIMARY,size:j.qE.SMALL,disabled:a,onClick:this.onSave})]}),(!s||n)&&(0,f.jsx)("div",Object.assign({className:B()("tag-editor-status",{"tag-validation-error":!s,"tag-processing":n})},{children:s?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(j.JO,{name:"info"})," ",l]}):(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(j.JO,{name:"error"})," ",d]})}))]}))}renderShowOnlyInSearchCheckbox(){const{locale:e}=this.context,t=e.t(yt.SHOW_ONLY_IN_SEARCH);return(0,f.jsx)(lt.X,{checked:this.state.showOnlyInSearch,onChange:this.onToggleShowOnlyInSearch,stopPropagation:!0,label:t})}render(){const{selectedBlock:e,label:t,descriptionLength:i,isDescFocused:s,pendingAppearance:n}=this.state,{tag:a,availableKeywords:r,creating:o,activeModelView:h}=this.props,{locale:l,settings:d}=this.context,c=l.t(mt.TITLE_PLACEHOLDER),u=l.t(mt.TITLE_DESC_LABEL),p=l.t(mt.ATTACHMENTS_LABEL),g=l.t(mt.APPEARANCE_LABEL),m=l.t(mt.KEYWORDS_LABEL),y=this.props.manager.areObjectTagsEnabled(),w=d.tryGetProperty(ct.RV,!1),v=!!a.objectAnnotationId,b=h.viewType===ut.X.USER;let T="",S="";return e&&e.blockType===De.C.LINK&&(T=e.text,S=e.value||""),(0,f.jsxs)("div",Object.assign({className:"tag-editor"},{children:[(0,f.jsx)("div",Object.assign({className:"h6"},{children:u})),(0,f.jsx)(ke.Z,{text:t,placeholder:c,maxLength:Ce.ZF,focusOnMount:O.El,onInput:this.onLabelInput,onCancel:this.onCancel,tabIndex:0,allowTabbing:!0}),(0,f.jsx)(Be,{current:t.length,max:Ce.ZF}),(0,f.jsxs)("div",Object.assign({className:B()("annotation-text-box annotating editor-box",s&&"has-focus")},{children:[this.renderDescription(),this.renderLinkOption()]})),(0,f.jsx)(Be,{current:i,max:Ce.Us}),(0,f.jsx)("div",Object.assign({className:"h6"},{children:p})),this.renderFileAttachments(),this.renderEmbed(),(0,f.jsx)(rt,{label:g,onChange:this.handlePinAppearanceChange,pinAppearance:n,tagIconsEnabled:w,hideStemEditor:v,tabIndex:-1}),(0,f.jsxs)("div",Object.assign({className:"annotation-keyword-input"},{children:[(0,f.jsx)("div",Object.assign({className:"h6"},{children:m})),(0,f.jsx)(Ve,{ref:this.keywordInput,initialKeywords:a.keywords||[],availableKeywords:r,onChange:this.handleKeywordsChanged})]})),o&&y&&!b&&(0,f.jsx)("div",Object.assign({className:"tag-editor-search-only-checkbox"},{children:this.renderShowOnlyInSearchCheckbox()})),this.renderButtons(),(0,f.jsx)(Ne.I,{linkText:T,linkUrl:S,onCancelLink:this.onCancelLink,onSaveLink:this.onSaveLink,onRemoveLink:this.onRemoveLink})]}))}};wt.contextType=N.I,wt=gt([be.Z],wt);const ft=(0,pt.u)((0,he.W)(wt)),{MATTERTAGS:vt}=r.Z.WORKSHOP,{TAGS:bt}=r.Z.SHOWCASE;function Tt(e){const{tag:t,closing:i}=e,{analytics:s,commandBinder:n}=(0,v.useContext)(N.I),a=(0,D.b)(),r=(0,ue.v)(),o=(0,pe.F)(),h=r&&o&&(o===p.w1.SEARCH||o===p.w1.LAYERS),l=ce(),d=ve(),c=(0,ge.Q)(p.w1.TAGS),u=c?c.manager:null;if(!u)return null;const m=h,y=m?a.t(vt.BACK):a.t(bt.CLOSE_TAG_LABEL),w=m?"back":"close",b=a.t(vt.DELETE_LIST_ITEM_OPTION_CTA);return(0,f.jsxs)("div",Object.assign({className:B()("tag-widget","annotating",{creating:l})},{children:[!l&&(0,f.jsxs)("div",Object.assign({className:"detail-panel-header"},{children:[(0,f.jsx)(j.zx,{label:y,className:"return-btn",icon:w,size:j.qE.SMALL,variant:j.Wu.TERTIARY,disabled:d,onClick:()=>{h?n.issueCommand(new g.cR).then((()=>{n.issueCommand(new g.qy(!1))})):n.issueCommand(new le.xb)}}),(0,f.jsx)("div",Object.assign({className:"tag-header-buttons"},{children:(0,f.jsx)(j.zx,{label:b,className:"delete-btn",icon:"delete",size:j.qE.SMALL,variant:j.Wu.TERTIARY,disabled:d,onClick:()=>{s.trackToolGuiEvent("tags","tags_click_delete_tag"),u&&u.confirmAndDeleteTag(t.id,"tags_detail_panel_widget")}})}))]})),(0,f.jsx)("div",Object.assign({className:"tag"},{children:(0,f.jsx)(ft,{tag:t,manager:u,availableKeywords:u.getAvailableKeywords(),creating:l,closing:i},t.id)}))]}))}var St=i(68072);function Dt(e){const{tag:t,closing:i}=e,{commandBinder:s}=(0,v.useContext)(N.I),n=ce(),a=(0,T.T)(),r=(0,he.R)(),o=(0,v.useRef)(null);(0,ae.OR)("keydown",(e=>{e.keyCode===re.R.ESCAPE&&(n?s.issueCommand(new le.$g):s.issueCommand(new le.xb))})),(0,v.useEffect)((()=>{o.current&&t&&o.current.resetScrollTop()}),[null==t?void 0:t.id]);const h=a===p.wS.BOTTOM_PANEL,l=r&&r!==oe.P.CONFIRM,d=!(!t||i||h&&l);return(0,f.jsx)(St.J,Object.assign({ref:o,className:"tags-detail-panel",open:d,scrollingDisabled:!1},{children:t&&(0,f.jsx)(Tt,{tag:t,closing:i},t.id)}))}const{SEARCH:Pt}=r.Z.SHOWCASE;function It(){const e=(0,P.g)(),t=(0,I.s)(),i=E(),s=L(),[n,a]=(0,v.useState)(s),r=(0,b.y)(d.fc,!1),o=(0,D.b)(),h=(0,T.T)(),l=(0,S.E)(),c=h===p.wS.BOTTOM_PANEL&&l;(0,v.useEffect)((()=>{s&&(null==s?void 0:s.id)!==(null==n?void 0:n.id)&&a(s)}),[null==s?void 0:s.id]);const u=s||n,g=(null==u?void 0:u.objectAnnotationId)&&u||null,m=t.length,y=o.t(Pt.ITEMS,m),w=o.t(Pt.EMPTY_LIST_MESSAGE),x=0===m?w:void 0,M=r?(0,f.jsx)(ie,{}):void 0,C=(0,f.jsx)(se.B,{hideGroupingMenu:c,filter:M,filterPills:!0,shareEnabled:!0});return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Dt,{closing:!s,tag:g}),(0,f.jsx)(ne.L,Object.assign({toolId:p.w1.SEARCH,className:"search-tool-panel",title:y,subheader:C,subheaderCollapsedHeight:O._U},{children:(0,f.jsx)("div",Object.assign({className:"panel-list search-panel-list"},{children:(0,f.jsx)(q.D,{renderGroup:F.v,renderItem:Y,showEmptyMessage:x,selectedItemId:i,grouping:e,excludeEmptyGroups:!0})}))}))]})}class xt{constructor(){this.renderPanel=()=>(0,f.jsx)(It,{})}}function Mt(...e){return!0}function Et(...e){return!1}class Ct{constructor(e){this.searchData=e,this.subscriptions=[],this.isSearchingGroup=e=>{const t=this.searchData.searchMode;return!0===t||t===e},this.onFiltersChanged=()=>{this.updateAvailableKeywords(),this.clearUnavailableKeywordFilters(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()},this.updateAvailableKeywords=()=>{const e=this.getActiveSearchDataTypeList().reduce(((e,{getKeywords:t})=>{if(t){t().forEach((t=>{e[t]?e[t]++:e[t]=1}))}return e}),{});this.searchData.setKeywordCounts(e)},this.updateMatches=e=>{const{id:t,getSimpleMatches:i}=e,s=this.searchData.getTypeFilters(),n=this.searchData.getQuery(),a=0===s.length||s.includes(t)?function(e){if(!e)return Mt;const t=e.toLowerCase();return(...e)=>function(e,...t){return t.some((t=>t.toLowerCase().includes(e)))}(t,...e)}(n):Et,r=this.searchData.getKeywordFilters();e.matches=i(a,n,r)},this.activationChanged=e=>{e?this.updateAllMatchesAndResults():this.searchData.getSearchDataTypeList().forEach(this.revealItems)},this.revealItems=e=>{e.getSimpleMatches(Mt,"",[])},this.updateAllMatchesAndResults=(0,o.D)((()=>{this.updateAvailableKeywords(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()}),200),this.subscriptions.push(e.onPropertyChanged("query",this.updateAllMatchesAndResults),e.onPropertyChanged("keywordFilters",this.updateAllMatchesAndResults),e.onPropertyChanged("searchMode",this.activationChanged),e.typeFilters.onChanged(this.onFiltersChanged))}dispose(){const e=e=>e.cancel();this.subscriptions.forEach(e),this.searchData.getSearchDataTypeList().forEach((t=>t.subscriptions.forEach(e)))}updateGroupActions(e,t){this.searchData.dataTypeGroups[e]&&(this.searchData.dataTypeGroups[e].groupMenuActions=t,this.searchData.commit())}registerSearchGroup(e){const{id:t,groupPhraseKey:i,groupMatchingPhraseKey:s,getSimpleMatches:n,groupMenuActions:a,getKeywords:r,groupOrder:h,groupIcon:l,registerChangeObserver:d,onSearchActivatedChanged:c}=e;if(this.searchData.dataTypeGroups[t])return;const u={id:t,groupPhraseKey:i,groupMatchingPhraseKey:s,getSimpleMatches:n,matches:[],subscriptions:[],groupMenuActions:a,getKeywords:r,groupOrder:h,groupIcon:l};this.searchData.dataTypeGroups[t]=u;const p=()=>{this.updateMatches(u),this.updateResults(),this.updateAvailableKeywords()};p();let g=!1,m=!1;const y=(0,o.D)((()=>{m?(p(),g=!1):g=!0}),200);d&&u.subscriptions.push(d(y));const w=()=>{const e=m;m=this.isSearchingGroup(t),c&&e!==m&&c(m),m&&g&&y()};u.subscriptions.push(this.searchData.onPropertyChanged("searchMode",w)),w()}deregisterSearchGroup(e){const t=this.searchData.dataTypeGroups[e];t&&(t.subscriptions.forEach((e=>e.cancel())),delete this.searchData.dataTypeGroups[e],this.updateResults())}clearUnavailableKeywordFilters(){const e=this.searchData.getTypeFilters().length>0,t=this.getActiveSearchDataTypeList().find((e=>!!e.getKeywords));e&&!t&&this.searchData.setKeywordFilters([])}getActiveSearchDataTypeList(){const e=this.searchData.typeFilters;return this.searchData.getSearchDataTypeList().filter((t=>0===e.length||e.includes(t.id)))}updateResults(){const e=this.searchData.getSearchDataTypeList().reduce(((e,t)=>(e.push(...t.matches),e)),[]);this.searchData.setResults(e)}}const{TOOLS:Rt}=r.Z;class At extends s.Y{constructor(){super(...arguments),this.name="search",this.searchData=new M.T,this.enabled=!1,this.hasStartedTrackingQueries=!1,this.onApplicationChange=async()=>{this.updateFeatureEnablement(),this.searchData.clearTypeFilters(),this.addTool()},this.registerSearchGroup=async e=>{this.searchResultsUpdater.registerSearchGroup(e)},this.deregisterSearchGroup=async e=>{this.searchResultsUpdater.deregisterSearchGroup(e.id)},this.toggleSearchMode=async e=>{const{opened:t}=e;if(t){const e="string"==typeof t?t:void 0;this.activateSearchMode(e),this.setTypeFilter(e||null)}else this.deactivateSearchMode()},this.updateQuery=async e=>{this.searchData.setQuery(e.query),this.searchData.commit(),this.activateSearchMode()},this.updateQueryKeywords=async e=>{this.searchData.setKeywordFilters(e.keywords),this.activateSearchMode()},this.toggleQueryKeyword=async({keywordId:e})=>{const t=[...this.searchData.getKeywordFilters()];t.includes(e)?t.splice(t.indexOf(e),1):t.push(e),this.searchData.setKeywordFilters(t)},this.refreshResults=async()=>{this.searchResultsUpdater.updateAllMatchesAndResults()},this.updateGroupMenu=async e=>{this.searchResultsUpdater.updateGroupActions(e.id,e.groupMenuActions)},this.selectSearchResult=async e=>{const{id:t,typeId:i}=e;if(this.searchData.selectedItemId=t,this.searchData.commit(),t&&i){const e="search_item_"+i+"_click";this.analytics.track("showcase_gui",{tool:"search",gui_action:e})}},this.changeGrouping=async e=>{this.searchData.grouping=e.grouping,this.searchData.commit()},this.toggleSearchFilter=async e=>{const{groupId:t,enabled:i}=e;this.searchData.toggleSearchFilter(t,i);this.searchData.getTypeFilters().length===Object.keys(this.searchData.dataTypeGroups).length&&this.searchData.clearTypeFilters()},this.trackQuery=(0,o.D)((()=>{const e=this.searchData.query.substring(0,1e3),t=this.searchData.getKeywordFilters().map((e=>e.trim())).sort().join(",");if(!e&&!t)return;const i=!this.hasStartedTrackingQueries&&e===this.config.urlQuery;this.analytics.track("space_search_queried",{query:e,queryKeywords:t,submittedByUrlParam:i}),this.hasStartedTrackingQueries=!0}),1e3)}async init(e,t){if(this.config=e,this.engine=t,[this.toolsData,this.appData,this.settingsData,this.analytics]=await Promise.all([t.market.waitForData(u.t),t.market.waitForData(l.pu),t.market.waitForData(c.e),t.getModuleBySymbol(n.y.ANALYTICS)]),this.bindings.push(t.subscribe(h.bS,this.onApplicationChange)),this.updateFeatureEnablement(),this.searchResultsUpdater=new Ct(this.searchData),this.enabled&&(void 0!==e.urlQuery||void 0!==e.urlQueryKeywords)){const t=decodeURIComponent(e.urlQuery||"");this.searchData.setQuery(t),this.searchData.commit();const i=decodeURIComponent(e.urlQueryKeywords||"").trim(),s=i?i.split(","):[];s.length>0&&this.searchData.setKeywordFilters(s);const n=this.toolsData.getTool(p.w1.LAYERS)?p.w1.LAYERS:p.w1.SEARCH;this.engine.commandBinder.issueCommand(new g.tT(n,!0))}t.market.register(this,M.T,this.searchData)}dispose(e){super.dispose(e),this.handlers&&this.handlers.cancel(),this.searchResultsUpdater&&this.searchResultsUpdater.dispose()}registerHandlers(){const{commandBinder:e}=this.engine;this.handlers=new a.V(this.searchData.onPropertyChanged("query",this.trackQuery),this.searchData.onPropertyChanged("keywordFilters",this.trackQuery),e.addBinding(y.Xv,this.toggleSearchMode),e.addBinding(y.H1,this.updateQuery),e.addBinding(y.FZ,this.updateQueryKeywords),e.addBinding(y.M8,this.toggleQueryKeyword),e.addBinding(y.s7,this.refreshResults),e.addBinding(y.Np,this.updateGroupMenu),e.addBinding(y.SN,this.changeGrouping),e.addBinding(y.Z4,(async e=>this.setTypeFilter(e.groupId))),e.addBinding(y.Mp,this.toggleSearchFilter),e.addBinding(y.Hf,(async()=>this.searchData.clearTypeFilters())),e.addBinding(y.IL,this.selectSearchResult),e.addBinding(y.c6,this.registerSearchGroup),e.addBinding(y.Pe,this.deregisterSearchGroup))}updateFeatureEnablement(){const e=this.appData.application===l.Mx.WORKSHOP||this.config.showcaseSearchEnabled;e!==this.enabled&&(e?(this.handlers?this.handlers.renew():this.registerHandlers(),this.addTool()):this.handlers&&this.handlers.cancel(),this.enabled=e)}addTool(){if(!this.toolsData.getTool(p.w1.SEARCH)){const e=this.settingsData.tryGetProperty(d.Wp,!1),t=this.settingsData.tryGetProperty(d.fc,!1);if(this.appData.application===l.Mx.WORKSHOP&&(e||t))return;const i=new m.U({id:p.w1.SEARCH,namePhraseKey:Rt.SEARCH,panel:!0,panelLeft:!0,icon:"icon-magnifying-glass",analytic:"search_mode",dimmed:!1,enabled:!0,hidesAppBar:!0,order:1,ui:new xt,manager:new w(this.engine)});this.engine.commandBinder.issueCommand(new g.MV([i]))}}setTypeFilter(e){e?this.searchData.setTypeFilter(e):this.searchData.clearTypeFilters()}activateSearchMode(e){const t=e||!0;this.searchData.searchMode!==t&&(this.searchData.searchMode=t,this.searchData.commit())}deactivateSearchMode(){this.searchData.searchMode&&(this.searchData.searchMode=!1,this.searchData.selectedItemId=null,this.searchData.commit())}}const Lt=At},3907:(e,t,i)=>{"use strict";i.d(t,{MU:()=>o});var s,n=i(39880),a=i(44584);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(s||(s={}));class r extends class{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,a.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class o extends r{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:i}=this.config,n=[],a=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const i of a){e[i]||t[i]||n.push(this.config.queue.delete(`${this.config.path}/${i}`,this.options))}const r=i(e,t),o=Object.assign(Object.assign({},this.options),{body:r});return n.push(this.config.queue.request(this.config.httpMethod||s.POST,this.config.path,o)),Promise.all(n)}updateInternal(e,t){const{serialize:i}=this.config,a=[],r=Object.assign({},this.options),o=Object.keys(e),h=Object.keys(t),l=(0,n.XN)(o.concat(h));for(const n in l){const o=l[n],h=e[o]||t[o];if(h){const e={};e[o]=h;const n={},l=t[o];l&&(n[o]=l);const d=i(e,n);r.body=d,a.push(this.config.queue.request(this.config.httpMethod||s.POST,this.config.path,r))}else a.push(this.config.queue.delete(`${this.config.path}/${o}`,this.options))}return Promise.all(a)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},84366:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var s=i(98010);class n extends s.v{constructor(e,t,i){super(),this.size=e,this.sweepId=t,this.renderTarget=i}}},10777:(e,t,i)=>{"use strict";i.d(t,{D:()=>n,F:()=>a});var s=i(19663);class n extends s.m{constructor(e){super(),this.id="ALLOW_HIGH_RES",this.payload={ignoreWindowSize:e}}}class a extends s.m{constructor(e){super(),this.id="SET_NAV_PANO_SIZE",this.payload={navSize:e}}}},99685:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>re});var s=i(57956),n=i(71239),a=i(56692),r=i(2224);class o extends r.y{constructor(e){super(e),this.name="PanoTilingError"}}var h=i(97998),l=i(84428),d=i(70903),c=i(90304);var u;!function(e){e[e.PreOrder=0]="PreOrder",e[e.PostOrder=1]="PostOrder"}(u||(u={}));class p{constructor(e,t){this.tree=e,this.parent=t,this.children=[],this.id=++p._id,this.extra={},this.level=-1}}p._id=0;class g{constructor(e,t){this.levels=t,this.tileSize=e,this.root=null,this.allNodes=[],w(this)}getSizeForLevel(e,t){return Math.pow(2,t)*e}getSubNode(e,t,i){(!t||e<this.tileSize)&&(t=0),(!i||e<this.tileSize)&&(i=0),e<this.tileSize&&(e=this.tileSize);const s=m(this.tileSize,e);return v(this.root,0,s,t,i)}deleteAllNodes(){this.depthFirst(function(e,t,i,s,n){for(let t=0;t<e.children.length;t++){const i=e.children[t];i&&(i.parent=null,i.tree=null),e.children[t]=null}e.children.length=0}.bind(this),null,u.PostOrder);for(let e=0;e<this.allNodes.length;e++){const t=this.allNodes[e];t&&(t.parent=null,t.tree=null),this.allNodes[e]=null}this.allNodes.length=0,this.root=null}breadthFirst(e){const t=!!(e=e||{}).nullLevelEnd,i=e.maxLevel,s=e.minLevel,n=e.callback,a=e.saveVisited,r=[],o=new p(this,null);let h=0;if(this.root)for(r.push(this.root),r.push(o);r.length>0&&!(i&&h>i);){const e=r.shift();if(e)if(e===o)(!s||h>=s)&&(n&&t&&n(),a&&t&&a.push(null)),r.length>0&&r.push(o),h++;else{if(e.children)for(const t of e.children)t&&r.push(t);const t=this.getFaceIndexFromNode(e);(!s||h>=s)&&(n&&n(e,h,t),a&&a.push(e))}}}getFaceIndexFromNode(e){if(!e)return-1;let t=1,i=e,s=0,n=0;for(;;){const e=i.parent;if(!e)break;let a=-1;for(let t=0;t<e.children.length;t++)e.children[t]===i&&(a=t);s=a%2*t+s,n=Math.floor(a/2)*t+n,t*=2,i=e}return n*t+s}depthFirst(e,t,i){y(this.root,0,0,0,e,t,i,this.tileSize)}}const m=function(e,t){let i=0;for(t<e&&(t=e);!((t/=2)<e);)i++;return i},y=function(e,t,i,s,n,a,r,o){if(!e)return;const h=2*s+i;if((r=r||u.PreOrder)===u.PreOrder&&(n&&n(e,t,h,i,s),a&&a.push(e)),!e.children||0===e.children.length)return;const l=2*s,d=2*i;for(let i=0;i<2;i++)for(let s=0;s<2;s++)y(e.children[2*s+i],t+1,d+i,l+s,n,a,r,o);r===u.PostOrder&&(n&&n(e,t,h,i,s),a&&a.push(e))},w=e=>{e.root=f(e,null,0)},f=(e,t,i)=>{if(i>e.levels)return null;const s=new p(e,t);s.level=i,e.allNodes.push(s);for(let t=0;t<4;t++){const n=f(e,s,i+1);n&&(s.children[t]=n)}return s},v=(e,t,i,s,n)=>{if(!e)return null;if(0===i)return e;{if(!e.children||0===e.children.length)return null;const a=Math.pow(2,i)/2,r=s%a,o=n%a,h=2*Math.floor(n/a)+Math.floor(s/a),l=e.children[h];return v(l,t+1,i-1,r,o)}};var b,T=i(55084),S=i(25215),D=i(27646),P=i(14766),I=i(76609),x=i(54730),M=i(48176);!function(e){e[e.Base=0]="Base",e[e.Remaining=1]="Remaining"}(b||(b={}));class E{constructor(){this.forceQueue=[],this.uploadQueues={},this.panoLODDescriptors={}}addToForceQueue(e){this.forceQueue.push(e)}addToPanoQueue(e,t){this.getUploadQueueForPano(e).push(t)}insertSortedIntoPanoQueue(e,t,i){const s=this.getUploadQueueForPano(t.id);M.at.insertSortedPanoTile(s,e,t,i)}sortQueue(e,t){const i=this.getUploadQueueForPano(e.id);M.at.sortTiles(i,e,t)}getUploadQueueForPano(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}hasQueuedTiles(){if(this.forceQueue.length>0)return!0;for(const e in this.uploadQueues){const t=this.getUploadQueueForSweep(e);if(t&&t.length>0)return!0}return!1}getUploadQueueForSweep(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}getTopUploadQueue(e){let t=null;for(let i=b.Base;i<=b.Remaining;i++)for(const s of e)if(t=this.getUploadQueueForSweep(s.id),t.length>0)switch(i){case b.Base:if(0===t[0].level)return t;break;case b.Remaining:return t}return null}processNextQueueItem(e){const t=e.shift();return t?(t.uploadQueued=!1,t):null}getNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.processNextQueueItem(this.forceQueue);const t=this.getTopUploadQueue(e);return t&&t.length>0?this.processNextQueueItem(t):null}peekNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.forceQueue[0];const t=this.getTopUploadQueue(e);return t&&t.length>0?t[0]:null}clearAllQueuedUploads(){this.clearAllUploadQueues(null,0)}clearAllUploadQueues(e,t=0){if(e)this.clearUploadQueue(this.getUploadQueueForSweep(e),t),this.clearUploadQueue(this.forceQueue,t,e);else{for(const e in this.uploadQueues)this.clearUploadQueue(this.getUploadQueueForSweep(e),t);this.clearUploadQueue(this.forceQueue,t)}}clearUploadQueue(e,t=0,i){let s=0;for(;s<e.length;){const n=e[s];(!i||i&&i===n.sweepId)&&n.level>=t?(n.uploadQueued=!1,e.splice(s,1)):s++}}resetPanoLODDescriptors(e){const t=this.getPanoLODDescriptors(e);for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];i.uploadCount=0,i.uploadAttempts=0}}getPanoLODDescriptor(e,t){const i=this.getPanoLODDescriptors(e);let s=i[t];return s||(s={uploadCount:0,uploadAttempts:0},i[t]=s),s}getPanoLODDescriptors(e){let t=this.panoLODDescriptors[e];return t||(t={},this.panoLODDescriptors[e]=t),t}}var C=i(84366),R=i(39880),A=i(60047),L=i(40505),O=i(947);const F=new h.Z("tiles"),k=n.Xd.uploadIntervalDelay;class B extends S.Z{constructor(e,t,i,s,n,a,r){super(s.getSweepList()),this.cwfRenderer=e,this.panoQualityManager=t,this.tileDownloader=i,this.sweepData=s,this.cameraData=n,this.tilingSettings=a,this.broadcast=r,this.persistentStorage=new x.a,this.activeSweeps=[],this.sweepLoadHistory=[],this.activeRenderTargetDescriptors={},this.panoLoadPromises={},this.panoLoadResolvers={},this.panoLoadTimers={},this.tileTrees={},this.tileDirectory={},this.zoomSweepRenderingDisabled=!1,this.zoomingActive=!1,this.zoomSweepId=null,this.usingTileOverlay=!1,this.overlayTilesLoaded=!1,this.overlayTilesBasic={},this.overlayTilesEnhanced={},this.tileUploadQueue=new E,this.currentState={direction:new l.Vector3,position:new l.Vector3,rotation:new l.Quaternion},this.renderTargetPool=new d.L(this.rtCompare),this.tileDownloader.setModel(this.sweepListMap),this.tileDownloader.setLoadCallbacks(this.onTileDownLoaded.bind(this))}activate(e){this.engine=e}rtCompare(e,t){return e.object.height===t.size&&e.object.width===t.size}getActivePanos(){const e=[];for(const t of Object.keys(this.activeRenderTargetDescriptors)){this.activeRenderTargetDescriptors[t]&&e.push(t)}return e}init(){super.init(),this.loadOverlayTiles()}highResRenderTarget(e,t){if(e){if(!t)throw new o("Cannot activate zooming without sweepId!");this.zoomingActive=!0,this.zoomSweepId=t,this.copyTargetToZoom(t)}else this.zoomingActive=!1,this.zoomSweepId=null;if(t){const e=this.getRenderTargetDescriptorForSweep(t);if(!e)throw new o("Zooming at a null render target!");const i=this.zoomingActive?this.zoomRenderTarget:e.object,s=i.width;this.broadcast(new C.Z(s,t,i))}}getCurrentPanoResolution(){const e=this.zoomingActive?this.panoQualityManager.getZoomPanoSize():this.panoQualityManager.getNavPanoSize();return D.Z.getPanoSizeClass(e)}beforeRender(){const e=this.sweepData.currentSweep,t=this.sweepData.transition.to;this.updateState(this.cameraData.pose.position,this.cameraData.pose.rotation,e,t),this.updateUploadQueueProcessing()}activateSweep(e){const t=this.sweepListMap.get(e);if(!t)throw F.error(e,t),new o("Invalid sweepId passed to TiledPanoRenderer.activate()");let i=this.panoLoadPromises[e];return i||(this.panoLoadTimers[e]=window.setTimeout((()=>{this.engine.broadcast(new L.Z_(!0))}),n.Xd.loadIndicatorDelay),i=new Promise(((i,s)=>{this.panoLoadResolvers[e]=i,this.updateSweepState(e),this.activatePano(t),this.queueUploadForAllTiles(e,!0),this.tileDownloader.forceQueueTiles(t,D.Z.getPanoSize(I.SL.BASE),this.currentState.direction,!0)})),this.panoLoadPromises[e]=i),super._activateSweep(e),i}useTexture(e){const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw F.error(e),new o("Texture for sweep not activated before using");const i=t.object.texture;return super._useTexture(e),this.freeUnusedTextures(),this.zoomingActive?this.zoomRenderTarget.texture:i}freeTexture(e,t=!1){super.freeTexture(e,t),0===this.textureUsageCounter[e]&&(this.panoLoadPromises[e]=null,this.deactivatePano(e))}freeAllTextures(e=[]){const t=(0,R.ow)(e),i=this.getActivePanos();for(const e of i)t[e]||this.freeTexture(e,!0)}enableUltraHighQualityMode(e){this.setupZoomRenderTarget(),this.zoomSweepId&&this.broadcast(new C.Z(this.zoomRenderTarget.width,this.zoomSweepId,this.zoomRenderTarget))}resetRenderStatus(e,t,i,s){let n;s&&(n=m(T.I_,s)+1);const a=(e,s,n,a)=>{i&&(s.extra.tile.zoomUploaded=!1),t&&(s.extra.tile.uploaded=!1)};for(let t=0;t<T.Hq;t++){this.getTileTree(e,t).breadthFirst({callback:a.bind(this,t),minLevel:n})}}copyBaseRenderStatusToZoomed(e){const t=m(T.I_,this.panoQualityManager.getNavPanoSize()),i=(e,t,i,s)=>{t.extra.tile.zoomUploaded=t.extra.tile.uploaded,t.extra.zoomCovered=t.extra.covered};for(let s=0;s<T.Hq;s++){this.getTileTree(e,s).breadthFirst({callback:i.bind(this,s),maxLevel:t})}}renderPanoTiles(e,t,i,s){const n=[];this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget(),t=t||this.currentState.direction||c.f.FORWARD;const a=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(a))throw new o("PanoRenderer.renderPanoTiles() -> Cannot render to a pano that is not activated.");for(let t=0;t<T.Hq;t++){const a=this.getTileTree(e,t);n.length=0,a.breadthFirst({saveVisited:n});for(let e=0;e<n.length;e++){const t=n[e];this.queueUploadForTile(t.extra.tile,!1,s||0===e&&i)}}}renderAllActivePanos(){for(const e of this.getActivePanos())this.resetUploadState(e,!0,!0),this.clearAllQueuedUploadsForPano(e),this.renderPanoTiles(e,null,!0,!0)}clearAllQueuedUploads(){this.tileUploadQueue.clearAllUploadQueues(null,0)}clearAllQueuedUploadsForPano(e){this.tileUploadQueue.clearAllUploadQueues(e,0)}updateState(e,t,i,s){const n=s||i||this.currentState.sweepId,a=n?this.sweepListMap.get(n):null;this.updatePositionState(e),this.updateRotationState(t),n&&this.updateSweepState(n),a&&this.tileDownloader.tilePrioritizer&&this.tileDownloader.tilePrioritizer.updateCriteria(a,e,this.currentState.direction,this.currentState.rotation)}updatePositionState(e){this.currentState.position.copy(e)}updateRotationState(e){if(this.currentState.rotation.copy(e),this.currentState.direction.copy(c.f.FORWARD).applyQuaternion(e),this.tileUploadQueue.hasQueuedTiles())for(const e of this.activeSweeps)this.tileUploadQueue.sortQueue(e,this.currentState.direction)}updateSweepState(e){this.currentState.sweepId=e}activatePano(e){this.tileUploadQueue.clearAllQueuedUploads();const t=this.panoQualityManager.getMaxPossiblePanoSize();for(let i=0;i<T.Hq;i++)this.initTileTree(e.id,i,t);this.linkAllTilesAndNodes(e);let i=this.getRenderTargetDescriptorForSweep(e.id);if(!i){const t=this.panoQualityManager.getNavPanoSize();if(i=this.renderTargetPool.get({size:t}),!i){const e=this.cwfRenderer.initRenderTargetCube(t);i=this.renderTargetPool.add(e),i.extra={},i.extra.size=e.width}i.extra.sweep=e,i.extra.sweepindex=e.index,this.setRenderTargetDescriptorForSweep(e.id,i),this.tileUploadQueue.resetPanoLODDescriptors(e.id),this.resetUploadState(e.id,!0,!0)}return this.updateActiveSweeps(e),i.object}deactivatePano(e){const t=this.getRenderTargetDescriptorForSweep(e);t&&this.isRenderTargetDescriptorValid(t)&&(this.renderTargetPool.free(t.object),this.setRenderTargetDescriptorForSweep(e,null),this.updateActiveSweeps(),this.tileUploadQueue.clearAllUploadQueues(e),this.tileUploadQueue.resetPanoLODDescriptors(e),this.clearCachedTileData())}clearCachedTileData(){for(let e=this.sweepLoadHistory.length-1;e>=0;e--){let t=!1;const i=this.sweepLoadHistory[e];if(i){for(const e of this.activeSweeps)if(i===e.id){t=!0;break}t||(this.checkTileTreeInitialized(i)&&(this.clearTileState(i,!0,!0),this.deleteTileTrees(i)),this.deleteTileDirectoryEntries(i),this.tileDownloader.deleteAllTileDownloadDescriptors(i),this.sweepLoadHistory[e]=null)}}this.updateSweepLoadHistory()}updateActiveSweeps(e){const t=this.persistentStorage.getArray("updateActiveSweeps:tempSweeps");t.length=0;for(const i of this.activeSweeps){const s=this.getRenderTargetDescriptorForSweep(i.id);e&&i.id===e.id||!this.isRenderTargetDescriptorValid(s)||t.push(i)}e&&t.unshift(e),this.activeSweeps.length=0,this.activeSweeps.push(...t)}queueUploadForAllTiles(e,t=!0){this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget();const i=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(i))throw new o("queueUploadForAllTiles() -> Cannot render to a pano that is not activated.");const s=this.persistentStorage.getArray("queueUploadForAllTiles:nodeList");for(let i=0;i<T.Hq;i++){const n=this.getTileTree(e,i);s.length=0,n.breadthFirst({saveVisited:s});for(const e of s)this.queueUploadForTile(e.extra.tile,!1,0===e.level&&t)}}onTileDownLoaded(e){if(!e.sweep)return;const t=m(T.I_,e.panoSize),i=this.getTileDirectoryEntry(e.sweep.id,e.face,t,e.faceTileIndex);this.updateUploadDescriptorFromDownloadDescriptor(i,e),this.updateSweepLoadHistory(i.sweepId);const s=this.getRenderTargetDescriptorForSweep(i.sweepId);if(this.isRenderTargetDescriptorValid(s)){const e=this.getTileTree(i.sweepId,i.face).getSubNode(i.panoSize,i.tileX,i.tileY);e&&(this.linkTileAndNode(i,e),this.queueUploadForTile(i,!0))}}updateUploadDescriptorFromDownloadDescriptor(e,t){e.downloaded=!0,e.image=t.image,e.panoSize=t.panoSize,e.tileX=t.tileX,e.tileY=t.tileY,e.totalTiles=t.totalTiles,e.tileIndex=t.tileIndex,e.faceTileIndex=t.faceTileIndex,e.face=t.face,e.cubeFace=P.m(t.face),t.sweep&&(e.sweepId=t.sweep.id),e.tileSize=t.tileSize,e.direction.copy(t.direction),e.node=null,e.level=m(T.I_,e.panoSize)}updateSweepLoadHistory(e){const t=this.persistentStorage.getArray("updateSweepLoadHistory:tempHistory");t.length=0;for(const i of this.sweepLoadHistory)i&&(!e||e&&e!==i)&&t.push(i);this.sweepLoadHistory.length=0,e&&this.sweepLoadHistory.push(e),this.sweepLoadHistory.push(...t)}onPanoRendered(e,t,i,s){clearTimeout(this.panoLoadTimers[e]),this.engine.broadcast(new L.Z_(!1));const n=this.panoLoadResolvers[e],a=this.activeRenderTargetDescriptors[e];a&&a.object&&n(a.object.texture)}getRenderTargetDescriptorForSweep(e){return this.activeRenderTargetDescriptors[e]}setRenderTargetDescriptorForSweep(e,t){this.activeRenderTargetDescriptors[e]=t}isRenderTargetDescriptorValid(e){return!!e&&!!e.object}isSweepZoomed(e){return this.zoomingActive&&this.zoomSweepId===e}initTileTree(e,t,i){let s=this.tileTrees[e];s||(s=[],this.tileTrees[e]=s);let n=s[t];if(!n){const e=m(T.I_,i);n=new g(T.I_,e),s[t]=n}}getTileTrees(e){const t=this.tileTrees[e];if(!t)throw new o("TiledPanoRenderer.getTileTrees() -> Tree array not yet initialized!");return t}checkTileTreeInitialized(e){return!!this.tileTrees[e]}getTileTree(e,t){const i=this.getTileTrees(e)[t];if(!i)throw new o("TiledPanoRenderer.getTileTree() -> Tree not yet initialized!");return i}deleteTileTrees(e){const t=this.getTileTrees(e);for(let e=0;e<T.Hq;e++){const i=t[e];i&&i.deleteAllNodes()}this.tileTrees[e]=null,delete this.tileTrees[e]}clearTileState(e,t=!1,i=!1){const s=(e,s,n,a)=>{var r,o;i&&(null===(o=null===(r=s.extra.tile.image)||void 0===r?void 0:r.close)||void 0===o||o.call(r),s.extra.tile.image=null),t&&(s.extra.tile.uploaded=!1,s.extra.tile.downloaded=!1,s.extra.tile.zoomUploaded=!1,s.extra.tile.uploadAttempted=!1)};for(let t=0;t<T.Hq;t++){const i=this.getTileTree(e,t);i&&i.breadthFirst({callback:s.bind(this,t),maxLevel:m(T.I_,this.panoQualityManager.getZoomPanoSize())})}}resetUploadState(e,t,i){const s=(e,s,n,a)=>{s.extra.tile.zoomUploaded=!i&&s.extra.tile.zoomUploaded,s.extra.tile.uploaded=!t&&s.extra.tile.uploaded};for(let t=0;t<T.Hq;t++){this.getTileTree(e,t).breadthFirst({callback:s.bind(this,t),minLevel:0})}}anyUploaded(e){if(!e)return!1;if(e.extra.tile&&this.isTileUploaded(e.extra.tile))return!0;if(e.children)for(const t of e.children)if(this.anyUploaded(t))return!0;return!1}linkTileAndNode(e,t){t.extra.tile=e,e.node=t}linkAllTilesAndNodes(e){const t=(t,i,s,n,a)=>{const r=this.getTileDirectoryEntry(e.id,i,n,a);this.linkTileAndNode(r,s)};for(let i=0;i<T.Hq;i++){const s=this.getTileTree(e.id,i);s.breadthFirst({callback:t.bind(this,s,i)})}}getTileDirectoryEntry(e,t,i,s){let n=this.tileDirectory[e];n||(n={},this.tileDirectory[e]=n);const a=16384*t+1024*i+s;let r=n[a];return r||(r={downloaded:!1,uploaded:!1,uploadAttempted:!1,zoomUploaded:!1,uploadQueued:!1,image:null,panoSize:-1,tileX:-1,tileY:-1,totalTiles:-1,tileIndex:s,faceTileIndex:-1,face:t,cubeFace:-1,sweepId:e,tileSize:-1,direction:new l.Vector3,node:null,level:i},n[a]=r),r._tileKey=a,r}deleteTileDirectoryEntries(e){var t,i;const s=this.tileDirectory[e];if(s)for(const e of Object.values(s))e.image&&(null===(i=(t=e.image).close)||void 0===i||i.call(t),e.image=null);delete this.tileDirectory[e]}isTileUploaded(e){return this.isSweepZoomed(e.sweepId)?e.zoomUploaded:e.uploaded}setUploaded(e,t){this.isSweepZoomed(e.sweepId)?e.zoomUploaded=t:e.uploaded=t}queueUploadForTile(e,t,i){const s=!e.downloaded||e.uploadQueued&&!i||this.isTileUploaded(e)||e.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive,n=this.getRenderTargetDescriptorForSweep(e.sweepId);!s&&n&&this.isRenderTargetDescriptorValid(n)&&(i?this.uploadTile(e):(0===m(T.I_,e.panoSize)?this.tileUploadQueue.addToForceQueue(e):t&&this.currentState.direction?this.tileUploadQueue.insertSortedIntoPanoQueue(e,n.extra.sweep,this.currentState.direction):this.tileUploadQueue.addToPanoQueue(e.sweepId,e),e.uploadQueued=!0))}uploadTile(e){const t=this.persistentStorage.get("uploadTile:tempTileTexture",(()=>({}))),i=this.tileUploadQueue.getPanoLODDescriptor(e.sweepId,e.panoSize),s=this.getRenderTargetDescriptorForSweep(e.sweepId);if(!s||!e.image||!this.isRenderTargetDescriptorValid(s))return;let a=s.object,r=s.extra.size;if(this.isSweepZoomed(e.sweepId)&&(a=this.zoomRenderTarget,r=this.panoQualityManager.getZoomPanoSize()),this.isTileUploaded(e)||this.anyUploaded(e.node))this.setUploaded(e,!1);else{const s=e.tileX*e.tileSize,o=e.tileY*e.tileSize,h=e.tileSize/e.panoSize*r,d=s/e.panoSize*r,c=o/e.panoSize*r;let u=t[e.tileSize];if(t[e.tileSize]||(u=this.cwfRenderer.initSizedTexture2D(e.tileSize,{generateMipmaps:!1,minFilter:l.LinearFilter,flipY:!1}),t[e.tileSize]=u),this.cwfRenderer.uploadTexture2D(e.image,u,0,0),this.cwfRenderer.renderToCubeMap(u,a,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,d,c,h,h,e.cubeFace),n.Xd.overlayStyle>0){const t=1===n.Xd.overlayStyle?this.overlayTilesBasic:this.overlayTilesEnhanced;this.cwfRenderer.renderToCubeMap(t[e.panoSize],a,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,d,c,h,h,e.cubeFace,l.NormalBlending,!0,.5)}i.uploadCount++,this.setUploaded(e,!0)}e.uploadAttempted||i.uploadAttempts++,e.uploadAttempted=!0,i.uploadAttempts===e.totalTiles&&this.onPanoRendered(e.sweepId,e.panoSize,e.totalTiles)}updateUploadQueueProcessing(){if(!this.currentUploadPromise&&(this.overlayTilesLoaded||!this.usingTileOverlay)){const e=new A._("pano/tiling/upload",(()=>this.engine.after(O.A.End).then((()=>this.processUploadQueue(this.tilingSettings.highResUploadsPerFrame,this.tilingSettings.uploadsPerFrame)))),k);this.currentUploadPromise=this.engine.commandBinder.issueCommand(e).then((async e=>{await e.promise,this.currentUploadPromise=null}))}}processUploadQueue(e=1,t){let i=0,s=0,n=null;for(;n=this.tileUploadQueue.getNextFromUploadQueue(this.activeSweeps);){const a=this.getRenderTargetDescriptorForSweep(n.sweepId);if(!(n.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive||!this.isRenderTargetDescriptorValid(a))&&(this.uploadTile(n),i+=0!==n.level?1:0,s+=0===n.level?1:0,s>=t||i>=e))break}}loadOverlayTiles(){if(0!==n.Xd.overlayStyle){let e=0;const t=[],s=(i,s,n)=>{const a=i[s]=this.cwfRenderer.initSizedTexture2D(T.I_,{generateMipmaps:!1,minFilter:l.LinearFilter,flipY:!1});this.cwfRenderer.uploadTexture2D(n,a,0,0),e++,e>=t.length&&(this.overlayTilesLoaded=!0)};switch(n.Xd.overlayStyle){case 1:t.push([i(67929),this.overlayTilesBasic,256]),t.push([i(67929),this.overlayTilesBasic,512]),t.push([i(27273),this.overlayTilesBasic,1024]),t.push([i(15278),this.overlayTilesBasic,2048]),t.push([i(92787),this.overlayTilesBasic,4096]);break;case 2:t.push([i(33967),this.overlayTilesEnhanced,256]),t.push([i(33967),this.overlayTilesEnhanced,512]),t.push([i(53896),this.overlayTilesEnhanced,1024]),t.push([i(38343),this.overlayTilesEnhanced,2048]),t.push([i(73965),this.overlayTilesEnhanced,4096])}t.forEach((e=>{const t=document.createElement("img");t.crossOrigin="anonymous",t.src=e[0],t.onload=()=>{s.call(this,e[1],e[2],t)}})),this.usingTileOverlay=!0}else this.usingTileOverlay=!1}copyTargetToZoom(e){if(!this.zoomingActive)return;const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw new o("Error in copying a null render target to a zoomed target");const i=t.object;this.cwfRenderer.copyCubemap(i.texture,this.zoomRenderTarget),this.copyBaseRenderStatusToZoomed(e)}setupZoomRenderTarget(){if(this.panoQualityManager.getZoomPanoSize()>=this.panoQualityManager.getNavPanoSize()){if(this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize())return;const e=this.zoomRenderTarget;this.zoomRenderTarget=this.cwfRenderer.initRenderTargetCube(this.panoQualityManager.getZoomPanoSize()),e&&(this.cwfRenderer.copyCubemap(e.texture,this.zoomRenderTarget),e.texture.dispose(),e.texture.version=0,e.texture=null),this.zoomSweepRenderingDisabled=!1}else this.zoomSweepRenderingDisabled=!0}}var N=i(77382),G=i(55721),_=i(53261),U=i(74789);const z=new h.Z("tile-downloader");class V{constructor(e,t,i,s){this.urls=e,this.panoQualityManager=t,this.tilePrioritizer=i,this.settings=s,this.persistentStorage=new x.a,this.downloadDescriptors={},this.priorityQueue=[],this.forceQueue=[],this.activeDownloads=[],this.lastPrioritizedTime=Date.now(),this.processPriorityQueue=!0}init(){}render(){this.update()}update(){this.processQueue(this.forceQueue,!1),this.processPriorityQueue&&(!this.processQueuePromise&&this.sweepListMap&&this.activeDownloads.length<this.settings.concurrentDownloads&&Date.now()-this.lastPrioritizedTime>200&&(this.processQueuePromise=this.engine.commandBinder.issueCommand(new A._("pano/tiling/queue-download",(()=>{this.queuePrioritizedTiles(this.sweepListMap),this.lastPrioritizedTime=Date.now()}),100)).then((async e=>{await e.promise,this.processQueuePromise=null}))),this.processQueue(this.priorityQueue,!1))}dispose(){}activate(e){this.engine=e}deactivate(e){}setModel(e){this.setSweeps(e)}setRestrictedSweeps(e){if(this.sweepListMap&&this.tilePrioritizer){const t=[];for(const i of e)t.push(this.sweepListMap.get(i));this.tilePrioritizer.setUpcomingSweeps(t),this.clearFromAllQueuesBySweep(e)}}clearRestrictedSweeps(){this.tilePrioritizer&&this.tilePrioritizer.clearUpcomingSweeps()}setLoadCallbacks(e,t){this.onTileDownloaded=e,this.onPanoDownloaded=t}setSweeps(e){this.sweepListMap=e}getNonDownloadedTiles(e,t,i){i.length=0;const s=this.getTileDownloadDescriptors(e,t);for(const e of s)!e||e.status!==G.Z.None&&e.status!==G.Z.Queued||i.push(e)}forceQueueTiles(e,t,i,s,n,a){const r=this.persistentStorage.getArray("forceQueueTiles:remaining"),o=this.persistentStorage.getArray("forceQueueTiles:matching"),h=this.persistentStorage.getArray("forceQueueTiles:toDownload");if(this.getNonDownloadedTiles(e,t,r),h.length=0,r.length>0){M.at.sortTiles(r,e,i),o.length=0,T.oU(e,t,i,o,!0);for(const e of r)for(const t of o)e.face===t.face&&e.faceTileIndex===t.faceTileIndex&&h.push(e);this.forceQueue.push.apply(this.forceQueue,h),this.setStatusForAllDescriptors(this.forceQueue,G.Z.ForceQueued),this.clearFromQueue(this.priorityQueue,G.Z.ForceQueued,!1),s&&this.processQueue(this.forceQueue,!0)}}clearForceQueue(){this.clearQueue(this.forceQueue)}queuePrioritizedTiles(e){this.tilePrioritizer&&(this.clearQueue(this.priorityQueue),this.tilePrioritizer.filterAndPrioritize(this.priorityQueue,e,this),this.invalidateDuplicateEntries(this.priorityQueue),this.clearFromQueue(this.priorityQueue,G.Z.None,!0),this.setStatusForAllDescriptors(this.priorityQueue,G.Z.Queued),this.lastPrioritizedTime=Date.now())}clearQueue(e){this.setStatusForAllDescriptors(e,G.Z.None),e.length=0}clearFromQueue(e,t,i){for(let s=0;s<e.length;s++){const n=e[s];n&&(t===n.status&&!i||t!==n.status&&i)&&(e[s]=null)}}clearFromAllQueuesBySweep(e){this.clearFromQueueBySweep(this.forceQueue,e),this.clearFromQueueBySweep(this.priorityQueue,e)}clearFromQueueBySweep(e,t){const i=(0,R.ow)(t);for(let t=0;t<e.length;t++){const s=e[t];s&&s.sweep&&(i[s.sweep.id]||(e[t]=null))}}setStatusForAllDescriptors(e,t){for(const i of e)i&&(i.status=t)}invalidateDuplicateEntries(e){for(const t of e)t&&(t.queuedCount=0);for(let t=0;t<e.length;t++){const i=e[t];i&&(i.queuedCount++,i.queuedCount>1&&(e[t]=null))}}getTileDownloadDescriptors(e,t){const i=this.getAllTileDownloadDescriptors(e.id);let s=i[t];return s||(s=this.buildDownloadDescriptorArray(t),i[t]=s,this.initTileDownloadDescriptors(s,e,t)),s}getAllTileDownloadDescriptors(e){let t=this.downloadDescriptors[e];return t||(t={},this.downloadDescriptors[e]=t),t}deleteAllTileDownloadDescriptors(e){this.downloadDescriptors[e]=null,delete this.downloadDescriptors[e]}processQueue(e,t){if(this.cleanupActiveDownloads(),this.activeDownloads.length<this.settings.concurrentDownloads||t){const i=t?e.length:this.settings.concurrentDownloads-this.activeDownloads.length;let s=0;for(let t=0;s<i&&e.length>0;t++){const t=e.shift();t&&(this.startDownload(t),s++)}}}async startDownload(e){if(!this.urls)throw new Error("Can't call startDownload without signed urls");if(e.sweep){const t=e.status===G.Z.ForceQueued?_.ru.HIGHEST:_.ru.MEDIUM;e.status=G.Z.Downloading;this.checkRestrictedSweep(e.sweep.id)||z.warn("Downloading a tile that is not in restricted list"),this.activeDownloads.push(e);const i=await this.panoQualityManager.getTileUrl(e.sweep,e.panoSize,e.tileSize,e.tileIndex);this.urls.getImageBitmap(i,e.tileSize,e.tileSize,{maxRetries:3,priority:t}).then(this.downloadComplete.bind(this,e),this.downloadFailed.bind(this,e))}}checkRestrictedSweep(e){if(this.tilePrioritizer){const t=this.tilePrioritizer.priorityCriteria.upcomingSweeps;if(t){let i=!1;for(const s of t)s&&s.id===e&&(i=!0);return i}return!0}return!0}downloadFailed(e,t){e.status=G.Z.DownloadFailed}downloadComplete(e,t){if(e.sweep&&(e.status=G.Z.Downloaded,e.image=t,this.onTileDownloaded&&this.onTileDownloaded(e),this.engine.broadcast(new U.o),this.isPanoDownloaded(e.sweep,e.panoSize))){const t={sweep:e.sweep,tileSize:e.tileSize,panoSize:e.panoSize};this.onPanoDownloaded&&this.onPanoDownloaded(t)}}cleanupActiveDownloads(){const e=this.persistentStorage.getArray("cleanupActiveDownloads:temp");e.length=0;for(const t of this.activeDownloads)t.status!==G.Z.Downloaded&&t.status!==G.Z.DownloadFailed&&e.push(t);this.activeDownloads.length=0,this.activeDownloads.push.apply(this.activeDownloads,e)}isPanoDownloaded(e,t){const i=this.getTileDownloadDescriptors(e,t);if(!i||i.length<=0)return!1;for(const e of i)if(e&&e.status!==G.Z.Downloaded)return!1;return!0}buildDownloadDescriptorArray(e){const t=T.Tu(e),i=[];for(let e=0;e<t;e++){const e=this.buildDownloadDescriptor();i.push(e)}return i}buildDownloadDescriptor(){return{sweep:null,panoSize:-1,tileSize:-1,tileIndex:-1,totalTiles:-1,faceTileIndex:-1,status:G.Z.None,url:null,image:null,direction:new l.Vector3,face:-1,cubeFace:-1,tileX:-1,tileY:-1,queuedCount:-1}}initTileDownloadDescriptors(e,t,i){for(let s=0;s<e.length;s++){const n=e[s];n&&this.initTileDownloadDescriptor(n,t,i,s)}}initTileDownloadDescriptor(e,t,i,s){const n=i>=T.I_?T.I_:i;e.face=T.R5(i,s),e.cubeFace=P.m(e.face),e.sweep=t,e.panoSize=i,e.tileSize=n,e.tileIndex=s,e.totalTiles=T.Tu(i),e.status=G.Z.None,e.image=null,T.Tp(e.panoSize,e.tileIndex,e),T.P6(e.panoSize,e.tileSize,e.cubeFace,e.tileX,e.tileY,N.Z.Center,0,e.direction)}}var j=i(46368),Q=i(9699),H=i(53954),W=i(5231),Y=i(20387),Z=i(25985),q=i(46950),X=i(34029),K=i(10777),$=i(85992),J=i(18930),ee=i(69505),te=i(61948),ie=i(79596),se=i(2032),ne=i(90365),ae=i(92901);class re extends W.Z{constructor(){super(...arguments),this.name="sweep-pano-tiling",this.preloadQuality=null,this.preloadResolution=null,this.handlePlayerResize=(e,t)=>{const i=this.currentResolution();this.panoRenderer.panoQualityManager.setWindowSize(e.width,e.height);i!==this.currentResolution()&&t&&this.resetPano(t)}}async init(e,t){const{market:i}=t,[r,o,h,l]=await Promise.all([t.getModuleBySymbol(s.y.MODEL_DATA),t.getModuleBySymbol(s.y.WEBGL_RENDERER),i.waitForData(H.Z),i.waitForData($.P)]);[this.cameraData,this.settingsData]=await Promise.all([i.waitForData(Z.M),i.waitForData(X.e)]);const d=o.cwfRenderer,c=o.maxCubemapSize,u=r.getSignedUrls();this.settings=new n.k4,this.qualityManager=new D.Z(u,c,e.navPanoSize,e.zoomPanoSize),this.tilePrioritizer=new M.at(this.qualityManager,this.settings,h,l),t.getModuleBySymbol(s.y.MESH_QUERY).then((e=>this.tilePrioritizer.meshQuery=e)),this.tileDownloader=new V(u,this.qualityManager,this.tilePrioritizer,this.settings),this.panoRenderer=new B(d,this.qualityManager,this.tileDownloader,h,this.cameraData,this.settings,(e=>t.broadcast(e))),t.addComponent(this,this.tileDownloader),t.addComponent(this,this.panoRenderer),this.bindings.push(t.subscribe(te.Z,(e=>{this.setTilingFOV()})),t.subscribe(a.a,(e=>{this.handlePlayerResize(e,h.currentSweep),this.setTilingFOV()})),t.subscribe(j.Z,(e=>{this.tileDownloader.setRestrictedSweeps(e.sweepIds)})),t.subscribe(Q.Z,(e=>{this.tileDownloader.clearRestrictedSweeps()})),t.subscribe(J.Z,(e=>{const t=h.getSweep(e.sweepId);this.setHoverPreloadSweep(e.hovered?t:void 0)})),t.subscribe(ie.a,(e=>{this.tilePrioritizer.priorityCriteria.viewMode=e.toMode})),h.onPropertyChanged("transitionActive",(()=>{if(h.transition.to){const e=h.getSweep(h.transition.to);this.handlePreloadQualityChange(e)}})),this.settingsData.onPropertyChanged(n.YS,(()=>{this.preloadQuality=this.settingsData.tryGetProperty(n.YS,null),this.qualityManager.overrideWindowMaximums(null!==this.preloadQuality),h.currentSweepObject&&this.handlePreloadQualityChange(h.currentSweepObject)})),t.commandBinder.addBinding(K.D,(async e=>{this.qualityManager.overrideWindowMaximums(e.ignoreWindowSize)})),t.commandBinder.addBinding(K.F,(async e=>{this.qualityManager.updateNavPanoSize(e.navSize)})),t.subscribe(ae.zq,(()=>{this.panoRenderer.clearAllQueuedUploads()})),t.subscribe(ae.Xq,(()=>{this.panoRenderer.renderAllActivePanos()}))),this.setTilingFOV(),t.broadcast(new se.em(ne.Y.PanoTiles))}setTilingFOV(){const e=this.cameraData.fovX(),t=this.cameraData.fovY(),i=Math.max(e,t)*ee.MN;this.tilePrioritizer.setDownloadFOV(i)}getRenderer(){return this.panoRenderer}setHoverPreloadSweep(e){this.tilePrioritizer&&this.tilePrioritizer.setHoveredSweep(e)}async handlePreloadQualityChange(e){if(null!==this.preloadQuality){const t=await this.availableResolution(e,this.preloadQuality);this.preloadResolution=D.Z.getPanoSize(t)}else this.preloadResolution=null;this.enableHighRes(!1)}enableHighRes(e=!0,t){const i=null!==this.preloadResolution?this.preloadResolution:e?this.qualityManager.getZoomPanoSize():this.qualityManager.getNavPanoSize();this.tilePrioritizer.maxResolution!==i&&this.log.debug(`Setting max resolution: ${i}`),this.tilePrioritizer.maxResolution=i,this.panoRenderer.highResRenderTarget(e,t)}async enableZooming(e,t){if(e){const e=D.Z.getPanoSizeClass(this.qualityManager.getZoomPanoSize());return await this.requestResolution(t,e)>=e}return this.enableHighRes(!1,t.id),this.resetPano(t.id),Promise.resolve(!1)}async requestResolution(e,t,i=Y.v.CurrentView,s=!1){this.settings.highResUploadsPerFrame=s?n.Xd.maxHighResUploadsPerFrame:n.Xd.highResUploadsPerFrame,this.settings.concurrentDownloads=s?n.Xd.maxConcurrentDownloads:n.Xd.concurrentDownloads,this.settings.downloadFullPano=i===Y.v.FullPanorama;const a=await this.availableResolution(e,t);return a>I.SL.HIGH&&(this.qualityManager.overrideWindowMaximums(!0),this.panoRenderer.enableUltraHighQualityMode(e.id)),(this.currentResolution()<a||D.Z.getPanoSize(a)>this.qualityManager.getNavPanoSize())&&(this.enableHighRes(!0,e.id),this.resetPano(e.id)),a}waitForQueue(e,t,i=1e3){const s=new q.Q,n=()=>{o.cancel(),s.notify(1),s.resolve()};let a=this.tilePrioritizer.getQualityQueueSize(e,t),r=window.setTimeout((()=>{this.log.debug(`Download queue ${e} timed out from inactivity after ${i}ms`),n()}),i);const o=this.tilePrioritizer.makeQueueSubscription(e,t,(e=>{if(r&&(window.clearTimeout(r),r=0,a=e),e>0){const t=(a-e)/Math.max(a,1);s.notify(t)}else n()}));return s.promise()}resetSweep(e){this.enableHighRes(!1,e),this.resetPano(e),this.settings.reset()}availableResolution(e,t){return this.qualityManager.availableResolution(e,t).nativePromise()}currentResolution(){return this.panoRenderer.getCurrentPanoResolution()}resetPano(e){this.panoRenderer.resetRenderStatus(e,!1,!0,this.panoRenderer.panoQualityManager.getNavPanoSize()),this.panoRenderer.clearAllQueuedUploadsForPano(e),this.panoRenderer.renderPanoTiles(e,null,!1,!1)}}},25215:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var s=i(63252),n=i(48917);const a=class{constructor(e){this.textureUsageCounter={},this.sweepList=e;const t=new n.Z((e=>e.id));for(let e of this.sweepList)e.isObservableProxy&&(e=(new s.ZP).copy(e)),t.add(e);this.sweepListMap=t}init(){}dispose(){}activate(e){}deactivate(e){}beforeRender(){}render(){}_activateSweep(e){this.initTextureUsage(e)}_useTexture(e){this.incrementTextureUsage(e)}freeTexture(e,t=!1){t?this.setTextureUsage(e,0):this.decrementTextureUsage(e)}initTextureUsage(e){this.textureUsageCounter[e]||(this.textureUsageCounter[e]=0)}setTextureUsage(e,t){this.textureUsageCounter[e]=t}freeUnusedTextures(){for(const e of Object.keys(this.textureUsageCounter))0===this.textureUsageCounter[e]&&this.freeTexture(e)}incrementTextureUsage(e){this.textureUsageCounter[e]++}decrementTextureUsage(e){this.textureUsageCounter[e]>0&&this.textureUsageCounter[e]--}}},5231:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var s=i(97542);class n extends s.Y{constructor(){super(...arguments),this.name="sweep-pano-base"}getRenderer(){return this.panoRenderer}}},40327:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var s=i(66777),n=i(25215);class a extends n.Z{constructor(e,t){super(t),this.sweepLoader=new s.Z(e)}activateSweep(e){super._activateSweep(e);const t=this.sweepListMap.get(e);return this.sweepLoader.load(t).then((e=>e))}useTexture(e){const t=this.sweepLoader.useTexture(e);return t&&super._useTexture(e),t}freeTexture(e,t=!1){super.freeTexture(e,t),0===this.textureUsageCounter[e]&&this.sweepLoader.unload(e)}freeAllTextures(e){this.sweepLoader.unloadAll(e)}}var r=i(53954),o=i(5231),h=i(76609),l=i(46950),d=i(57956);class c extends o.Z{constructor(){super(...arguments),this.name="sweep-pano"}async init(e,t){const i=(await t.getModuleBySymbol(d.y.MODEL_DATA)).getSignedUrls(),s=(await t.market.waitForData(r.Z)).getSweepList();this.panoRenderer=new a(i,s),t.addComponent(this,this.panoRenderer)}getRenderer(){return this.panoRenderer}resetSweep(){}async availableResolution(){return h.SL.STANDARD}async requestResolution(){return h.SL.STANDARD}waitForQueue(){return(new l.Q).resolve().promise()}async enableZooming(){return!1}}},9699:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var s=i(98010);class n extends s.v{constructor(){super()}}},46368:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var s=i(98010);class n extends s.v{constructor(e){super(),this.sweepIds=e}}},35428:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>C});var s=i(97542),n=i(84428),a=i(72996),r=i(94046),o=i(82814),h=i(8948),l=i(45881),d=i(19663);class c extends d.m{constructor(e){super(),this.id="TOGGLE_PUCK_EDITING",this.payload={enabled:e}}}var u=i(10699),p=i(16782),g=i(67678),m=i(86819),y=i(34029),w=i(25985),f=i(21973),v=i(23254),b=i(95882),T=i(87926),S=i(29480);const D=(0,T.p)(S);var P=i(12039),I=i(5135),x=i(65636),M=i(57956);const E={enabled:D,enabledHover:D};class C extends s.Y{constructor(){super(...arguments),this.name="sweep-pucks",this.IDLE_OPACITY=.3,this.EDITING_OPACITY=.9,this.IDLE_COLOR=new n.Color("white"),this.SELECTION_COLOR=new n.Color(16724312),this.defaultCheckRenderModes=()=>!0,this.unselectingSweep=null,this.editingEnabled=!1,this.selectionBindings=[],this.unselectionBindings=[],this.selectionHandled=!0,this.unselectionHandled=!0,this.handlePuckClickedMessage=e=>{if(!e)throw new Error("SweepPucks -> on PuckClickedMessage: Tried to move to invalid sweep id.");this.canSelectPuck()||this.sweepViewData.data.canTransition()&&this.cameraData.canTransition()&&this.engine.commandBinder.issueCommand(new P.ju({transition:x.y[this.interactionmodeData.mode],sweep:e}))},this.handleSweepSelectionChange=()=>{this.updateHighlightOnSelectedPuck(!1),this.selectedSweep=this.sweepViewData.selectedSweep,this.updateHighlightOnSelectedPuck(!0),this.updateHandlers()},this.updateViewmode=()=>{this.viewmode=this.viewmodeData.currentMode,this.updateHighlightOnSelectedPuck(this.editingEnabled),this.updateHandlers()},this.updateHandlers=()=>{this.selectionHandled=this.toggleHandlers(this.canSelectPuck(),this.selectionBindings,this.selectionHandled),this.unselectionHandled=this.toggleHandlers(this.canUnselectPuck(),this.unselectionBindings,this.unselectionHandled)},this.unselectPuck=()=>{this.unselectingSweep=null,this.sweepViewData.setSelectedSweep(null)},this.onUnselectPuck=e=>{const t=this.sweepViewData.selectedSweep;return t&&(e.down?this.unselectingSweep=t:this.unselectingSweep&&this.unselectPuck()),!0},this.onPointerOnPuck=(e,t)=>{if(e.button!==p.M.PRIMARY)return;const i=this.renderer.getSweepId(t.id);i&&(e.down?i===this.selectedSweep?this.unselectingSweep=i:(this.unselectingSweep=null,this.sweepViewData.setSelectedSweep(i)):(i===this.unselectingSweep&&this.unselectPuck(),this.unselectingSweep=null))}}async init(e,t){this.engine=t,void 0!==e.checkRenderModes&&(this.defaultCheckRenderModes=e.checkRenderModes);const i=(await t.getModuleBySymbol(M.y.WEBGL_RENDERER)).getScene(),s=await t.getModuleBySymbol(M.y.INPUT),[n,d,u,p,b]=await Promise.all([t.market.waitForData(y.e),t.market.waitForData(w.M),t.market.waitForData(f.D),t.market.waitForData(v.O),t.market.waitForData(I.Z)]);this.viewmodeData=p,this.viewmode=p.currentMode,this.sweepViewData=u,this.cameraData=d,this.interactionmodeData=b;this.renderer=new h.C$(i.scene,s,n,u,E,!0,this.defaultCheckRenderModes,this.IDLE_COLOR,this.SELECTION_COLOR,this.IDLE_OPACITY,this.EDITING_OPACITY,void 0,void 0,t.claimRenderLayer(this.name)),t.addComponent(this,this.renderer),this.bindings.push(t.commandBinder.addBinding(c,(async e=>this.togglePuckEditing(e.enabled))),t.subscribe(l.Z,(e=>this.handlePuckClickedMessage(e.sweepId)))),this.selectionBindings.push(s.registerMeshHandler(g.er,a.s.isType(h.YY),this.onPointerOnPuck),s.registerHandler(g.mE,(()=>{this.unselectingSweep=null}))),this.selectionHandled=this.toggleHandlers(!1,this.selectionBindings,this.selectionHandled),this.selectionSub=this.sweepViewData.onSelectedSweepChanged(this.handleSweepSelectionChange),this.selectionSub.cancel(),this.unselectionBindings.push(s.registerPriorityHandler(m.R,o.S,(()=>!0)),s.registerPriorityHandler(g.er,o.S,this.onUnselectPuck),s.registerPriorityHandler(g.er,r.i,this.onUnselectPuck)),this.unselectionHandled=this.toggleHandlers(!1,this.unselectionBindings,this.unselectionHandled)}dispose(e){for(const e of this.bindings)e.cancel();this.bindings=[],this.togglePuckEditing(!1),super.dispose(e)}updatePuckImagery(e={}){const t=Object.assign(Object.assign({},E),e);t.disabled&&!t.disabledHover&&(t.disabledHover=t.disabled),this.renderer.updatePuckImagery(t)}updateCheckRenderModes(e){this.renderer.updateCheckRenderModes(e||this.defaultCheckRenderModes)}updateHighlightOnSelectedPuck(e){const t=this.selectedSweep;if(t){if(!this.sweepViewData.isSweepAligned(t))return;const i=this.viewmode===b.Ey.Dollhouse||this.viewmode===b.Ey.Floorplan;this.renderer.renderPuckHighlight(t,this.editingEnabled&&i&&e)}}togglePuckEditing(e){this.editingEnabled=e,this.selectedSweep=this.sweepViewData.selectedSweep,this.updateViewmode(),this.renderer.toggleEditingEnabled(e),e?(this.engine.subscribe(u.Z,this.updateViewmode),this.selectionSub.renew()):(this.engine.unsubscribe(u.Z,this.updateViewmode),this.selectionSub.cancel())}canUnselectPuck(){const e=this.viewmode===b.Ey.Dollhouse||this.viewmode===b.Ey.Floorplan;return this.editingEnabled&&!!this.selectedSweep&&e}canSelectPuck(){const e=this.viewmode===b.Ey.Dollhouse||this.viewmode===b.Ey.Floorplan;return this.editingEnabled&&e}toggleHandlers(e,t,i){if(e!==i)for(const i of t)e?i.renew():i.cancel();return e}}},95806:(e,t,i)=>{"use strict";i.r(t),i.d(t,{FAST_FORWARD_FACTOR:()=>re,default:()=>oe});var s=i(26256),n=i(14439),a=i(97542),r=i(95882),o=i(60699),h=i(2473),l=i(65397),d=i(23254),c=i(64918),u=i(96154),p=i(67678),g=i(12250),m=i(89553),y=i(6667),w=i(54244),f=i(10374),v=i(34029),b=i(25985),T=i(69505),S=i(2569),D=i(14715),P=i(59625),I=i(96042),x=i(17686);class M{constructor(e=-1){this.active=!1,this.type=x.Aq.Nop,this.promise=Promise.resolve(),this.stop=()=>Promise.resolve(),this.duration=0,this.started=-1,this.stopped=-1,this.toIndex=e}}var E=i(39880);class C{constructor(e){this.type=x.Aq.Delay,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.cancelDelay=()=>null,this.duration=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(this.cancelDelay(),this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t){if(this.active)throw Error("Transition already active");void 0!==e.duration&&(this.duration=e.duration);const i=(0,E.Ig)(this.duration);return this.cancelDelay=()=>{i.cancel()},this.currentTransitionPromise=i.promise.then((()=>this.stop())),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}}class R{constructor(e,t,i){this.zoom=e,this.stopZooming=t,this.type=x.Aq.Zoom,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.duration=i}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t){if(this.active)throw Error("Transition already active");return void 0!==e.duration&&(this.duration=e.duration),this.currentTransitionPromise=this.zoom(this.duration,-5e-4).then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this.onStopRequested=async()=>{await this.stopZooming()},this}}var A=i(84428),L=i(90304),O=i(21646);class F{constructor(e,t,i){this.settingsData=e,this.rotate=t,this.stopRotating=i,this.type=x.Aq.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.getPanDirection=(e,t)=>{let i=x.kw.Right;if(e&&e.metadata.scanId&&e.metadata.cameraQuaternion&&e.metadata.cameraPosition&&t&&t.metadata.scanId&&t.metadata.cameraPosition&&t.metadata.cameraQuaternion){const s=L.f.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),n=t.metadata.cameraPosition,a=e.metadata.cameraPosition;let r=n.clone().sub(a).normalize();r.lengthSq()<O.Z.epsilon&&(r=L.f.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion)),s.cross(r).y>0&&(i=x.kw.Left)}return i}}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t,i){if(this.active)throw Error("Transition already active");if(!e)throw Error("Tour pan requires two snapshots");if(!e.snapshot||!e.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this.toIndex=t,this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:s}=this.build(e.snapshot,e.nextSnapshot,e.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t,i,s){const{panDirection:n,panAngle:a}=i,r=ee.getPanValues(this.settingsData,!1,n,a);let o=r.direction;void 0!==o&&o!==x.kw.Auto||(o=this.getPanDirection(e,t)),this.onStopRequested=async()=>{await this.stopRotating()},this.duration=void 0!==s?s:r.ms;return{deferred:this.rotate(this.duration,new A.Vector2(o*r.radiansPerMs,0))}}}var k=i(23885),B=i(46950);const N=.001,G=(e,t,i,s)=>{const n=Math.max(.75,Math.min(e.distanceTo(t),5)),a=n*(1/s)*1e3;let r=a;const o=i/a;if(o>N){r+=r*((o-N)/N)}const h=Math.abs(e.clone().setX(0).setZ(0).distanceTo(t.clone().setX(0).setZ(0))/Math.max(n,1));if(h>.1){r*=.9+.75*h}return r};class _{constructor(e,t,i,s,n,a){this.settingsData=e,this.cameraPose=t,this.moveToSweep=i,this.updateTransitionSpeed=s,this.setRestrictedSweeps=n,this.generators=a,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentGenerator=null,this.currentTransitionPromise=null,this.type=x.Aq.Move}get active(){return null!==this.currentTransitionPromise||null!==this.currentGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentGenerator&&(this.generators.stopGenerator(this.currentGenerator),this.currentGenerator=null)}start(e,t){if(this.active)throw Error("Transition already active");const{generator:i,deferred:s}=this.build(e.path,e.orientations);return this.generators.startGenerator(i),this.currentGenerator=i,this.currentTransitionPromise=s.nativePromise(),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t){const i=new B.Q,n=this;let a=!1;return this.onStopRequested=async()=>{a=!0,await this.updateTransitionSpeed(re)},{generator:function*(){let r=1;for(;r<e.length&&!a;){const i=r-1,a=e[r],o=a.position,h=e[i],l=t[r],d=(0,S.zW)(n.cameraPose.rotation,l),u=ee.getTransitionSpeed(n.settingsData),p=G(h.position,o,d,u),g={transitionType:c.n.Interpolate,sweepId:a.id,rotation:l,transitionTime:p,easing:k.vG};n.duration=p,n.setRestrictedSweeps(e,i);const m=n.moveToSweep(g);yield new s.M8(m.nativePromise()),r++}n.setRestrictedSweeps(null),i.resolve(),n.currentTransitionPromise=null,n.stop()},deferred:i}}}var U=i(79727);const z=new(i(97998).Z)("tours");class V{constructor(e,t,i,n,a,r,o,h,l){this.settingsData=e,this.cameraPose=t,this.cameraTransition=i,this.sweepTransition=n,this.sweepControl=a,this.cameraControl=r,this.generators=o,this.setRestrictedSweeps=h,this.getCurve=l,this.type=x.Aq.Path,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionGenerator=null,this.currentTransitionPromise=null,this.canceling=!1,this.buildTransition=(e,t)=>{if(e.length<=2)throw z.debug(`invalid path: ${e}`),new Error("smooth path requires more than 2 stops");const i=this,n=new B.Q;i.setRestrictedSweeps(e);const a=e.map((e=>e.position)),r=i.getCurve(a),o=k.vG,h=k.Fs,l=k.to,d=ee.getTransitionSpeed(i.settingsData);this.duration=((e,t,i)=>{let s=0;for(let n=0;n<e.length-1;n++){const a=(0,S.zW)(t[n],t[n+1]);s+=G(e[n].position,e[n+1].position,a,i)}return s})(e,t,d),z.debug(`path duration: ${this.duration.toFixed(0)}ms, at speed: ${d}m/s`),i.cameraControl.beginExternalTransition();return{generator:function*(){n.notify(0);const a=new A.Vector3,u=new A.Quaternion;let p=0,g=0,m=0,y=1,w=e[y].id;yield new s.M8(i.sweepControl.activateSweepUnsafe({sweepId:w}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})}))),e.length>2&&i.sweepControl.activateSweepUnsafe({sweepId:e[2].id});let f=i.cameraPose.rotation.clone();for(;p<i.duration&&!i.canceling;){const d=p/i.duration;m>0&&(f=t[m].clone());const c=t[y],v=r.normalSourceDistances[m],b=r.normalSourceDistances[y],T=e[y];if(g=(0,S.et)(d,v,b,0,1),g<=1){const e=l(g,0,1,1);i.sweepTransition.progress.modifyAnimation(e,1,0);const t=h(g,0,1,1);u.copy(f).slerp(c,t)}d<1&&a.copy(r.curve.getPointAt(o(d,0,1,1))),i.cameraControl.updateCameraPosition(a),i.cameraControl.updateCameraRotation(u),d>=b&&(i.sweepControl.endSweepTransition({sweepId:T.id}),m++,y++,w=e[m+1].id,yield new s.M8(i.sweepControl.activateSweepUnsafe({sweepId:w}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})}))),e.length>m+2&&i.sweepControl.activateSweepUnsafe({sweepId:e[m+2].id})),n.notify(d),p=Date.now()-i.cameraTransition.startTime,yield new s.Jj}if(i.cameraControl.endExternalTransition(),i.canceling){i.canceling=!1;const t=e[y].position,n=G(i.cameraPose.position,t,0,d),a=i.cameraControl.moveTo({transitionTime:n/re,transitionType:c.n.Interpolate,pose:{position:t}});a.progress((e=>{const t=(0,S.et)(e,0,1,g,1);i.sweepTransition.progress.modifyAnimation(t,1,0)})),yield new s.M8(a.nativePromise())}i.sweepControl.endSweepTransition({sweepId:w}),i.setRestrictedSweeps(null),n.notify(1),n.resolve()},deferred:n}}}get active(){return null!==this.currentTransitionPromise||null!==this.currentTransitionGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.canceling=!0,this.currentTransitionPromise&&(await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentTransitionGenerator&&(this.generators.stopGenerator(this.currentTransitionGenerator),this.currentTransitionGenerator=null)}start(e,t){if(z.debug(`starting smooth transition with ${e.path.length-1} stops`),this.active)throw Error("Transition already active");this.canceling=!1;const{generator:i,deferred:s}=this.buildTransition(e.path,e.orientations);return this.generators.startGenerator(i),this.currentTransitionGenerator=i,this.currentTransitionPromise=s.nativePromise().then((()=>{this.currentTransitionPromise=null,this.currentTransitionGenerator=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}}var j=i(53954);class Q{constructor(e,t,i,s,n,a,r,o){this.settingsData=e,this.cameraPose=t,this.viewmodeData=i,this.cameraControl=s,this.sweepControl=n,this.switchToMode=a,this.setRestrictedSweeps=r,this.generators=o,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=x.Aq.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t){if(this.active)throw Error("Transition already active");if(!e.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:i}=this.build(e.snapshot,e.currentSweep,e.transitionType);return this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t,i){let s=Promise.resolve();const n=e.metadata.cameraMode,a=e.metadata.cameraQuaternion,r=e.metadata.scanId,o=this.cameraPose.rotation,h=(0,S.zW)(o,a),l=e.metadata.cameraPosition,d=!e.is360,c={position:l,rotation:a,sweepID:r,zoom:e.metadata.orthoZoom};let u=ee.getOtherModeTransitionTime(this.settingsData,h,i);if(n!==this.viewmodeData.currentMode)s=this.switchToMode(n,i,c,u);else{if(!!r&&this.viewmodeData.isInside()){!t||r!==t?(u=ee.getTransitionTime(this.settingsData),s=this.standardTransitionSweepMovePromise(c,r,d,u)):(u=ee.getSamePanoTransitionTime(this.settingsData,h),s=this.standardTransitionSameSweepRotationPromise(c,h,u))}else s=this.cameraControl.moveTo({transitionType:i,pose:c,transitionTime:u}).nativePromise()}return this.duration=void 0!==u?u:0,{deferred:s}}standardTransitionSameSweepRotationPromise(e,t,i){if(!e.rotation)throw Error("Rotation transition requires a rotation");return t<.01?Promise.resolve():(this.setRestrictedSweeps(null),this.cameraControl.moveTo({transitionType:c.n.Interpolate,pose:{rotation:e.rotation},transitionTime:i}).nativePromise())}standardTransitionSweepMovePromise(e,t,i,n){if(!e.position)throw Error("Push transition requires a position");const a=e.position.clone().sub(this.cameraPose.position).normalize(),r=this.cameraPose.position.clone().add(a.multiplyScalar(.15)),o=new B.Q;this.setRestrictedSweeps(null);const h=this;return this.generators.startGenerator((function*(){yield new s.M8(h.sweepControl.activateSweepUnsafe({sweepId:t}));const a=new A.Vector3,l=h.cameraPose.position.clone(),d=Date.now();let u,p=0,g=!1,m=!1;for(;p<n;){const o=(0,k.FG)(p,0,p/n,n);i&&h.cameraControl.updateCameraPosition(a.copy(l).lerp(r,o)),o>=.3&&!m&&(u=h.cameraControl.moveTo({transitionType:c.n.FadeToBlack,pose:e,transitionTime:n,blackoutTime:.5*n}).progress((e=>{e>=.5&&!g&&(h.sweepControl.instantSweepTransition(t),g=!0)})),m=!0),yield new s.Jj,p=Date.now()-d}u&&(yield new s.M8(u.nativePromise())),o.resolve()})),o.nativePromise()}}class H{constructor(e,t,i,s){this.moveToSweep=e,this.viewmodeData=t,this.cameraControl=i,this.switchToMode=s,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=x.Aq.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t){if(this.active)throw Error("Transition already active");if(!e.snapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:i}=this.build(e.snapshot,e.currentSweep);return this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t){let i=Promise.resolve();const s=e.metadata.cameraMode,n=e.metadata.cameraQuaternion,a=e.metadata.scanId,r={position:e.metadata.cameraPosition,rotation:n,sweepID:a,zoom:e.metadata.orthoZoom},o=s!==this.viewmodeData.currentMode,h=!!a&&this.viewmodeData.isInside();if(o)i=this.switchToMode(s,c.n.Instant,r);else if(h){const e={transitionType:c.n.Instant,sweepId:a,rotation:n};i=this.moveToSweep(e).nativePromise()}else i=this.cameraControl.moveTo({transitionType:c.n.Instant,pose:r}).nativePromise();return{deferred:i}}}var W=i(52498),Y=i(33324);class Z{constructor(e,t){this.issueCommand=e,this.currentFloorId=t,this.type=x.Aq.FloorChange,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=W.cw,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t){if(this.active)throw Error("Transition already active");let i=Promise.resolve();const s=e.targetSnapshot.metadata.floorId,n=s!==this.currentFloorId(),a=e.targetSnapshot.metadata.cameraMode;return!(0,r.Bw)(a)&&a!==r.Ey.Outdoor&&n&&(i=this.issueCommand(new Y.Vw(s,!0,this.duration))),this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}}class q{constructor(e,t,i){this.settingsData=e,this.rotate=t,this.stopRotating=i,this.type=x.Aq.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t,i){if(this.active)throw Error("Transition already active");if(!e.snapshot||!e.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:s}=this.build(e.snapshot,e.nextSnapshot,e.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t,i,s){const{panDirection:n,panAngle:a}=i,r=ee.getPanValues(this.settingsData,!0,n,a);let o=-1*r.radiansPerMs;this.duration=void 0!==s?s:r.ms;const h=r.direction;if(void 0!==h&&h!==x.kw.Auto)o*=h;else if(e&&e.metadata.cameraQuaternion&&t&&t.metadata.cameraQuaternion){const i=L.f.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),s=L.f.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),n=Math.sign(i.cross(s).y);o=0!==n?o*n:o}this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(this.duration,new A.Vector2(o,0))}}}class X{constructor(e,t,i,s,n){this.settingsData=e,this.cameraPose=t,this.rotate=i,this.stopRotating=s,this.getCurve=n,this.type=x.Aq.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(e,t,i){if(this.active)throw Error("Transition already active");const{deferred:s}=this.build(e.path,e.snapshot,e.nextSnapshot,e.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=t,this.started=Date.now(),this.stopped=-1,this}build(e,t,i,s,n){this.onStopRequested=async()=>{await this.stopRotating()};const{panDirection:a,panAngle:o}=s,h=ee.getPanValues(this.settingsData,!1,a,o),l=h.direction;let d=h.radiansPerMs;if(void 0!==l&&l!==x.kw.Auto)d*=l;else if(e){const t=this.cameraPose.position.clone().setY(0),i=e.map((e=>e.position)),s=this.getCurve(i).curve.getPointAt(.1).setY(0).clone().sub(t).normalize(),n=L.f.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),a=Math.sign(n.cross(s).y);d=0!==a?d*a:d}else if(i&&t){if(!(0,r.Bw)(t.metadata.cameraMode)&&(d=-d),t.metadata.scanId===i.metadata.scanId){const e=L.f.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),t=L.f.FORWARD.clone().applyQuaternion(i.metadata.cameraQuaternion),s=Math.sign(e.cross(t).y);d=0!==s?d*s:d}}this.duration=void 0!==n?n:h.ms;return{deferred:this.rotate(this.duration,new A.Vector2(d,0))}}}const K={sharpTurnDotThreshold:.65,directionWeightFactorStd:.75,directionWeightFactorSharp:.2,positionalWeightFactorStd:.4,positionalWeightFactorSharp:.2,finalWalkingNodeDirectionWeight:5,lookAheadNodes:3};class ${constructor(e=K){this.settings=e}getOrientationsForPath(e,t){const i=[];for(let s=0;s<e.length;s++){const n=new A.Vector3;this.getLookVectorsForPathNode(e,s,t,n);const a=(new A.Matrix4).lookAt(e[s],n,L.f.UP);i[s]=(new A.Quaternion).setFromRotationMatrix(a)}return i.push(t),i}getLookVectorsForPathNode(e,t,i,s){const n=new A.Vector3,a=new A.Vector3,r=new A.Vector3,o=new A.Vector3,h=e.length;if(t>=h)return!1;let l=1,d=1;const c=new A.Vector3;let u;for(let s=t;s<t+this.settings.lookAheadNodes&&s<h;s++){if(u=e[s],this.getOrientationForPathNode(e,s,i,r),s===t&&n.copy(r),s>t){const e=n.dot(r)<this.settings.sharpTurnDotThreshold;l*=e?this.settings.directionWeightFactorSharp:this.settings.directionWeightFactorStd,d*=e?this.settings.positionalWeightFactorSharp:this.settings.positionalWeightFactorStd}s===h-1&&(l=this.settings.finalWalkingNodeDirectionWeight,d=1),c.copy(r),r.multiplyScalar(l),a.add(r),o.lerp(u,d)}return a.normalize(),s.copy(o),s.add(a),!0}getOrientationForPathNode(e,t,i,s){if(t>=e.length)return!1;if(t===e.length-1)s.copy(L.f.FORWARD).applyQuaternion(i);else{const i=e[t],n=e[t+1];s.copy(n).sub(i)}return s.normalize(),!0}}var J=i(57956);class ee{constructor(e,t,i,s,a){this.engine=e,this.tourData=t,this.cameraData=i,this.settingsData=s,this.viewmodeData=a,this.init=async()=>{this.sweepModule=await this.engine.getModuleBySymbol(J.y.SWEEP_DATA),this.sweepData=await this.engine.market.waitForData(j.Z),this.cameraModule=await this.engine.getModuleBySymbol(J.y.CAMERA),this.pathModule=await this.engine.getModuleBySymbol(J.y.SWEEP_PATH),this.floorsViewData=await this.engine.market.waitForData(U.c),this.commonControlsModule=await this.engine.getModuleBySymbol(J.y.CONTROLS_COMMON),this.viewmodeModule=await this.engine.getModuleBySymbol(J.y.VIEWMODE),this.pathOrientHelper=new $,this.setRestrictedSweeps=this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.getCurveForPath=this.pathModule.getCurveForPath.bind(this.pathModule),this.moveToSweep=this.sweepModule.moveToSweep.bind(this.sweepModule),this.updateTransitionSpeed=this.cameraModule.updateTransitionSpeed.bind(this.cameraModule),this.switchToMode=this.viewmodeModule.switchToMode.bind(this.viewmodeModule),this.startRotateTransition=this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.stopCamera=this.commonControlsModule.stop.bind(this.commonControlsModule),this.startZoomTransition=this.commonControlsModule.startZoomTransition.bind(this.commonControlsModule),this.issueCommand=this.engine.commandBinder.issueCommand.bind(this.engine.commandBinder)},this.getValidWalkingPath=e=>{const t=e.metadata.scanId,i=this.sweepData.currentSweep,s=this.tourData.getTourCurrentSnapshotIndex();let a=null;if(s>=0){const e=this.tourData.getTourSnapshotSid(s);a=this.tourData.getSnapshot(e)}if(this.viewmodeData.currentMode!==r.Ey.Panorama||!i||!t||t===i||e.is360||!a||a.is360)return null;const o=this.pathModule.findShortestPath(i,t,n.Xd.walkingTourIncludeExtraPanosDistance,n.Xd.walkingStageMinimumDistance,n.Xd.maxWalkingSweepsBetweenSnapshots)||[];return 0===o.length?null:o}}static isDelayTransition(e,t,i){return!(0,n.dF)(e)||t!==x.BZ.Zoom&&0===ee.getPanDegrees(e,i.panAngle)}static getTourBurnsStyle(e,t,i){return ee.isDelayTransition(e,t,i)?x.BZ.Delay:t}static getPanDegrees(e,t){let i;return i=(0,n.dF)(e)?-1!==e.getOverrideParam(n.xs,-1)?(0,n.y)(e):void 0!==t?t:e.tryGetProperty(P.gx.PanAngle,n.BA):0,Math.max(i,0)}static getPanRadiansPerMs(e,t,i){if(-1!==e.getOverrideParam(n.lY,-1)){const t=(0,n.g_)(e);return t>0?i/t:0}const s=t?e.tryGetProperty(P.gx.DollhousePanSpeed,n.su):e.tryGetProperty(P.gx.PanSpeed,n.pn);return(0,I.DA)(s)}getFloorTransition(e){const t=this.tourData.getTourSnapshotSid(e),i=this.tourData.getSnapshot(t);if(!i){return new M(e)}return new Z(this.issueCommand,(()=>this.floorsViewData.currentFloorId)).start({targetSnapshot:i},e)}getMainTransition(e,t){const i=this.tourData.getTourSnapshotSid(e),s=this.tourData.getSnapshot(i);if(!s){return new M(e)}let n=null;if(t===c.n.Interpolate){const t=s.metadata.cameraQuaternion,i=this.getValidWalkingPath(s);if(i){const s=i.map((e=>e.position)),a=this.pathOrientHelper.getOrientationsForPath(s,(0,S.Z)(t));n=i.length>2?new V(this.settingsData,this.cameraData.pose,this.cameraData.transition,this.sweepData.transition,this.sweepModule,this.cameraModule,this.engine,this.setRestrictedSweeps,this.getCurveForPath).start({path:i,orientations:a},e):new _(this.settingsData,this.cameraData.pose,this.moveToSweep,this.updateTransitionSpeed,this.setRestrictedSweeps,this.engine).start({path:i,orientations:a},e)}}else if(t===c.n.Instant){const t=this.sweepData.currentSweep;n=new H(this.moveToSweep,this.viewmodeData,this.cameraModule,this.switchToMode).start({snapshot:s,currentSweep:t},e)}if(!n){const i=this.sweepData.currentSweep;n=new Q(this.settingsData,this.cameraData.pose,this.viewmodeData,this.cameraModule,this.sweepModule,this.switchToMode,this.setRestrictedSweeps,this.engine).start({snapshot:s,currentSweep:i,transitionType:t},e)}return n}getBurnsTransition(e,t,i){const s=this.tourData.getTourSnapshotSid(e),n=(e+1)%this.tourData.getSnapshotCount(),a=this.tourData.getTourSnapshotSid(n),r=this.tourData.getTourStop(s),o={};r.reelEntry&&r.reelEntry.overrides&&(o.panDirection=r.reelEntry.overrides.panDirection,o.panAngle=r.reelEntry.overrides.panAngle);const h=this.tourData.getSnapshot(a);let l=new M(e);switch(t){case x.BZ.Pan:if(h){const t=this.getValidWalkingPath(h);l=new X(this.settingsData,this.cameraData.pose,this.startRotateTransition,this.stopCamera,this.getCurveForPath).start({path:t,snapshot:r.snapshot,nextSnapshot:h,panOverrides:o},e,i)}l.type===x.Aq.Nop&&(l=new F(this.settingsData,this.startRotateTransition,this.stopCamera).start({snapshot:r.snapshot,nextSnapshot:h,panOverrides:o},e,i));break;case x.BZ.PanDollhouse:l=new q(this.settingsData,this.startRotateTransition,this.stopCamera).start({snapshot:r.snapshot,nextSnapshot:h,panOverrides:o},e,i);break;case x.BZ.Zoom:l=new R(this.startZoomTransition,this.stopCamera,ee.getZoomDuration(this.settingsData)).start({duration:i},e);break;case x.BZ.Delay:const t=ee.getDelayDuration(this.settingsData);l=new C(t).start({duration:i},e);break;case x.BZ.None:l=new M(e);break;default:throw Error("unhandled TourBurnsStyle")}return l}}ee.getPanDirection=(e,t)=>void 0!==t?t:e.tryGetProperty(P.gx.PanDirection,D.y6),ee.getDelayDuration=e=>-1!==e.getOverrideParam(n.lY,-1)||0===e.getOverrideParam(n._c,-1)?(0,n.g_)(e):n.mS,ee.getZoomDuration=e=>-1!==e.getOverrideParam(n.lY,-1)?(0,n.g_)(e):e.tryGetProperty(P.gx.ZoomDuration,n.i7),ee.getPanValues=(e,t,i,s)=>{const a=ee.getPanDirection(e,i),r=ee.getPanDegrees(e,s),o=(0,T.Id)(r),h=ee.getPanRadiansPerMs(e,t,o);let l=h>0?o/h:0;return t&&void 0===s&&(l=(0,n.g_)(e)),{degrees:r,radiansPerMs:h,ms:l,direction:a}},ee.getTransitionSpeed=e=>{if(-1!==e.getOverrideParam("wts",-1))return e.tryGetProperty(n.EU,n.Im);const t=e.tryGetProperty(P.gx.TransitionSpeed,n.Mk);return(0,I.mf)(t/1e3)},ee.getTransitionTime=e=>{const t=e.tryGetProperty(P.gx.TransitionTime,n.mL);return Math.min(Math.max(n.eu,t),n.NY)},ee.getOtherModeTransitionTime=(e,t,i)=>{if(i===c.n.FadeToBlack){return ee.getTransitionTime(e)+n.HJ}let s=n.Cp,a=n.f7;if(-1===e.getOverrideParam("wts",-1)){const t=1e3*ee.getTransitionSpeed(e);s=Math.sqrt(2*(t-n.Pv))+45,t!==n.Mk&&(a=n._D)}const r=1e3*t/(T.Ue*s);return Math.max(r,a)},ee.getSamePanoTransitionTime=(e,t)=>{const i=e.tryGetProperty(P.gx.PanSpeed,n.pn);if(i===n.pn)return Math.max(1e3*t/(T.Ue*n.O2),n.gS);{const e=(0,S.dS)(i,n.z$,n.b_,n.rM,n.z8),s=(0,I.DA)(e);return s>0?t/s:0}};var te=i(71239),ie=i(96767),se=i(33397),ne=i(97478),ae=i(80742);const re=5;class oe extends a.Y{constructor(){super(...arguments),this.name="tours-controls",this.getBurnsStyleForSnapshot=(e,t)=>{const i=this.data,s=i.getTourSnapshotSid(e),n=i.getTourStop(s),a=i.getSnapshotCount();if(!n||!n.snapshot)return x.BZ.None;if(e===a-1&&this.isLastStopStatic(t))return this.toursViewData.getTourStoryMode()?x.BZ.Delay:x.BZ.None;const o=n.snapshot.metadata.cameraMode,h=o===r.Ey.Dollhouse?x.BZ.PanDollhouse:o===r.Ey.Floorplan?x.BZ.Zoom:x.BZ.Pan;return ee.getTourBurnsStyle(this.settingsData,h,t)},this.canChangeTourLocation=()=>{const e=this.data.getTourState(),t=this.data.isTourTransitionActive(),i=this.cameraData.canTransition();return e===o.Vs.Inactive&&!t&&!(this.viewmodeData.transition&&this.viewmodeData.transition.active)&&i}}async init(e,t){this.engine=t,[this.cameraData,this.viewmodeData,this.settingsData,this.data,this.toursViewData]=await Promise.all([t.market.waitForData(b.M),t.market.waitForData(d.O),t.market.waitForData(v.e),t.market.waitForData(h.k),t.market.waitForData(l.T)]);const i=await t.market.waitForData(ae.R);t.getModuleBySymbol(J.y.INPUT).then((e=>{e.registerHandler(p.er,(()=>{this.handleTourInputInterrupt()})),e.registerHandler(g.a,(()=>{this.handleTourInputInterrupt()})),e.registerHandler(m.e,(e=>{e.state===y.M.DOWN&&this.handleTourInputInterrupt()}))})),this.transitionFactory=new ee(t,this.data,this.cameraData,this.settingsData,this.viewmodeData),await this.transitionFactory.init(),this.setupAutoPlay(t),this.bindings.push(t.commandBinder.addBinding(ie.TH,(async e=>this.startTour(e.index,e.steps,e.loop)))),this.bindings.push(t.commandBinder.addBinding(ie.vy,(async e=>this.stopTour(e.willResume)))),this.bindings.push(t.commandBinder.addBinding(ie.rU,(async e=>this.tourGoTo(e.index,e.instant?c.n.Instant:void 0)))),this.bindings.push(t.commandBinder.addBinding(ie.HW,(async e=>e.forward?this.tourGoNext(e.instant):this.tourGoPrevious(e.instant)))),this.bindings.push(t.commandBinder.addBinding(ie.r2,(async e=>{const t=this.data.tourPlaying;try{t&&await this.stopTour(!0),await this.tourGoNext(!1),t&&await this.startTour()}catch(e){this.log.debug(e)}}))),this.bindings.push(t.commandBinder.addBinding(ie.Ri,(async e=>{const t=this.data.tourPlaying;try{t&&await this.stopTour(!0),await this.tourGoPrevious(!1),t&&await this.startTour()}catch(e){this.log.debug(e)}}))),this.bindings.push(i.onPropertyChanged("currentViewId",(()=>this.stopTour(!1))))}handleTourInputInterrupt(){this.data.getTourState()!==o.Vs.Inactive&&this.stopTour()}canTourProceed(e,t,i){const s=this.data.getSnapshotCount();if(0===s||0===i||this.data.getTourState()!==o.Vs.Inactive)return!1;if(void 0!==t){if(t<-1)return!1;if(!0!==e&&t>s-1)return!1}return!0}shouldTourContinue(e,t,i,s){return void 0!==s?i<s:t<e-1}startTour(e,t,i){if(!this.canChangeTourLocation())throw new se.Y("Cannot start tour at this time, another transition is active");const n=void 0!==i?i:this.data.isLooping();if(!this.canTourProceed(n,e,t))return;this.data.setLooping(n);const a=this.data.getActiveReelTourMode(),r=(0,ne.Cf)(this.settingsData,a),h=this.data.getTourCurrentSnapshotIndex(),l=this.data.getSnapshotCount(),d=this.data.transition,c=h===l-1&&(x.c5.includes(d.type)||!r)&&d.toIndex===l-1&&d.stopped-d.started>=d.duration;let p,g=0;p=void 0!==e?e-1:c?-1:Math.max(h-1,-1);const m=this.settingsData.tryGetProperty(te.YS,null);this.settingsData.setProperty(te.YS,null);const y=this;this.tourGenerator=function*(){for(;y.shouldTourContinue(l,p,g,t);){const e=p+1,t=y.composeTourTransition(e);yield new s.M8(t),p=e,p===l-1&&n&&(p=-1),g++}y.stopTour(),y.settingsData.setProperty(te.YS,m)},this.engine.startGenerator(this.tourGenerator),this.data.setTourState(o.Vs.Active),this.data.tourEnded=!1,this.data.tourWillResume=!1,this.data.tourPlaying=!0,this.data.commit(),this.engine.broadcast(new u.oR)}async composeTourTransition(e,t,i){var s,a,h;const l=this.data.getTourSnapshotSid(e),d=this.data.getTourStop(l);if(!d.snapshot)throw Error(`Highlight not found for reel index ${e}`);const p=this.data.getTourCurrentSnapshotSid()===l,g=this.cameraData.transition.startTime>this.data.transition.stopped;let m=0;const y=this.data.transition.duration;if(p){const{started:e,stopped:t}=this.data.transition;m=(t-e)/y||0,m=Math.min(1,m)}if(g||!p){let t=this.settingsData.tryGetProperty(D.gj,c.n.Interpolate);const n=d.snapshot.metadata.cameraMode,h=n===r.Ey.Dollhouse||n===r.Ey.Floorplan,l=(0,r.Bw)(n),p=!this.viewmodeData.isInside()&&l,g=this.viewmodeData.isInside()&&h,m=!this.viewmodeData.isInside()&&h,y=this.viewmodeData.isInside()&&l;(p||g||m)&&(t=c.n.Interpolate),void 0!==(null===(a=null===(s=d.reelEntry)||void 0===s?void 0:s.overrides)||void 0===a?void 0:a.transitionType)&&(t=d.reelEntry.overrides.transitionType),y&&0===e&&(t=c.n.FadeToBlack),void 0!==i&&(t=i),this.engine.broadcast(new u.dW(e));const w=this.transitionFactory.getFloorTransition(e);if(this.data.useTransition(w),await w.promise,this.data.getTourState()===o.Vs.StopScheduled)return;const f=this.transitionFactory.getMainTransition(e,t);this.data.useTransition(f),await f.promise,this.data.setTourCurrentSnapshotByIndex(e),this.engine.broadcast(new u.Vx(e))}if(this.data.getTourState()===o.Vs.StopScheduled)return;const w={};(null===(h=d.reelEntry)||void 0===h?void 0:h.overrides)&&(w.panAngle=d.reelEntry.overrides.panAngle,w.panDirection=d.reelEntry.overrides.panDirection);const f=t||this.getBurnsStyleForSnapshot(e,w);let v;if(this.toursViewData.getTourStoryMode()){e===this.data.getSnapshotCount()-1&&this.isLastStopStatic(w)&&(v=n.GS)}m>0&&(v=(1-m)*y);const b=this.transitionFactory.getBurnsTransition(e,f,v);this.engine.broadcast(new u._3(e,b.type,b.duration)),this.data.useTransition(b),await b.promise}isLastStopStatic(e){const t=ee.getPanDirection(this.settingsData,e.panDirection),i=ee.getPanDegrees(this.settingsData,e.panAngle),s=this.data.getActiveReelTourMode(),n=(0,ne.Cf)(this.settingsData,s);return 0===i||!n&&t===x.kw.Auto}async stopTour(e=!1){this.data.getTourState()===o.Vs.Active&&(this.data.setTourState(o.Vs.StopScheduled),this.data.tourWillResume=e,this.data.tourPlaying=!1,await this.data.stopTourTransition(),this.tourGenerator&&this.engine.stopGenerator(this.tourGenerator),this.engine.broadcast(new u.NR(e)),this.data.getTourCurrentSnapshotIndex()!==this.data.getSnapshotCount()-1||this.data.isLooping()||(this.data.tourEnded=!0,this.engine.broadcast(new u.Mt)),this.data.setTourState(o.Vs.Inactive),this.data.commit())}async tourGoNext(e){let t=this.data.getTourCurrentSnapshotIndex()+1;t>=this.data.getSnapshotCount()&&(t=0);const i=e?c.n.Instant:void 0;return this.tourGoTo(t,i)}async tourGoPrevious(e){let t=this.data.getTourCurrentSnapshotIndex();t<0&&(t=0);let i=t-1;i<0&&(i=this.data.getSnapshotCount()-1);const s=e?c.n.Instant:void 0;return this.tourGoTo(i,s)}async tourGoTo(e,t=c.n.FadeToBlack){if(!this.canChangeTourLocation())throw new se.z("Cannot change tour location at this time, another transition is active");if(this.viewmodeData.transition&&this.viewmodeData.transition.active)throw new se.z("Cannot go to tour location during viewmode transition");if(this.data.getTourState()!==o.Vs.Inactive)throw new se.z("Cannot jump to tour location while tour is active");try{this.data.setTourState(o.Vs.Active),await this.composeTourTransition(e,x.BZ.None,t)}catch(e){this.log.error(e)}finally{this.data.setTourState(o.Vs.Inactive)}}setupAutoPlay(e){const t=1e3*(0,n.zi)(this.settingsData),i=()=>{let e=!0;const i=this.cameraData.pose.onChanged((()=>{e=!1,i.cancel()}));setTimeout((()=>{e&&this.startTour(),i.cancel()}),t)};if(t>=0){const t=e.market.tryGetData(w.pu);if(t&&t.phase===w.nh.PLAYING)i();else{const t=s=>{s.phase===w.nh.PLAYING&&(i(),e.unsubscribe(f.LZ,t))};e.subscribe(f.LZ,t)}}}}},9473:(e,t,i)=>{"use strict";i.r(t),i.d(t,{HighlightReel:()=>y,ToggleForceShowStoryTextCommand:()=>G.iy,ToggleHighlightReelOpenCommand:()=>G.Av,TourAddPosition:()=>N.VH,TourChangeDescriptionCommand:()=>G.K1,TourChangeTitleCommand:()=>G.Ty,TourData:()=>s.k,TourMode:()=>N.zz,TourRenameCommand:()=>G.CI,TourSetTourModeCommand:()=>G.Te,TourState:()=>N.Vs,ToursViewData:()=>n.T,default:()=>ae});var s=i(2473),n=i(65397),a=i(97542),r=i(34029),o=i(95882),h=i(53954),l=i(42418),d=i(59625),c=i(17788),u=i(32082),p=i(97998),g=i(10385),m=i(75287);class y extends m.T{constructor(e){super(),this.reel=(0,g.C)([]),this.modified=new Date,this.mode=e,this.commit()}replace(e){this.atomic((()=>{this.sid=e.sid,this.reel.replace(Array.from(e.reel.values())),this.mode=e.mode,this.modified=e.modified}))}}var w=i(64918),f=i(17686),v=i(37519),b=i(29282),T=i(5823);const S=new p.Z("mds-reel-element-serializer"),D={[T.y8.FADE_TO_BLACK]:w.n.FadeToBlack,[T.y8.INSTANT]:w.n.Instant,[T.y8.INTERPOLATE]:w.n.Interpolate},P={[T.Y6.LEFT]:f.kw.Left,[T.Y6.RIGHT]:f.kw.Right,[T.Y6.AUTO]:f.kw.Auto};class I{deserialize(e){var t;if(!e||!(null===(t=null==e?void 0:e.asset)||void 0===t?void 0:t.id))return S.debug("Deserialized invalid highlight reel entry from MDS",e),null;const i=e.overrides,s={},n=(null==i?void 0:i.transitionType)?D[null==i?void 0:i.transitionType]:void 0,a=(null==i?void 0:i.panDirection)?P[null==i?void 0:i.panDirection]:void 0,r=null==i?void 0:i.panAngle;(0,b.r)(n)&&(s.transitionType=n),(0,b.r)(a)&&(s.panDirection=a),(0,v.hj)(r)&&(s.panAngle=r);const o={sid:e.asset.id,overrides:s};return e.title&&(o.title=e.title),e.description&&(o.description=e.description),o}}const x=new p.Z("mds-highlight-reel-serializer");class M{constructor(e){this.defaultTourMode=e,this.reelEntrySerializer=new I}deserialize(e){if(!e||!this.validate(e))return x.debug("Deserialized invalid active reel data from MDS",e),null;const t=new y(e.mode||this.defaultTourMode);if(t.sid=e.id,e.reel)for(const i of e.reel){if(!i)continue;const e=this.reelEntrySerializer.deserialize(i);e&&t.reel.push(e)}return t}validate(e){return["id"].every((t=>t in e))}}const E={[w.n.FadeToBlack]:T.y8.FADE_TO_BLACK,[w.n.Instant]:T.y8.INSTANT,[w.n.Interpolate]:T.y8.INTERPOLATE,[w.n.MoveToBlack]:T.y8.FADE_TO_BLACK},C={[f.kw.Left]:T.Y6.LEFT,[f.kw.Right]:T.Y6.RIGHT,[f.kw.Auto]:T.Y6.AUTO};class R{serialize(e){const t={id:e.sid};return e.title&&(t.title=e.title),e.description&&(t.description=e.description),e.overrides&&(t.overrides={},void 0!==e.overrides.transitionType&&(t.overrides.transitionType=E[e.overrides.transitionType]),void 0!==e.overrides.panDirection&&(t.overrides.panDirection=C[e.overrides.panDirection]),void 0!==e.overrides.panAngle&&(t.overrides.panAngle=e.overrides.panAngle)),t}}class A extends c.u{constructor(e,t,i){super(e),this.baseModelId=i,this.serializer=new R,this.prefetchKey="data.model.activeHighlightReel",this.readAllViewSweepIds=!1,this.deserializer=new M(t)}async read(e){const t={modelId:this.getViewId(),prefetchKey:this.prefetchKey};return this.query(u.GetHighlightReel,t,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.activeHighlightReel;return this.deserializer.deserialize(s)}))}async update(e){const t=this.getViewId(),i=e.reel.map((e=>this.serializer.serialize(e))),s=e.mode;return this.mutate(u.PutActiveReel,{modelId:t,elements:i,mode:s}).then((async e=>{this.readAllViewSweepIds&&await this.getAllHighlightSweepIds()}))}async getAllHighlightSweepIds(){var e,t;this.readAllViewSweepIds=!0;const i={modelId:this.baseModelId},s=null===(t=null===(e=(await this.query(u.GetHighlightReelSweeps,i,{fetchPolicy:"no-cache"})).data)||void 0===e?void 0:e.model)||void 0===t?void 0:t.views;return this.allViewSweepIds=new Set,s?(s.forEach((e=>{var t,i;const s=null===(i=null===(t=e.model)||void 0===t?void 0:t.activeHighlightReel)||void 0===i?void 0:i.reel;s&&s.forEach((e=>{var t,i,s;const n=null===(s=null===(i=null===(t=e.asset)||void 0===t?void 0:t.snapshotLocation)||void 0===i?void 0:i.anchor)||void 0===s?void 0:s.id;n&&this.allViewSweepIds&&this.allViewSweepIds.add(n)}))})),this.allViewSweepIds):this.allViewSweepIds}isTourSweep(e){if(!this.allViewSweepIds)throw new Error("Sweep data not available!");return this.allViewSweepIds.has(e)}}var L=i(86090),O=i(2541),F=i(79728),k=i(90632),B=i(635),N=i(60699),G=i(89264),_=i(97478),U=i(57956),z=i(54244),V=i(89570),j=i(38399),Q=i(71166),H=i(19663);class W extends H.m{constructor(e){super(),this.id="DELETE_TOUR_STOP",this.payload={sid:e}}}var Y=i(35221),Z=i(92211),q=i(73536),X=i(56163),K=i(89549),$=i(76631),J=i(96767);const{HLR:ee}=j.Z.WORKSHOP;class te extends X.K{constructor(e,t,i,s,n,a){if(super(e),this.reelEntry=t,this.index=i,this.isWorkshop=s,this.tourMode=n,this.locale=a,this.id=this.reelEntry.id,this.title=this.reelEntry.title||"",this.description=this.reelEntry.description||"",this.icon="icon-toolbar-labels",this.typeId="MP_TOUR_SEARCH_GROUP",this.floorId="",this.dateBucket=(0,Y.f)(this.reelEntry.snapshot.created),this.openTransitionEditor=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new J.rU(this.index)),await this.commandBinder.issueCommand(new K.tT($.w1.HLR,!0)),this.commandBinder.issueCommand(new Z.Bz(q.P.HIGHLIGHT_EDITOR,!0)),this.commandBinder.issueCommand(new K.Fg(!1))},this.deleteTourStop=async()=>{await this.commandBinder.issueCommand(new J.vy),await this.commandBinder.issueCommand(new W(this.reelEntry.id))},this.onEditMenuAction=()=>{this.openTransitionEditor()},this.onDeleteMenuAction=()=>{this.deleteTourStop()},this.menuActions=this.isWorkshop?[{labelKey:ee.SEARCH_ITEM_EDIT,handler:this.onEditMenuAction,icon:"toggle-pencil"},{labelKey:ee.SEARCH_ITEM_DELETE,handler:this.onDeleteMenuAction,className:"menu-delete-btn",icon:"delete"}]:void 0,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new J.rU(this.index)),this.tourMode===N.zz.STORIES?await this.commandBinder.issueCommand(new G.iy(!0)):this.commandBinder.issueCommand(new G.Av(!0))},n===N.zz.STORIES){const e=!!t.title,i=!!t.snapshot.name;this.title=e&&i?t.snapshot.name+" - "+t.title:e||i?t.title?t.title:t.snapshot.name:this.getDefaultName()}else this.title=t.snapshot.name?t.snapshot.name:this.getDefaultName(),this.description="";this.getThumbnailImage()}async getThumbnailImage(){this.imgUrl=await this.reelEntry.snapshot.imageUrl.get()}getDefaultName(){return this.locale.t(ee.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(this.index+1)}}const{HLR:ie}=j.Z.WORKSHOP,se="MP_TOUR_SEARCH_GROUP";var ne=i(21359);class ae extends a.Y{constructor(){super(...arguments),this.name="tours-data",this.defaultModes=[o.Ey.Panorama,o.Ey.Outdoor],this.updateTourMode=()=>{this.viewData.currentTourMode=this.getCurrentTourMode(),this.viewData.setTourModeSetting(this.getTourModeSetting()),this.viewData.commit()},this.closeReelIfEmpty=()=>{0===this.tourData.getSnapshotCount()&&this.viewData.reelOpen&&this.toggleReel(!1)},this.saveTourModeChange=async e=>{const{tourMode:t}=e;t===N.zz.STORIES?this.tourData.setActiveReelTourMode(T.Z1.STORY):t===N.zz.LEGACY&&this.tourData.setActiveReelTourMode(T.Z1.REEL),this.updateTourMode()},this.onToggleReel=async e=>{this.toggleReel(e.open)},this.onForceShowStoryText=async e=>{this.engine.broadcast(new ne.Q)},this.onUpdateSnapshots=()=>{this.tourData.updateSnapshots(this.snapshotsData.collection)}}async init(e,t){const{readonly:i,baseUrl:a,storyToursFeature:o,baseModelId:c}=e;this.engine=t,this.config=e;const[u,p,g]=await Promise.all([t.market.waitForData(r.e),t.market.waitForData(h.Z),t.market.waitForData(l.P)]);this.settingsData=u,this.snapshotsData=g;const m=this.getFilterModes(this.defaultModes),w=o?T.Z1.STORY:T.Z1.REEL;if(this.tourData=new s.k(this.snapshotsData.collection,new y(w),m,p.getSweepList(),e.looping,this.log),this.viewData=new n.T(this.tourData,this.getTourModeSetting(),this.getCurrentTourMode()),!1===i){const[e,i]=await Promise.all([t.getModuleBySymbol(U.y.STORAGE),t.market.waitForData(k.Q)]),s=this.tourData.getReel();this.monitor=new L.u(s,{aggregationType:O.E.NextFrame},t),this.monitor.onChanged((()=>{this.monitor.hasDiffRecord()&&this.engine.commandBinder.issueCommand(new B.VQ({dataTypes:[F.g.HIGHLIGHTS]}))})),this.bindings.push(e.onSave((()=>this.save()),{dataType:F.g.HIGHLIGHTS})),i.setRevertableType(F.g.HIGHLIGHTS),i.setPublishableType(F.g.HIGHLIGHTS),this.bindings.push(t.commandBinder.addBinding(G.Te,this.saveTourModeChange),this.settingsData.onPropertyChanged(d.gx.TourButtons,this.updateTourMode),this.settingsData.onPropertyChanged(d.gx.HighlightReel,this.updateTourMode))}this.store=new A({readonly:i,baseUrl:a},w,c),this.bindings.push(this.store.onNewData((async e=>{this.tourData.atomic((()=>{var t;this.tourData.setHighlightReel(e||new y(w)),null===(t=this.monitor)||void 0===t||t.clearDiffRecord()})),this.updateTourMode(),this.closeReelIfEmpty()}))),await this.store.refresh(),this.bindings.push(t.commandBinder.addBinding(G.Av,this.onToggleReel),t.commandBinder.addBinding(G.iy,this.onForceShowStoryText),this.snapshotsData.onChanged(this.onUpdateSnapshots)),async function(e,t,i){const s=await e.market.waitForData(z.pu);let n=s.application===z.Mx.WORKSHOP;const a=await e.getModuleBySymbol(U.y.LOCALE),r=(s,r,o=[])=>{const h=[],l=t.getCurrentTourState().highlights,d=i.currentTourMode;if(o.length>0||d===N.zz.NONE)return h;const c=d===N.zz.STORIES;let u=0;return l.forEach((t=>{const i=t.title&&c?t.title:a.t(ie.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(u+1);if(s(i)||t.snapshot.name&&s(t.snapshot.name)||c&&t.description&&s(t.description)){const i=new te(e.commandBinder,t,u,n,d,a);h.push(i)}u++})),h},o=e=>new V.V(t.onChanged(e),i.onTourModeSettingChanged(e)),h=()=>{e.commandBinder.issueCommandWhenBound(new Q.c6({id:se,groupPhraseKey:ie.SEARCH_TOUR_HEADER,getSimpleMatches:r,registerChangeObserver:o,groupOrder:10,groupIcon:"toolbar-hlr"}))},l=()=>{e.commandBinder.issueCommandWhenBound(new Q.Pe(se))},d={renew:h,cancel:l},c=e=>{n=e===z.Mx.WORKSHOP,l(),h()},u=s.onPropertyChanged("application",c);c(s.application),new V.V(d,u)}(t,this.tourData,this.viewData),t.market.register(this,s.k,this.tourData),t.market.register(this,n.T,this.viewData)}dispose(e){this.store.dispose(),super.dispose(e)}getAllHighlightSweepIds(){return this.store.getAllHighlightSweepIds()}isSweepInAnyTour(e){return this.store.isTourSweep(e)}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Tour changes will NOT be saved");const e=this.tourData.getReel();await this.store.update(e),this.monitor.clearDiffRecord()}getCurrentTourMode(){return(0,_.aW)(this.settingsData,this.tourData.getActiveReelTourMode())}getTourModeSetting(){return(0,_.w7)(this.settingsData,this.tourData.getActiveReelTourMode())}toggleReel(e){this.viewData.reelOpen=e,this.viewData.commit()}getFilterModes(e){const t=this.settingsData.getOverrideParam("dh",1)>0,i=this.settingsData.tryGetProperty(d.gx.Dollhouse,!0);t&&i&&e.push(o.Ey.Dollhouse);const s=this.settingsData.getOverrideParam("fp",1)>0,n=this.settingsData.tryGetProperty(d.gx.FloorPlan,!0);return s&&n&&e.push(o.Ey.Floorplan),e}}},79232:(e,t,i)=>{"use strict";i.d(t,{F:()=>a});var s=i(75287),n=i(39880);class a extends s.T{constructor(e){super(),this.id=(0,n.O1)(11),e&&Object.assign(this,e)}}},33824:(e,t,i)=>{"use strict";i.d(t,{B:()=>n,p:()=>a});var s=i(19663);class n extends s.m{constructor(e){super(),this.id="REGISTER_DELETED_OBJECT_TYPE_COMMAND",this.payload=e}}class a extends s.m{constructor(e){super(),this.id="RESTORE_DELETED_OBJECT_COMMAND",this.payload={id:e}}}},76539:(e,t,i)=>{"use strict";i.r(t),i.d(t,{DeletedObject:()=>s.F,default:()=>I});var s=i(79232),n=i(97542),a=i(79728),r=i(45905),o=i(635),h=i(94753),l=i(3907),d=i(9133);function c(e){return{id:e.id,label:e.label,object_id:e.objectId,object_type:e.objectType,created:(0,d.U)(e.created),json_string:JSON.stringify(e.value)}}function u(e){const t={};for(const i of Object.values(e)){const e=c(i);e&&(t[i.id]=e)}return t}function p(e){const t=e.id,i=e.label,n=e.object_id,a=e.object_type,r=(0,d.p)(e.created);let o;try{o=JSON.parse(e.json_string)}catch(e){}if(!(t&&n&&a&&o))return null;return new s.F({id:t,label:i,objectId:n,objectType:a,created:r,value:o})}function g(e){const t={};for(const i in e){const s=p(e[i]);s&&(t[i]=s)}return t}class m extends l.MU{constructor(e,t,i){super({queue:t,path:`${i}/api/v1/jsonstore/model/trash/${e}`,batchUpdate:!0,deserialize:g,serialize:u})}}var y=i(67992),w=i(15637),f=i(39880);const v=new(i(97998).Z)("TrashData");class b extends y.V{constructor(e){super(),this.trash=new w.v,this.registry=new Map,e&&this.add(...Object.values(e))}get(e){return this.trash.get(e)}add(...e){this.atomic((()=>{this.trash.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.trash.has(t.id);)t.id=(0,f.O1)(11),t.commit()})),this.trash.set(t.id,t)})),this.commit()}))}create(e,t){const i=this.registry.get(e);if(!i)return void v.debug(`Unsupported type added to trash: ${e}`);const s=i.create(t);return this.add(s),s}restore(e){const t=this.trash.get(e),i=this.registry.get(t.objectType);if(!i)throw new Error(`Can't restore unsupported type ${t.objectType}`);return i.restore(t)}register(e){v.debug(`Registered type ${e.objectType}`);const{objectType:t}=e;this.registry.has(t)?v.debug(`Type ${t} already registered`):this.registry.set(t,e)}unregister(e){return v.debug(`Unregistered type ${e}`),this.registry.delete(e)}isSupported(e){return this.registry.has(e)}}var T=i(33824),S=i(35895),D=i(57956);class P extends n.Y{constructor(){super(...arguments),this.name="trash"}async init(e,t){const{baseModelId:i,queue:s,baseUrl:n}=e,{market:a,commandBinder:o}=t;this.engine=t,this.store=new m(i,s,n),this.data=new b,a.register(this,b,this.data),this.engine.getModuleBySymbol(D.y.STORAGE).then((e=>{this.bindings.push(e.onPublish((async()=>this.backup()),{phase:r.Q.BEFORE}))})),this.bindings.push(o.addBinding(T.B,(async e=>this.registerDeletedObject(e))),o.addBinding(T.p,(async({id:e})=>this.restore(e))))}dispose(e){super.dispose(e),e.market.unregister(this,b)}async registerDeletedObject(e){const{objectType:t}=e;return(0,S.k1)((()=>this.data.register(e)),(()=>this.data.unregister(t)),!0)}async backup(){const{commandBinder:e}=this.engine,t=await e.issueCommand(new o.ff).catch((e=>{throw new h.AE(e)})),i={};for(const e in t)this.data.isSupported(e)&&t[e].forEach((t=>{const s=this.data.create(e,t);s&&(i[s.id]=s)}));if(Object.keys(i).length)return this.store.update(i)}async restore(...e){const t=new Set;for(const i of e){const e=this.data.get(i);this.log.debug(`Restoring ${e.objectType} ${e.id}`),Object.values(a.g).includes(null==e?void 0:e.objectType)&&t.add(e.objectType),this.data.restore(i)}if(t.size>0)return this.engine.commandBinder.issueCommand(new o.VQ({dataTypes:[...t]}))}}const I=P},10805:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var s=i(57956),n=i(97542),a=i(96767),r=i(96154),o=i(31362),h=i(50575);class l{constructor(){this._dateNow=Date.now,this._performanceNow=performance.now,this.nowOverride=0}slowTime(e){this.fps=e,this.nowOverride=Date.now(),Date.now=()=>this.nowOverride,performance.now=()=>this.nowOverride}tick(){this.nowOverride+=1e3/this.fps}resetTime(){Date.now=this._dateNow,performance.now=this._performanceNow}}var d,c=i(38319),u=i(26256);!function(e){e[e.STOPPED=0]="STOPPED",e[e.RECORDING=1]="RECORDING"}(d||(d={}));class p extends n.Y{constructor(){super(...arguments),this.name="video-recorder-module",this.state=d.STOPPED,this.frostMage=new l}async init(e,t){this.settingsModule=await t.getModuleBySymbol(s.y.SETTINGS),this.canvasModule=await t.getModuleBySymbol(s.y.CANVAS),this.engine=t,this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 1080p @ 60",(()=>{this.state===d.STOPPED&&this.record(1920,1080,60)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 720p @ 30",(()=>{this.state===d.STOPPED&&this.record(1280,720,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram",(()=>{this.state===d.STOPPED&&this.record(1080,1080,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram story",(()=>{this.state===d.STOPPED&&this.record(1080,1920,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Stop & download current",(()=>{this.state===d.RECORDING&&this.stop()}))}async record(e,t,s){if(this.state!==d.STOPPED)return void this.log.warn("Can't start recording... we're already recording!");this.log.info("Starting recording of tour. Now is a good time to get a coffee :)"),this.state=d.RECORDING;const n=await Promise.all([i.e(764),i.e(330),i.e(718)]).then(i.bind(i,15730));this.encoder=new n.WebMWriter({quality:.95,frameRate:s}),this.frostMage.slowTime(s),await this.engine.commandBinder.issueCommand(new h.M({resizeDimensions:[{property:h.P.width,setDimension:e,duration:0},{property:h.P.height,setDimension:t,duration:0}]})),await this.engine.commandBinder.issueCommand(new a.TH);const o=this.engine.subscribe(r.NR,(()=>{o.cancel(),this.state===d.RECORDING&&this.stop()})),l=this,c=this.canvasModule.element;this.engine.startGenerator((function*(){for(;l.state===d.RECORDING;)l.encoder.addFrame(c),yield new u.Jj,l.frostMage.tick(),yield new u.Jj}))}async stop(){if(this.state!==d.RECORDING)return void this.log.warn("Can't stop recording, we weren't recording at all");this.frostMage.resetTime(),this.state=d.STOPPED,await this.engine.commandBinder.issueCommand(new h.M((0,c.lb)(0))),this.log.info("Encoding tour to video...");const e=await this.encoder.complete();this.log.info("Tour encoded! Prompting user to download."),(0,o.Hx)(e,"tour.webm")}}},74681:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>de});var s=i(97542),n=i(57956),a=i(89570),r=i(69505),o=i(2569),h=i(84428),l=i(90304),d=i(25985),c=i(85992),u=i(34029),p=i(59370);const g=new h.Vector3(0,-100,0),m=new h.Vector2(-2,-2),y=new h.Vector3(-1,-1,-1),w=new h.Vector3(1,1,1);class f{constructor(e){this.raycaster=e,this.lastHits=[],this.lastRay=new h.Ray(g,new h.Vector3(0,-1,0)),this.currentRay=new h.Ray,this.origin=g,this.direction=new h.Vector3,this.pointerNdc=m,this.cameraCache={position:new h.Vector3,quaternion:new h.Quaternion,camera:void 0},this.cast=e=>{const t=this.currentRay;return!e&&this.lastRay.equals(t)||(this.lastHits=this.raycaster.cast(t.origin,t.direction,e).slice(),this.lastRay.copy(t)),this.lastHits},this.update3D=(e,t,i)=>{e instanceof h.Vector3&&this.origin.copy(e),t instanceof h.Vector3&&this.direction.copy(t),this.cameraCache.camera=i,this.currentRay.set(this.origin,this.direction)},this.updateNDCPosition=()=>{const e=this.lastHits[0];if(this.cameraCache.camera&&e&&e.point){const t=this.cameraCache.camera;this.cameraCache.position.setFromMatrixPosition(t.matrixWorld),this.cameraCache.quaternion.setFromRotationMatrix(t.matrixWorld);const i=(0,p.D_)(e.point,this.cameraCache.position,this.cameraCache.quaternion,t.projectionMatrix);i.clamp(y,w),this.pointerNdc.set(i.x,i.y)}},this.updatePointer=()=>{}}get pointerRay(){return this.currentRay}get ndcPosition(){return this.updateNDCPosition(),this.pointerNdc}}var v=i(98010);class b extends v.v{}class T extends b{constructor(e){super(),this.trackedCamera=e}}class S extends b{}class D extends b{}var P,I=i(81456),x=i(13693),M=i(17878);!function(e){e[e.Mono=0]="Mono",e[e.Stereo=1]="Stereo",e[e.SixDof=2]="SixDof",e[e.__length=3]="__length"}(P||(P={}));const E={controllers:Object.freeze([0,1]),rotationDegrees:25};var C;!function(e){e[e.touchpadX=0]="touchpadX",e[e.touchpadY=1]="touchpadY",e[e.thumbstickX=2]="thumbstickX",e[e.thumbstickY=3]="thumbstickY"}(C||(C={}));const R={x:0,y:0,z:0,w:1};class A extends x.Y{constructor(e,t,i,s,n){super(),this.engine=e,this.renderer=t,this.webglScene=i,this.cameraData=s,this.cameraModule=n,this.trackingStyle=P.Mono,this.session=null,this.rotations={initialYawOffset:new h.Quaternion,yawOffset:new h.Quaternion,invYawOffset:new h.Quaternion,trackingOffset:new h.Quaternion},this.setTrackingStyle=e=>{e<P.__length&&(this.trackingStyle=e,this.resetInitialRotation())},this.offsetRotation=e=>{this.rotations.invYawOffset.multiply(e),this.rotations.yawOffset.copy(this.rotations.invYawOffset).invert()},this.onPresentStart=e=>{e.cameras[0].layers.mask=M.o.ALL.mask,e.cameras[1].layers.mask=M.o.ALL.mask,e.cameras[0].far=e.far,e.cameras[1].far=e.far,e.layers.mask=M.o.ALL.mask,this.resetInitialRotation(),this.broadcast(new S)},this.resetInitialRotation=()=>{const e=this.cameraData.pose.rotation.clone();(0,o.Rq)(e,this.rotations.initialYawOffset),this.rotations.yawOffset.copy(this.rotations.initialYawOffset),this.rotations.invYawOffset.copy(this.rotations.initialYawOffset).invert()},this.onPresentEnd=()=>{this.broadcast(new D)},this.applyTrackingOverrides=(e,t,i)=>{if(e.xr.isPresenting&&i instanceof h.ArrayCamera){e.clear();const t=i.cameras[0],s=i.cameras[1];if(this.frame=this.engine.getXrFrame(),this.session||(this.session=e.xr.getSession(),this.onPresentStart(i)),this.frame&&this.session){this.rotations.trackingOffset.copy(this.rotations.yawOffset).multiply(i.quaternion),this.cameraModule.updateCameraRotation(this.rotations.trackingOffset);const e=this.webglScene.camera.parent;if(e){const t=this.getReferenceSpace(this.frame,e);this.updateCameras(i,this.frame,t,e),this.updateControllers(this.session,this.frame,t,e)}switch(this.trackingStyle){case P.Mono:s.matrixWorld.copy(t.matrixWorld),s.matrixWorldInverse.copy(s.matrixWorld),s.matrixWorldInverse.invert()}this.broadcast(new T(t))}}else this.session&&(this.session=null,this.onPresentEnd())},this.getReferenceSpace=(e,t)=>{const i=this.renderer.xr.getReferenceSpace(),s=e.getViewerPose(i).views[0].transform.position,n=this.trackingStyle===P.SixDof?R:s,a=new XRRigidTransform({x:n.x-t.position.x,y:n.y-t.position.y,z:n.z-t.position.z}),r=i.getOffsetReferenceSpace(a),o=this.rotations.invYawOffset,h=this.cameraData.pose.position,l=new XRRigidTransform({x:h.x,y:h.y,z:h.z,w:1},{x:o.x,y:o.y,z:o.z,w:o.w});return r.getOffsetReferenceSpace(l)},this.updateCameras=(e,t,i,s)=>{const n=t.getViewerPose(i);if(n){const t=n.views;for(let i=0;i<t.length;i++){const n=t[i],a=e.cameras[i];a.matrix.fromArray(n.transform.matrix),a.projectionMatrix.fromArray(n.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix),a.projectionMatrixInverse.invert(),a.matrixWorld.multiplyMatrices(s.matrixWorld,a.matrix),a.matrixWorldInverse.copy(a.matrixWorld),a.matrixWorldInverse.invert(),a.matrix.decompose(a.position,a.quaternion,a.scale),0===i&&(e.matrix.copy(a.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorld.copy(a.matrixWorld),e.matrixWorldInverse.copy(a.matrixWorldInverse),e.projectionMatrix.copy(a.projectionMatrix),e.projectionMatrixInverse.copy(a.projectionMatrixInverse))}}},this.updateControllers=(e,t,i,s)=>{for(let n=0;n<2;n++){const a=this.renderer.xr.getController(n),r=this.renderer.xr.getControllerGrip(n),o=e.inputSources[n];let h=null,l=null;o&&(a&&(h=t.getPose(o.targetRaySpace,i),h&&(a.matrix.fromArray(h.transform.matrix),a.matrixWorld.multiplyMatrices(s.matrixWorld,a.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale)),a.visible=!!h),r&&o.gripSpace&&(l=t.getPose(o.gripSpace,i),l&&(r.matrix.fromArray(l.transform.matrix),r.matrixWorld.multiplyMatrices(s.matrixWorld,r.matrix),r.children.forEach((e=>{e.updateMatrixWorld()})),r.matrix.decompose(r.position,r.quaternion,r.scale)))),r&&(r.visible=!!l)}},this.webglScene.scene.onBeforeRender=this.applyTrackingOverrides}}var L=i(37082),O=i(87928),F=i(92766),k=i(48786),B=i(20043),N=i(35826),G=i(8948),_=i(53954),U=i(5135),z=i(23254),V=i(13310),j=i(87926),Q=i(33757);class H{constructor(e){this.meshQuery=e,this.active=!1,this.target=new L.f(null),this.previousSweep=null,this.activate=()=>{this.active||(this.updateLoopSub.renew(),this.selectionChangeSub.renew(),this.ray.toggle(!0),this.targetDecoration.toggle(!0),this.active=!0)},this.deactivate=()=>{this.active&&(this.target.value=null,this.selectionChangeSub.cancel(),this.updateLoopSub.cancel(),this.ray.toggle(!1),this.targetDecoration.toggle(!1),this.active=!1)},this.getTargetSweep=(e,t,i)=>{let s=null;if(t.object instanceof G.YY)return s=e.getSweep(t.object.userData.sid),s;const n=(0,B.bG)(e,!0,t.intersection,this.meshQuery);return s=n.length>0?n[0].sweep:null,s}}get container(){return this._container}async init(e){this.engine=e,this._container=new h.Group,this._container.name="XRNavigationVisuals",this.ray=new W(this.container),this.targetDecoration=new Y(this.container);const t=await this.engine.market.waitForData(c.P);return this.updateLoopSub=t.onChanged((()=>this.update(t))),this.updateLoopSub.cancel(),this.selectionChangeSub=this.target.onChanged((e=>{null!==this.previousSweep&&this.engine.commandBinder.issueCommand(new N.kR(this.previousSweep.id,!1,200)),null!==e&&(this.engine.commandBinder.issueCommand(new N.kR(e.id,!0,200)),this.targetDecoration.updateTargetPosition(e.floorPosition)),this.previousSweep=e})),this.selectionChangeSub.cancel(),this}update(e){const t=this.engine.market.tryGetData(_.Z),i=this.engine.market.tryGetData(d.M),s=this.engine.market.tryGetData(z.O),n=this.engine.market.tryGetData(V.Y),a=this.engine.market.tryGetData(U.Z);if(!(t&&i&&s&&a&&n))return;if(!a.isVR())return;if(!s.isInside())return;const{hit:r,pointerDirection:o,pointerOrigin:h}=e;if(!r)return;const l=this.getTargetSweep(t,r,o);this.target.value=l,this.ray.update(h,r.point,n.opacity.value),this.targetDecoration.update(i.pose.rotation,n.opacity.value)}}class W{constructor(e){this.container=e,this.styles={ray:{color:"white",transparent:!0,opacity:.3,linewidth:2,depthWrite:!1},hit:{color:"white",transparent:!0,opacity:.3},hitScale:.02},this.update=(e,t,i)=>{this.ray.updatePositions(e,t).opacity(Math.min(i,this.styles.ray.opacity)),this.hitMarker.position.copy(t),this.hitMarker.material.opacity=Math.min(i,this.styles.hit.opacity)},this.toggle=e=>{e?(this.container.add(...this.ray.children),this.container.add(this.hitMarker)):(this.container.remove(...this.ray.children),this.container.remove(this.hitMarker))};const{ray:t,hit:i}=this.styles,s=(0,F.makeLineMaterial)(t.color,!1,t);this.ray=new k.c(new h.Vector3,new h.Vector3,s,{}),this.ray.updateResolution(window.innerWidth,window.innerHeight),this.hitMarker=new O.E(new h.SphereGeometry(this.styles.hitScale),new h.MeshBasicMaterial(i)),this.hitMarker.name="hit"}}class Y{constructor(e){this.container=e,this.styles={scale:.46,animationSpeed:1,plane:{color:"white",transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,map:(0,j.p)(Q)}},this.position=new h.Vector3,this.quaternion=new h.Quaternion,this.updateTargetPosition=e=>{this.position.copy((0,o.Xv)(e,l.f.UP,.05))},this.update=(e,t)=>{const i=(0,o.Rq)(e,this.quaternion);this.target.quaternion.copy(i),this.target.position.lerp(this.position,this.styles.animationSpeed),this.target.material.opacity=Math.min(t,this.styles.plane.opacity)},this.toggle=e=>{e?this.container.add(this.target):this.container.remove(this.target)};const t=new h.PlaneGeometry(1),i=new h.Matrix4;i.makeRotationFromEuler(new h.Euler(-Math.PI/2,0,0,"XYZ")),t.applyMatrix4(i),this.target=new O.E(t,new h.MeshBasicMaterial(this.styles.plane)),this.target.name="Destination",this.target.scale.set(this.styles.scale,this.styles.scale,this.styles.scale)}}class Z{constructor(e){this.controllers=e,this._lastInputWas=0}focus(e){e!==this._lastInputWas&&(E.controllers.forEach((t=>{this.controllers.controller(t).grip.visible=t!==e})),this._lastInputWas=e)}}var q=i(35895);class X{constructor(e){this.renderer=e,this._defaultController=0,this.controllerGroups=[],this.bindings=[],this.cancel=()=>{this.bindings.forEach((e=>e.cancel())),this.bindings.length=0},this.container=new h.Group,this.container.name="XRControllerMesh",E.controllers.forEach((e=>{const t=this.createControllerGroup(e);this.controllerGroups.push(t),this.container.add(t.grip,t.pointer)})),this.connectControllerModel(),this.container.matrixAutoUpdate=!1}controller(e=this._defaultController){return this.controllerGroups[e]}setDefault(e){this._defaultController=e}async connectControllerModel(){const e=new((await Promise.all([i.e(47),i.e(376)]).then(i.bind(i,43356))).XRControllerModelFactory);E.controllers.forEach((t=>{const i=this.controller(t).grip;i.add(e.createControllerModel(i))}))}createControllerGroup(e){const t=this.renderer.xr.getController(e);t.name=`Controller Ray ${e}`;const i=this.renderer.xr.getControllerGrip(e);i.name=`Controller Grip ${e}`,i.visible=!1;const s={index:e,pointer:t,grip:i,connected:!1,hand:"none"},n=e=>{s.hand=e.data.handedness,s.connected=!0},a=()=>{s.hand="none",s.connected=!1};return this.bindings.push((0,q.k1)((()=>t.addEventListener("connected",n)),(()=>t.removeEventListener("connected",n))),(0,q.k1)((()=>t.addEventListener("disconnected",a)),(()=>t.removeEventListener("disconnected",a)))),s}}const K=new(i(97998).Z)("xr-input-forwarding");class ${constructor(e){this.options=e,this.dispatchPointerDown=e=>{this.forwardEvent("pointerdown",this.mockPointerEventInit(e))},this.dispatchPointerUp=e=>{this.forwardEvent("pointerup",this.mockPointerEventInit(e))},this.target=e.forwardToElement}dispatchPointerMove(e){this.forwardEvent("pointermove",this.mockPointerEventInit(e))}mockPointerEventInit(e){let t=0,i=0;if(this.options.getPointerScreenPosition){const e=this.options.getPointerScreenPosition();t=e.x,i=e.y}return{pointerType:"gamepad",pointerId:e,clientX:t,clientY:i}}forwardEvent(e,t){let i;try{i=window.PointerEvent?new PointerEvent(e,t):new MouseEvent(e,t),i&&this.target.dispatchEvent(i)}catch(e){K.error(e)}}}class J extends h.EventDispatcher{constructor(e,t){super(),this.renderer=e,this.options={forwardNativeXrEvents:!0,dispatchToControllerGroup:!1,axisMoveTriggerThreshold:.5},this.previousGamepad=new Map,this.forwardedEvents=["selectstart","select","selectend","squeeze","squeezestart","squeezeend"],this.active=!1,this.renew=()=>{!this.active&&this.options.forwardNativeXrEvents&&(this.addSessionListeners(),this.active=!0)},this.cancel=()=>{this.active&&this.options.forwardNativeXrEvents&&(this.removeSessionListeners(),this.active=!1)},this.updateFromGamepads=()=>{if(!this.active)return;const e=this.renderer.xr.getSession();if(e)for(const t of E.controllers){const i=e.inputSources[t];if(!i||!i.gamepad)continue;const s=this.renderer.xr.getController(t),n=this.previousGamepad.get(i),a={buttons:i.gamepad.buttons.map((e=>e.value)),axes:new Float32Array(i.gamepad.axes.slice())},r={controllerIndex:t,inputSource:i,axes:a.axes};n&&(a.buttons.forEach(((e,t)=>{e!==n.buttons[t]&&(1===e?this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"buttondown",value:e,index:t,target:s})):0===e&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"buttonup",value:e,index:t,target:s})))})),a.axes.forEach(((e,t)=>{const i=n.axes[t];if(e!==i){this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmove",value:e,index:t,target:s})),0===i&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmovestart",value:e,index:t,target:s}));const n=this.options.axisMoveTriggerThreshold;Math.abs(i)<n&&Math.abs(e)>n&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axestriggered",value:e,index:t,target:s})),0===e&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmoveend",value:e,index:t,target:s}))}}))),this.previousGamepad.set(i,a)}},this.onGamepadEvent=(e,t)=>(0,q.k1)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.onSessionEvent=(e,t)=>(0,q.k1)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.sendGamepadEvent=(e,t)=>{this.dispatchEvent(t),this.options.dispatchToControllerGroup&&e.dispatchEvent(t)},this.sendSessionEvent=(e,t)=>{this.dispatchEvent({type:e,controllerIndex:t})},this.addSessionListeners=()=>{E.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of this.forwardedEvents)t.addEventListener(i,(t=>this.sendSessionEvent(t.type,e)))}))},this.removeSessionListeners=()=>{E.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of this.forwardedEvents)t.removeEventListener(i,(t=>this.sendSessionEvent(t.type,e)))}))},t&&(this.options=Object.assign(Object.assign({},this.options),t)),this.renew()}}var ee=i(11642),te=i(44578),ie=i(10777),se=i(76609),ne=i(71239),ae=i(31362);var re=i(41326);const oe=(new h.Quaternion).setFromAxisAngle(l.f.UP,r.Ue*E.rotationDegrees),he=(new h.Quaternion).setFromAxisAngle(l.f.UP,r.Ue*-E.rotationDegrees);class le extends s.Y{constructor(){super(...arguments),this.name="webxr",this.framebufferScaledTo=1,this.framebufferScale=0,this.ray={forward:new h.Vector3,origin:new h.Vector3},this.onXrPresentBegin=()=>{const e=this.renderer.xr.getSession();e&&(this.log.info(`Session framebuffer: ${e.renderState.baseLayer}`),this.engine.commandBinder.issueCommand(new ie.D(!0)),this.engine.commandBinder.issueCommand(new ie.F(se.AB.HIGH)),this.viewmodeData.isInside()||this.engine.commandBinder.issueCommand(new re._i(re.BD.INSIDE)),this.xrPointer=new f(this.raycaster.picking),this.raycaster.setOverridePointer(this.xrPointer),this.xrNavVisuals.activate())},this.onXrPresentEnd=()=>{const e=null!==this.settings.tryGetProperty(ne.YS,null);this.engine.commandBinder.issueCommand(new ie.D(e)),this.engine.commandBinder.issueCommand(new ie.F(this.config.navPanoSize)),this.xrNavVisuals.deactivate(),this.raycaster.setOverridePointer(null),this.cameraModule.updateCameraRotation((0,o.Rq)(this.cameraData.pose.rotation,new h.Quaternion)),this.webglScene.setCameraDirty()},this.onXrTrackingApplied=e=>{const t=this.controllerMesh.controller();if(t.connected){const i=this.ray.forward.copy(l.f.FORWARD).applyQuaternion(t.pointer.quaternion),s=this.ray.origin.setFromMatrixPosition(t.pointer.matrixWorld);this.xrPointer.update3D(s,i,e.trackedCamera),this.xrPointerInput.dispatchPointerMove(t.index)}this.xrGamepadInput.updateFromGamepads()},this.requestSession=async(e,t)=>{var i;if(await(0,ee.pl)(this.config.xrBrowsersUnlocked)!==ee.bk.webxr)return null;if(this.renderer.xr.isPresenting)return this.renderer.xr.getSession();if(te.Z.apiExists()){const s=await(null===(i=navigator.xr)||void 0===i?void 0:i.requestSession(e,{optionalFeatures:t}));if(!s)return null;const n=XRWebGLLayer.getNativeFramebufferScaleFactor(s);return this.framebufferScaledTo=this.framebufferScale*(n-1)+1,this.log.info("Scaling framebuffer by:",this.framebufferScaledTo,"native size:",n," * factor:",this.framebufferScale),0!==this.framebufferScale&&this.renderer.xr.setFramebufferScaleFactor(this.framebufferScaledTo),this.renderer.xr.setSession(s),s}return null}}async init(e,t){this.config=e,this.engine=t;const[i,s]=await Promise.all([t.getModuleBySymbol(n.y.WEBGL_RENDERER),t.getModuleBySymbol(n.y.MESH_QUERY)]);this.renderer=i.threeRenderer,this.webglScene=i.getScene(),this.settings=await t.market.waitForData(u.e),this.bindings.push(t.commandBinder.addBinding(I.j,(e=>this.requestSession(e.type,e.features))));if(await(0,ee.pl)(e.xrBrowsersUnlocked)!==ee.bk.webxr)return;[this.canvasModule,this.cameraModule,this.raycaster]=await Promise.all([t.getModuleBySymbol(n.y.CANVAS),t.getModuleBySymbol(n.y.CAMERA),t.getModuleBySymbol(n.y.RAYCASTER)]),[this.cameraData,this.raycasterData,this.viewmodeData]=await Promise.all([t.market.waitForData(d.M),t.market.waitForData(c.P),t.market.waitForData(z.O)]),this.renderer.xr.setReferenceSpaceType("local"),this.framebufferScale=this.config.framebufferScaling||function(e){const t=(0,ae.tq)();return!t||t&&function(e){return/Adreno \(TM\) (540|[6-9]\d\d)/.test(e.renderer)}(e)?1:0}(i.gpuInfo);const r=new A(t,this.renderer,this.webglScene,this.cameraData,this.cameraModule);r.setTrackingStyle(e.tracking),this.bindings.push(r.subscribe(S,this.onXrPresentBegin),r.subscribe(D,this.onXrPresentEnd),r.subscribe(T,this.onXrTrackingApplied)),this.controllerMesh=new X(this.renderer),this.webglScene.add(this.controllerMesh.container);const o=new Z(this.controllerMesh),h=e.enableEventPositions?()=>this.raycasterData.pointerScreenPosition:void 0;this.xrPointerInput=new $({forwardToElement:this.canvasModule.element,getPointerScreenPosition:h}),this.xrGamepadInput=new J(this.renderer);const l=new a.V(this.xrGamepadInput.onGamepadEvent("axestriggered",(e=>{if(e.index===C.thumbstickX||e.index===C.touchpadX){this.log.debug(`${e.inputSource.handedness} ${C[e.index]} axis.value over threshold, do the rotate!`);Math.sign(e.value)>0?r.offsetRotation(oe):r.offsetRotation(he)}o.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectstart",(e=>{this.xrPointerInput.dispatchPointerDown(e.controllerIndex),o.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectend",(e=>{this.xrPointerInput.dispatchPointerUp(e.controllerIndex),o.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("squeezestart",(e=>{o.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})));this.bindings.push(l,this.xrGamepadInput),this.xrNavVisuals=new H(s),this.xrNavVisuals.init(t),this.webglScene.add(this.xrNavVisuals.container)}}const de=le},70903:(e,t,i)=>{"use strict";i.d(t,{L:()=>s});class s{constructor(e){this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e){const t=this.createObjectDescriptor(e);return t.object=e,t.inUse=!0,this.addObjectDescriptorToPool(t),t}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}free(e){for(const t of this.poolArray)if(t.object===e)return t.inUse=!1,!0;return!1}all(){return this.poolArray}remove(e){const t=this.poolArray.findIndex((t=>t.object===e));return-1!==t&&(this.poolArray.splice(t,1),!0)}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},87928:(e,t,i)=>{"use strict";i.d(t,{E:()=>n});var s=i(84428);class n extends s.Mesh{constructor(e,t){super(e,t)}}},68512:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetScans"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"scans"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ScanDetails"},directives:[]}]}}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ScanDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Scan"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"index"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"alignment"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"options"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"timeOfDay"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"anchor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"camera"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vendor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"captureMode"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depthCameraType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"cameraTypes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"sensorSerialNumbers"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"serialNumber"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mountCalibrationVersion"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"softwareVersion"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:452}};t.loc.source={body:"query GetScans($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    assets {\n      scans {\n        ...ScanDetails\n      }\n    }\n  }\n}\n\nfragment ScanDetails on Scan {\n  id\n  index\n  name\n  created\n  alignment\n  options\n  url\n  timeOfDay\n  anchor {\n    id\n  }\n  camera {\n    id\n    name\n    vendor\n    model\n    captureMode\n    depthCameraType\n    cameraTypes\n    sensorSerialNumbers\n    serialNumber\n    mountCalibrationVersion\n    softwareVersion\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function n(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function a(e,t){var i={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=s[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var h=o;o=new Set,h.forEach((function(e){r.has(e)||(r.add(e),(s[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var s=n(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetScans=a(t,"GetScans"),e.exports.ScanDetails=a(t,"ScanDetails")}}]);